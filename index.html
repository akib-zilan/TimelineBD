<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCS History Timeline (1947-1951)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- UPDATED: Swapped to Noto Sans and Noto Sans Bengali for better font harmony -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        
        /* NEW: CSS Variables for UI Control */
        :root {
            /* Global */
            font-size: var(--global-scale, 100%); /* Controlled by JS */
            --main-gap: var(--layout-gap, 3rem); /* Controlled by JS - New Default */
            --global-line-height: var(--line-height, 1.6); /* NEW: Controlled by JS */
            
            /* Timeline */
            --timeline-v-spacing: var(--month-spacing, 2rem); /* Controlled by JS */
            --timeline-h-padding: 3rem; /* Stays proportional to global scale */
            --timeline-year-fs: var(--year-header-fs, 2.25rem); /* Controlled by JS */
            --timeline-card-fs: var(--month-card-fs, 1rem); /* Controlled by JS */
            --card-padding-y: var(--month-card-pady, 1.5rem); /* NEW */
            --card-padding-x: var(--month-card-padx, 1.5rem); /* NEW */
            
            /* Sidebar */
            /* NEW: 200% Larger Sidebar Fonts */
            --sidebar-title-fs: var(--side-title-fs, 3.75rem); /* 200% of 1.875rem */
            --sidebar-body-fs: var(--side-body-fs, 2rem); /* 200% of 1rem */
            --sidebar-padding-y: var(--side-pady, 1.5rem); /* NEW */
            --sidebar-padding-x: var(--side-padx, 1.5rem); /* NEW */
            /* DELETED Sidebar Margin Vars */
            
            /* Modals */
            --modal-title-fs: var(--pop-title-fs, 1.875rem); /* Controlled by JS */
            --modal-body-fs: var(--pop-body-fs, 1rem); /* Controlled by JS */
            --modal-padding-y: var(--pop-pady, 2rem); /* NEW */
            --modal-padding-x: var(--pop-padx, 2rem); /* NEW */
        }
        
        body {
            /* UPDATED: Font family changed */
            font-family: 'Noto Sans', 'Noto Sans Bengali', sans-serif;
            background-color: #f4f7f6; /* A very light, calming green-gray */
            line-height: var(--global-line-height);
        }
        
        /* New Login Overlay */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        #login-overlay h1 { font-size: 2.25rem; /* text-4xl */ }
        #login-overlay p { font-size: 1.25rem; /* text-xl */ }
        #login-overlay button { font-size: 1.125rem; /* text-lg */ padding: 1rem 2rem; }

        /* Hide main content by default */
        .main-app-content {
            display: none;
        }

        /* The main timeline vertical line */
        .timeline-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 6px; 
            height: 100%;
            background-color: #cbd5e1; /* slate-300 */
            z-index: 2; 
        }

        /* Styling for each year block */
        .year-block {
            /* NEW: Sticky Year Header */
            position: sticky;
            top: 180px; /* Default, will be overridden by JS */
            z-index: 45; /* Below header (50) but above sidebar (40) */
            padding: 2.5rem 0; 
            /* This div is now sticky */
        }
        .year-block span {
             font-size: var(--timeline-year-fs);
             /* REMOVED sticky from here */
        }
        
        /* DELETED: year-observer-anchor (no longer needed) */

        /* Styling for each month's "dot" on the timeline */
        .timeline-dot {
            position: absolute;
            top: 1.125rem; /* Adjusted for larger text */
            left: 50%;
            transform: translateX(-50%);
            width: 24px; 
            height: 24px; 
            background-color: white;
            border: 5px solid #059669; 
            border-radius: 50%;
            z-index: 5; 
            transition: all 0.3s ease;
        }
        
        .month-item:hover .timeline-dot {
            transform: translateX(-50%) scale(1.1);
            border-color: #047857; /* emerald-700 */
        }

        /* Positioning month items on the left and right */
        .month-item {
            position: relative;
            width: 50%;
            padding: 0 var(--timeline-h-padding);
            margin-bottom: var(--timeline-v-spacing);
        }
        
        .month-card {
            padding: var(--card-padding-y) var(--card-padding-x); /* NEW: Controlled by JS */
        }

        /* Even items on the right */
        .month-item:nth-child(even) {
            align-self: flex-end;
            padding-left: var(--timeline-h-padding);
        }
        
        /* Odd items on the left */
        .month-item:nth-child(odd) {
            align-self: flex-start;
            padding-right: var(--timeline-h-padding);
            text-align: right;
        }
        
        /* Month Card font size */
        .month-card, .month-card h3, .month-card p, .month-card li, .month-card button {
            font-size: var(--timeline-card-fs);
        }
        .month-card h3 { font-size: calc(var(--timeline-card-fs) * 1.25); font-weight: 600; } /* Make title slightly bigger */


        /* Adjust button alignment for left/right items */
        .month-item:nth-child(odd) .month-buttons {
            justify-content: flex-end;
        }
        
        .month-item:nth-child(even) .month-buttons {
            justify-content: flex-start;
        }

        /* The small horizontal line connecting dot to card */
        .month-item::after {
            content: '';
            position: absolute;
            top: 1.375rem; /* Adjusted for dot */
            width: var(--timeline-h-padding);
            height: 3px; 
            background: #cbd5e1; /* slate-300 */
            z-index: 2; 
        }

        .month-item:nth-child(even)::after {
            left: 0;
            transform: translateX(-100%);
        }

        .month-item:nth-child(odd)::after {
            right: 0;
            transform: translateX(100%);
        }

        /* Modal backdrop */
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        
        /* Modal font sizes */
        dialog h2 { font-size: var(--modal-title-fs); }
        dialog h3 { font-size: calc(var(--modal-body-fs) * 1.25); }
        dialog h4 { font-size: calc(var(--modal-body-fs) * 1.15); }
        dialog p, dialog label, dialog button, dialog input, dialog select, dialog textarea, dialog span {
            font-size: var(--modal-body-fs);
        }
        
        /* NEW: Modal Padding Control */
        #infoModal form { padding: var(--modal-padding-y) var(--modal-padding-x); }
        #contextModal > div { padding: var(--modal-padding-y) var(--modal-padding-x); }
        #figureModal form { padding: var(--modal-padding-y) var(--modal-padding-x); }
        #uiModal > div { padding: var(--modal-padding-y) var(--modal-padding-x); }
        #analysisModal > div { padding: var(--modal-padding-y) var(--modal-padding-x); }

        /* Styles for compact view */
        .compact-view .month-item {
            display: none;
        }
        
        /* This rule shows items that have data AND are not filtered out */
        .compact-view .month-item.has-data:not(.filtered-out) {
            display: flex; 
        }
        
        .compact-view .year-block.is-empty {
            display: none;
        }
        
        /* Styles for tag filtering */
        .month-item.filtered-out {
            display: none !important; /* Hide month item if all notes are filtered */
        }
        
        .month-note-item.filtered-out {
            display: none; /* Hide individual note item */
        }
        

        /* Style for the duration span bars */
        .duration-span {
            position: absolute;
            left: calc(50% - 3px); /* Adjusted */
            transform: translateX(-100%); 
            width: 8px; 
            z-index: 3; 
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        /* I-beam caps */
        .duration-span::before,
        .duration-span::after {
            content: '';
            position: absolute;
            left: 50%; 
            transform: translateX(-50%); 
            width: 16px; 
            height: 8px; 
            background-color: inherit; 
            z-index: 4; 
        }
        .duration-span::before { /* Start cap */
            top: 0;
            transform: translateX(-50%) translateY(-50%); 
        }
        .duration-span::after { /* End cap */
            bottom: 0;
            transform: translateX(-50%) translateY(50%); 
        }

        /* Color preview in modal */
        #colorPreview {
            display: inline-block;
            width: 28px; 
            height: 28px; 
            border-radius: 50%;
            border: 1px solid #ccc;
            vertical-align: middle;
            margin-left: 8px;
        }
        
        /* Styles for Political Context Bars */
        #context-bar-container {
            position: absolute;
            top: 0;
            left: 6px; /* Far left with 6px padding */
            height: 100%;
            z-index: 1; 
            padding-top: 60px; /* Align with first year block */
            display: none; /* Hidden by default */
        }
        
        /* Show the container when the toggle is active */
        .show-context #context-bar-container {
            display: block;
        }

        .context-bar-lane {
            position: absolute;
            top: 0;
            height: 100%;
            width: 12px; 
            z-index: 1; 
            background-color: rgba(200, 200, 200, 0.2);
            border-radius: 5px;
        }
        
        .context-bar-segment {
            position: absolute;
            width: 100%;
            opacity: 0.6;
            transition: opacity 0.3s ease;
            border-radius: 2px;
            z-index: 2; /* Ensure segment is on top of lane bg */
        }
        
        .context-bar-segment:hover {
            opacity: 1.0;
        }

        .context-bar-legend {
            position: absolute;
            top: 0;
            writing-mode: vertical-rl;
            transform: rotate(180deg) translateX(100%) translateY(5px);
            transform-origin: bottom right;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
            color: #555;
            padding-bottom: 5px;
            white-space: nowrap;
        }

        /* Styling for multi-note list in card */
        .month-content ul {
            list-style-type: none;
            padding-left: 0;
            margin: 0;
            space-y: 1;
        }
        .month-content ul li {
            padding: 12px 16px; 
            background-color: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            text-align: left; /* Ensure list items are left-aligned */
            margin-bottom: 8px; 
            /* font-size: 1rem; /* text-base */ /* Handled by --timeline-card-fs */
        }
        .month-content ul li:last-child {
            margin-bottom: 0;
        }
        /* Ensure even in right-aligned cards, the list is readable */
        .month-item:nth-child(odd) .month-content ul {
            text-align: left;
        }
        
        .note-day {
            font-weight: 700;
            color: #059669; /* emerald-600 */
            /* font-size: 1rem; /* text-base */ /* Handled by --timeline-card-fs */
        }
        .note-tag {
            /* font-size: 0.875rem; /* text-sm */ /* Proportional */
            font-weight: 500;
            color: #4338ca; /* indigo-700 */
            background-color: #e0e7ff; /* indigo-100 */
            padding: 3px 8px; 
            border-radius: 4px;
            margin-left: 8px;
        }
        
        /* NEW: Sidebar Styles */
        #sidebar {
            /* DELETED Margin Properties */
            z-index: 40; /* NEW: Ensure sidebar is on top */
            position: relative; /* NEW: Ensure z-index works */
        }
        
        #sidebar-content {
            position: sticky;
            /* top: 180px; */ /* REMOVED: Set by JS */
            padding: var(--sidebar-padding-y) var(--sidebar-padding-x); /* NEW: Controlled by JS */
            
            /* NEW: 200% Width + 40% Overlap */
            width: 200%;
            transform: translateX(-40%);
            z-index: 40;
        }
        
        #sidebar-content h2 { font-size: var(--sidebar-title-fs); }
        #sidebar-content h3 { font-size: calc(var(--sidebar-body-fs) * 1.25); }
        #summary-display, #key-figures-container p, #key-figures-container .figure-item p {
            font-size: var(--sidebar-body-fs);
        }
        
        #key-figures-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* NEW: Sidebar summary display */
        #summary-display {
            min-height: 12rem; /* h-48 */
            padding: 0.75rem; /* p-3 */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0.375rem; /* rounded-md */
            background-color: #f9fafb; /* bg-gray-50 */
            white-space: pre-wrap; /* Show line breaks */
            color: #374151; /* text-gray-700 */
        }
        
        /* DELETED btn-delete-figure styles (moved to modal) */
        
        /* DELETED: Figure hover styles. This is now handled by the global tooltip. */
        /* .figure-item .figure-description-tooltip { ... } */
        /* .figure-item .figure-description-tooltip::after { ... } */
        /* .figure-item:hover .figure-description-tooltip { ... } */
        
        /* NEW: UI Modal styles */
        #uiModal label {
            /* font-size: 1rem; /* text-base */ /* Handled by --modal-body-fs */
            font-weight: 500;
        }
        #uiModal .range-value {
            /* font-size: 1rem; */
            font-weight: 600;
            color: #059669;
        }
        #uiModal input[type="range"] {
            width: 100%;
        }
        
        /* NEW: Analysis Modal Styles */
        #analysis-figures-list {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- New Login Screen -->
    <div id="login-overlay">
        <div class="text-center p-8 bg-white shadow-xl rounded-lg">
            <h1 class="text-4xl font-bold text-emerald-700">BCS History Timeline</h1>
            <p class="text-xl text-gray-600 my-4">Please sign in to access your personal study timeline.</p>
            <button id="login-btn" class="px-8 py-4 text-lg bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main App Content (hidden by default) -->
    <div class="main-app-content">
        <!-- Header -->
        <header class="bg-white shadow-md p-8 sticky top-0 z-50"> <!-- Increased padding -->
            <!-- Increased max-width to max-w-screen-2xl -->
            <div class="container mx-auto max-w-screen-2xl">
                <h1 class="text-4xl font-bold text-emerald-700">BCS History Timeline</h1> <!-- Increased size -->
                <p class="text-xl text-gray-600">Focus: 1947 - 1951</p> <!-- Increased size -->
                
                <div class="flex items-center justify-between mt-4">
                    <div id="userInfo" class="text-sm text-gray-500 mt-2">Connecting...</div> <!-- Increased size -->
                    <div class="flex items-center space-x-4">
                        <!-- Manage UI Button -->
                        <button id="manageUiBtn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md hover:bg-blue-700 transition-colors"> <!-- Increased size -->
                            Manage UI
                        </button>
                        <!-- Manage Context Button -->
                        <button id="manageContextBtn" class="px-4 py-2 bg-gray-600 text-white text-base font-medium rounded-md hover:bg-gray-700 transition-colors"> <!-- Increased size -->
                            Manage Context
                        </button>
                        <!-- NEW: Manage Analysis Button -->
                        <button id="manageAnalysisBtn" class="px-4 py-2 bg-purple-600 text-white text-base font-medium rounded-md hover:bg-purple-700 transition-colors">
                            Manage Analysis
                        </button>
                        <!-- Context Toggle -->
                        <div class="flex items-center space-x-2">
                            <span class="text-base font-medium text-gray-700">Context</span> <!-- Increased size -->
                            <label for="contextToggle" class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="contextToggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-gray-300 peer-checked:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                            </label>
                        </div>
                        <!-- Compact Toggle -->
                        <div class="flex items-center space-x-2">
                            <span class="text-base font-medium text-gray-700">Compact</span> <!-- Increased size -->
                            <label for="compactToggle" class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="compactToggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-emerald-300 peer-checked:bg-emerald-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                            </label>
                        </div>
                        <!-- Sign Out Button -->
                         <button id="sign-out-btn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md hover:bg-red-700 transition-colors"> <!-- Increased size -->
                            Sign Out
                        </button>
                    </div>
                </div>
                <!-- New Tag Filter Bar -->
                <div class="mt-4">
                    <input type="text" id="tagFilter" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="Filter by tag (e.g., politics)..."> <!-- Increased size -->
                </div>
            </div>
        </header>

        <!-- Main Content - Changed to Grid Layout -->
        <main class="container mx-auto max-w-screen-2xl py-16 px-6 grid grid-cols-1 lg:grid-cols-3" style="gap: var(--main-gap);"> <!-- Increased max-width and gap -->
            
            <!-- Column 1: Timeline -->
            <div class="lg-col-span-2">
                <div id="timeline-container" class="relative timeline-container">
                    <!-- New container for political context bars -->
                    <div id="context-bar-container">
                        <!-- Context bars will be injected here by JS -->
                    </div>
                    <!-- Timeline will be generated by JS -->
                </div>
            </div>

            <!-- Column 2: New Sidebar -->
            <aside id="sidebar" class="lg:col-span-1 relative">
                <div id="sidebar-content" class="sticky bg-white shadow-lg rounded-lg border border-gray-200"> <!-- Increased padding -->
                    <h2 class="text-3xl font-bold mb-4">Analysis for <span id="sidebar-year">1947</span></h2> <!-- Increased size -->
            
                    <!-- Summary Box - MODIFIED for display only -->
                    <div>
                        <h3 class="text-xl font-semibold text-gray-700">My Summary & Analysis</h3> <!-- Increased size -->
                        <div id="summary-display" class="w-full h-48 p-3 text-base border rounded-md mt-2 bg-gray-50 whitespace-pre-wrap overflow-y-auto" placeholder="Your 'big picture' analysis for this year..."></div> <!-- REPLACED textarea -->
                        <!-- REMOVED Save Button -->
                    </div>
                    
                    <!-- Key Figures Box - MODIFIED for display only -->
                    <div class="mt-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-semibold text-gray-700">Key Figures</h3> <!-- Increased size -->
                            <!-- REMOVED Add Figure Button -->
                        </div>
                        <!-- UPDATED to grid-cols-4 -->
                        <div id="key-figures-container" class="mt-2 grid grid-cols-4 gap-2 p-2 bg-gray-50 rounded-md border">
                            <!-- Figures will be injected here -->
                            <p id="key-figures-placeholder" class="text-base text-gray-500 italic col-span-4">No figures added for this year.</p> <!-- Increased size -->
                        </div>
                    </div>
                </div>
            </aside>
        </main>
        
        <!-- Footer -->
        <footer class="text-center p-8 text-base text-gray-500"> <!-- Increased size -->
            A study tool crafted for your success.
        </footer>
    </div> <!-- End .main-app-content -->


    <!-- Info Modal Dialog -->
    <dialog id="infoModal" class="p-0 rounded-lg shadow-xl w-full max-w-xl"> <!-- Increased size -->
        <form id="infoForm" class="space-y-6"> <!-- Increased padding/spacing -->
            <div>
                <h2 class="text-3xl font-semibold" id="modalTitle">Add Information</h2> <!-- Increased size -->
                <p class="text-lg text-gray-600" id="modalSubTitle">Year 1947, January</p> <!-- Increased size -->
            </div>
            
            <!-- Hidden fields -->
            <input type="hidden" id="modalYear">
            <input type="hidden" id="modalMonth">
            <input type="hidden" id="modalDocId">
            
            <!-- New Note Management Area -->
            <div>
                <label class="block text-base font-medium text-gray-700 mb-2">Notes:</label> <!-- Increased size -->
                <!-- Container for dynamic note entries -->
                <div id="notesContainer" class="space-y-4 max-h-60 overflow-y-auto p-3 border rounded-md bg-gray-50"> <!-- Increased spacing -->
                    <!-- Note entries will be dynamically added here -->
                </div>
                <!-- Add Note Button -->
                <button type="button" id="addNoteEntry" class="mt-3 w-full px-4 py-3 bg-emerald-100 text-emerald-700 text-base font-medium rounded-md hover:bg-emerald-200 transition-colors"> <!-- Increased size -->
                    + Add Note
                </button>
            </div>

            <!-- Duration Event Fields -->
            <div class="p-5 bg-gray-50 rounded-md border border-gray-200 space-y-4"> <!-- Increased padding/spacing -->
                <h3 class="font-medium text-lg">Event Duration (Optional)</h3> <!-- Increased size -->
                <p class="text-base text-gray-500">Use this to mark a multi-month event, like a war. This is separate from the notes above.</p> <!-- Increased size -->
                <div>
                    <label for="modalEventType" class="block text-base font-medium text-gray-700 mb-1">Type:</label> <!-- Increased size -->
                    <select id="modalEventType" class="w-full p-3 text-base border border-gray-300 rounded-md"> <!-- Increased size -->
                        <option value="single" selected>Not a duration event</option>
                        <option value="start">Start of Event</option>
                        <option value="end">End of Event</option>
                    </select>
                </div>
                
                <!-- Fields shown for start/end -->
                <div id="modalDurationFields" class="hidden space-y-4"> <!-- Increased spacing -->
                    <div>
                        <label for="modalEventTitle" class="block text-base font-medium text-gray-700 mb-1"> <!-- Increased size -->
                            Event Title (must be identical for start and end)
                        </label>
                        <input type="text" id="modalEventTitle" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="e.g., Language Movement"> <!-- Increased size -->
                    </div>
                    
                    <!-- Color picker (only for 'start') -->
                    <div id="modalEventColorWrapper">
                        <label for="modalEventColor" class="inline-block text-base font-medium text-gray-700 mb-1">Event Color:</label> <!-- Increased size -->
                        <input type="color" id="modalEventColor" class="w-12 h-10 p-1 border border-gray-300 rounded-md align-middle" value="#3b82f6"> <!-- Increased size -->
                        <span id="colorPreview" style="background-color: #3b82f6;"></span>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="modalCancel" class="px-6 py-3 text-base bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors"> <!-- Increased size -->
                    Cancel
                </button>
                <button type="submit" id="modalSave" class="px-6 py-3 text-base bg-emerald-600 text-white rounded-md hover:bg-emerald-700 transition-colors"> <!-- Increased size -->
                    Save
                </button>
            </div>
        </form>
    </dialog>

    <!-- Context Modal Dialog -->
    <dialog id="contextModal" class="p-0 rounded-lg shadow-xl w-full max-w-3xl"> <!-- Increased size -->
        <div class="p-8"> <!-- Increased padding -->
            <h2 class="text-3xl font-semibold">Manage Political Context</h2> <!-- Increased size -->
            <p class="text-lg text-gray-600">Add or remove governing eras. These will be shown as vertical bars on the timeline.</p> <!-- Increased size -->
            
            <!-- Form for adding new context -->
            <form id="contextForm" class="mt-6 p-6 border border-gray-200 rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-2 gap-6"> <!-- Increased padding/gap -->
                <h3 class="text-xl font-medium col-span-1 md:col-span-2">Add New Era</h3> <!-- Increased size -->
                <div>
                    <label for="contextRole" class="block text-base font-medium text-gray-700 mb-1">Role / Title</label> <!-- Increased size -->
                    <input type="text" id="contextRole" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="e.g., Governor-General" required> <!-- Increased size -->
                </div>
                <div>
                    <label for="contextName" class="block text-base font-medium text-gray-700 mb-1">Person / Party Name</label> <!-- Increased size -->
                    <input type="text" id="contextName" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="e.g., Khawaja Nazimuddin" required> <!-- Increased size -->
                </div>
                <!-- Start Date -->
                <div class="grid grid-cols-3 gap-3"> <!-- Increased gap -->
                    <div>
                        <label for="contextStartYear" class="block text-base font-medium text-gray-700 mb-1">Start Year</label> <!-- Increased size -->
                        <select id="contextStartYear" class="w-full p-3 text-base border border-gray-300 rounded-md" required> <!-- Increased size -->
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="contextStartMonth" class="block text-base font-medium text-gray-700 mb-1">Start Month</label> <!-- Increased size -->
                        <select id="contextStartMonth" class="w-full p-3 text-base border border-gray-300 rounded-md" required> <!-- Increased size -->
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="contextStartDay" class="block text-base font-medium text-gray-700 mb-1">Start Day</label> <!-- Increased size -->
                        <select id="contextStartDay" class="w-full p-3 text-base border border-gray-300 rounded-md" required> <!-- Increased size -->
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                </div>
                <!-- End Date -->
                <div class="grid grid-cols-3 gap-3"> <!-- Increased gap -->
                    <div>
                        <label for="contextEndYear" class="block text-base font-medium text-gray-700 mb-1">End Year</label> <!-- Increased size -->
                        <select id="contextEndYear" class="w-full p-3 text-base border border-gray-300 rounded-md" required> <!-- Increased size -->
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="contextEndMonth" class="block text-base font-medium text-gray-700 mb-1">End Month</label> <!-- Increased size -->
                        <select id="contextEndMonth" class="w-full p-3 text-base border border-gray-300 rounded-md" required> <!-- Increased size -->
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="contextEndDay" class="block text-base font-medium text-gray-700 mb-1">End Day</label> <!-- Increased size -->
                        <select id="contextEndDay" class="w-full p-3 text-base border border-gray-300 rounded-md" required> <!-- Increased size -->
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                </div>
                <div>
                    <label for="contextColor" class="block text-base font-medium text-gray-700 mb-1">Bar Color</label> <!-- Increased size -->
                    <input type="color" id="contextColor" class="w-full h-12 p-1 border border-gray-300 rounded-md" value="#eab308"> <!-- Increased size -->
                </div>
                <div class="flex items-end">
                    <button type="submit" class="w-full px-6 py-3 text-base bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors"> <!-- Increased size -->
                        Save Context Era
                    </button>
                </div>
            </form>

            <!-- List of existing contexts -->
            <div class="mt-6">
                <h3 class="text-xl font-medium">Existing Eras</h3> <!-- Increased size -->
                <div id="contextList" class="mt-2 space-y-3 max-h-60 overflow-y-auto p-3 border rounded-md"> <!-- Increased padding/spacing -->
                    <p class="text-gray-500 italic text-base">No context eras added yet.</p> <!-- Increased size -->
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button type="button" id="contextModalClose" class="px-6 py-3 text-base bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors"> <!-- Increased size -->
                    Close
                </button>
            </div>
        </div>
    </dialog>

    <!-- Figure Modal Dialog -->
    <dialog id="figureModal" class="p-0 rounded-lg shadow-xl w-full max-w-lg"> <!-- Increased size -->
        <form id="figureForm" class="p-8 space-y-5"> <!-- Increased padding/spacing -->
            <h2 class="text-2xl font-semibold">Add Key Figure for <span id="figure-modal-year">1947</span></h2> <!-- Increased size -->
            <input type="hidden" id="figure-year-hidden">
            <div>
                <label for="figureName" class="block text-base font-medium text-gray-700 mb-1">Name</label> <!-- Increased size -->
                <input type="text" id="figureName" class="w-full p-3 text-base border border-gray-300 rounded-md" required> <!-- Increased size -->
            </div>
            <div>
                <label for="figureImageUrl" class="block text-base font-medium text-gray-700 mb-1">Image URL</label> <!-- Increased size -->
                <input type="text" id="figureImageUrl" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="https://... image link" required> <!-- Increased size -->
                <img id="figure-preview" src="https://placehold.co/100x100?text=Preview" alt="preview" class="w-24 h-24 object-cover mt-2 rounded-md border">
            </div>
            <div>
                <label for="figureDescription" class="block text-base font-medium text-gray-700 mb-1">Description (for hover)</label> <!-- Increased size -->
                <textarea id="figureDescription" class="w-full p-3 text-base border border-gray-300 rounded-md" rows="3" placeholder="e.g., Role in the Language Movement..." required></textarea> <!-- Increased size -->
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" id="figure-modal-cancel" class="px-5 py-3 text-base bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button> <!-- Increased size -->
                <button type="submit" class="px-5 py-3 text-base bg-emerald-600 text-white rounded-md hover:bg-emerald-700">Save Figure</button> <!-- Increased size -->
            </div>
        </form>
    </dialog>
    
    <!-- REBUILT: UI Settings Modal -->
    <dialog id="uiModal" class="p-0 rounded-lg shadow-xl w-full max-w-5xl"> <!-- Increased size -->
        <div class="p-8 space-y-6">
            <h2 class="text-3xl font-semibold">Manage UI Settings</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6"> <!-- 4 Columns -->
                <!-- Column 1: Global & Layout -->
                <div class="space-y-6 p-4 bg-gray-50 rounded-lg border">
                    <h3 class="text-xl font-semibold border-b pb-2">Global & Gaps</h3>
                    <!-- Global Scale Slider -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="globalScaleSlider" class="block text-base font-medium text-gray-700">Global Scale (Zoom)</label>
                            <span id="globalScaleValue" class="range-value">100%</span>
                        </div>
                        <input type="range" id="globalScaleSlider" min="80" max="150" value="100" class="w-full"> <!-- Increased max -->
                    </div>
                    
                    <!-- Timeline/Sidebar Gap -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="layoutGapSlider" class="block text-base font-medium text-gray-700">Timeline/Sidebar Gap</label>
                            <span id="layoutGapValue" class="range-value">3rem</span>
                        </div>
                        <input type="range" id="layoutGapSlider" min="2" max="15" value="3" step="0.5" class="w-full"> <!-- Increased max, new default -->
                    </div>
                    
                    <!-- NEW: Line Height -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="lineHeightSlider" class="block text-base font-medium text-gray-700">Global Line Height</label>
                            <span id="lineHeightValue" class="range-value">1.6</span>
                        </div>
                        <input type="range" id="lineHeightSlider" min="1.2" max="2.2" value="1.6" step="0.1" class="w-full">
                    </div>
                </div>
                
                <!-- Column 2: Timeline -->
                <div class="space-y-6 p-4 bg-gray-50 rounded-lg border">
                    <h3 class="text-xl font-semibold border-b pb-2">Timeline</h3>
                    <!-- Vertical Spacing Slider -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="verticalSpacingSlider" class="block text-base font-medium text-gray-700">Vertical Spacing</label>
                            <span id="verticalSpacingValue" class="range-value">2rem</span>
                        </div>
                        <input type="range" id="verticalSpacingSlider" min="1" max="5" value="2" step="0.25" class="w-full"> <!-- Increased max -->
                    </div>
                    
                    <!-- Year Header Font Size -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="yearHeaderFsSlider" class="block text-base font-medium text-gray-700">Year Header Font</label>
                            <span id="yearHeaderFsValue" class="range-value">2.25rem</span>
                        </div>
                        <input type="range" id="yearHeaderFsSlider" min="1.5" max="4" value="2.25" step="0.125" class="w-full"> <!-- Increased max -->
                    </div>

                    <!-- Month Card Font Size -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="monthCardFsSlider" class="block text-base font-medium text-gray-700">Month Card Font</label>
                            <span id="monthCardFsValue" class="range-value">1rem</span>
                        </div>
                        <input type="range" id="monthCardFsSlider" min="0.75" max="1.5" value="1" step="0.125" class="w-full"> <!-- Widened range -->
                    </div>
                    
                    <!-- NEW: Card Padding Y -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="monthCardPadYSlider" class="block text-base font-medium text-gray-700">Month Card Padding (Y)</label>
                            <span id="monthCardPadYValue" class="range-value">1.5rem</span>
                        </div>
                        <input type="range" id="monthCardPadYSlider" min="0.5" max="5" value="1.5" step="0.25" class="w-full"> <!-- Increased max -->
                    </div>
                    <!-- NEW: Card Padding X -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="monthCardPadXSlider" class="block text-base font-medium text-gray-700">Month Card Padding (X)</label>
                            <span id="monthCardPadXValue" class="range-value">1.5rem</span>
                        </div>
                        <input type="range" id="monthCardPadXSlider" min="0.5" max="5" value="1.5" step="0.25" class="w-full"> <!-- Increased max -->
                    </div>
                </div>
                
                <!-- Column 3: Sidebar -->
                <div class="space-y-6 p-4 bg-gray-50 rounded-lg border">
                    <h3 class="text-xl font-semibold border-b pb-2">Sidebar</h3>
                    <!-- DELETED Margin Sliders -->
                    <!-- NEW: Sidebar Padding Y -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="sidebarPadYSlider" class="block text-base font-medium text-gray-700">Content Padding (Y)</label>
                            <span id="sidebarPadYValue" class="range-value">1.5rem</span>
                        </div>
                        <input type="range" id="sidebarPadYSlider" min="0.5" max="5" value="1.5" step="0.25" class="w-full"> <!-- Increased max -->
                    </div>
                    <!-- NEW: Sidebar Padding X -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="sidebarPadXSlider" class="block text-base font-medium text-gray-700">Content Padding (X)</label>
                            <span id="sidebarPadXValue" class="range-value">1.5rem</span>
                        </div>
                        <input type="range" id="sidebarPadXSlider" min="0.5" max="5" value="1.5" step="0.25" class="w-full"> <!-- Increased max -->
                    </div>
                    <!-- Sidebar Title Font Size -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="sidebarTitleFsSlider" class="block text-base font-medium text-gray-700">Title Font</label>
                            <span id="sidebarTitleFsValue" class="range-value">3.75rem</span>
                        </div>
                        <input type="range" id="sidebarTitleFsSlider" min="1.25" max="5" value="3.75" step="0.125" class="w-full"> <!-- Increased max -->
                    </div>
                    
                    <!-- Sidebar Body Font Size -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="sidebarBodyFsSlider" class="block text-base font-medium text-gray-700">Body Font</label>
                            <span id="sidebarBodyFsValue" class="range-value">2rem</span>
                        </div>
                        <input type="range" id="sidebarBodyFsSlider" min="0.75" max="3" value="2" step="0.125" class="w-full"> <!-- Widened range -->
                    </div>
                </div>
                
                <!-- Column 4: Modals (Pop-ups) -->
                <div class="space-y-6 p-4 bg-gray-50 rounded-lg border">
                    <h3 class="text-xl font-semibold border-b pb-2">Modals (Pop-ups)</h3>
                    <!-- NEW: Modal Padding Y -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="modalPadYSlider" class="block text-base font-medium text-gray-700">Padding (Y)</label>
                            <span id="modalPadYValue" class="range-value">2rem</span>
                        </div>
                        <input type="range" id="modalPadYSlider" min="1" max="5" value="2" step="0.25" class="w-full"> <!-- Increased max -->
                    </div>
                    <!-- NEW: Modal Padding X -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="modalPadXSlider" class="block text-base font-medium text-gray-700">Padding (X)</label>
                            <span id="modalPadXValue" class="range-value">2rem</span>
                        </div>
                        <input type="range" id="modalPadXSlider" min="1" max="5" value="2" step="0.25" class="w-full"> <!-- Increased max -->
                    </div>
                    
                    <!-- Modal Title Font Size -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="modalTitleFsSlider" class="block text-base font-medium text-gray-700">Title Font</label>
                            <span id="modalTitleFsValue" class="range-value">1.875rem</span>
                        </div>
                        <input type="range" id="modalTitleFsSlider" min="1.25" max="3" value="1.875" step="0.125" class="w-full"> <!-- Increased max -->
                    </div>
                    
                    <!-- Modal Body Font Size -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="modalBodyFsSlider" class="block text-base font-medium text-gray-700">Body Font</label>
                            <span id="modalBodyFsValue" class="range-value">1rem</span>
                        </div>
                        <input type="range" id="modalBodyFsSlider" min="0.75" max="1.5" value="1" step="0.125" class="w-full"> <!-- Widened range -->
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="mt-8 flex justify-between space-x-3">
                <button type="button" id="uiResetBtn" class="px-6 py-3 text-base bg-red-100 text-red-700 rounded-md hover:bg-red-200 transition-colors">
                    Reset to Default
                </button>
                <button type="button" id="uiModalClose" class="px-6 py-3 text-base bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </dialog>
    
    <!-- NEW: Analysis Modal -->
    <dialog id="analysisModal" class="p-0 rounded-lg shadow-xl w-full max-w-3xl">
        <div class="p-8">
            <h2 class="text-3xl font-semibold">Manage Yearly Analysis</h2>
            
            <!-- Year Selector -->
            <div class="mt-6 mb-6">
                <label for="analysisYearSelect" class="block text-xl font-medium text-gray-700 mb-2">Select Year to Edit:</label>
                <select id="analysisYearSelect" class="w-full p-3 text-base border border-gray-300 rounded-md">
                    <!-- Year options will be populated by JS -->
                </select>
            </div>

            <!-- Summary Section -->
            <div class="space-y-2">
                <h3 class="text-xl font-semibold text-gray-700">My Summary & Analysis</h3>
                <textarea id="analysisSummaryTextarea" class="w-full h-40 p-3 text-base border rounded-md focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Your 'big picture' analysis for this year..."></textarea>
                <button id="analysisSaveSummaryBtn" class="mt-2 px-5 py-2 bg-emerald-600 text-white text-base rounded-md hover:bg-emerald-700 transition-colors">
                    Save Summary
                </button>
            </div>

            <!-- Key Figures Section -->
            <div class="mt-8">
                <h3 class="text-xl font-semibold text-gray-700">Key Figures</h3>
                
                <!-- Form to Add Figure -->
                <form id="analysisFigureForm" class="mt-4 p-4 grid grid-cols-1 md:grid-cols-2 gap-4 border border-gray-200 rounded-lg bg-gray-50">
                    <h4 class="text-lg font-medium col-span-1 md:col-span-2">Add New Figure</h4>
                    <div>
                        <label for="analysisFigureName" class="block text-base font-medium text-gray-700 mb-1">Name</label>
                        <input type="text" id="analysisFigureName" class="w-full p-3 text-base border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="analysisFigureImageUrl" class="block text-base font-medium text-gray-700 mb-1">Image URL</label>
                        <input type="text" id="analysisFigureImageUrl" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="https://... image link" required>
                        <!-- NEW: Image preview -->
                        <img id="analysis-figure-preview" src="https://placehold.co/100x100?text=Preview" alt="preview" class="w-24 h-24 object-cover mt-2 rounded-md border" onerror="this.src='https://placehold.co/100x100/f87171/ffffff?text=Invalid+Link'">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label for="analysisFigureDescription" class="block text-base font-medium text-gray-700 mb-1">Description (for hover)</label>
                        <textarea id="analysisFigureDescription" class="w-full p-3 text-base border border-gray-300 rounded-md" rows="2" placeholder="e.g., Role in the Language Movement..." required></textarea>
                    </div>
                    <div class="col-span-1 md:col-span-2 flex justify-end">
                        <button type="submit" class="px-5 py-2 bg-gray-600 text-white text-base rounded-md hover:bg-gray-700 transition-colors">
                            Add Figure
                        </button>
                    </div>
                </form>

                <!-- List of Existing Figures -->
                <div class="mt-4">
                    <h4 class="text-lg font-medium">Existing Figures for this Year</h4>
                    <div id="analysisFiguresList" class="mt-2 space-y-3 max-h-48 overflow-y-auto p-3 border rounded-md">
                        <p class="text-gray-500 italic text-base">No figures added for this year.</p>
                    </div>
                </div>
            </div>

            <!-- Close Button -->
            <div class="mt-8 flex justify-end">
                <button type="button" id="analysisModalClose" class="px-6 py-3 text-base bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </dialog>

    <!-- NEW: Global Tooltip -->
    <!-- UPDATED: max-width to 300px and added visibility: hidden -->
    <div id="global-tooltip" class="fixed p-3 text-sm text-white bg-gray-900 rounded-lg shadow-lg z-[9999] opacity-0 transition-opacity duration-200 pointer-events-none" style="max-width: 300px; transform: translate(-50%, 10px); visibility: hidden;"></div>


    <!-- Firebase and App Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // --- PART 2: Updated Auth Imports ---
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // -------------------------------------
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection,
            query,
            setLogLevel,
            where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES ---
        
        // --- PART 2: YOUR FIREBASE CONFIG IS NOW HERE ---
        const firebaseConfig = {
          apiKey: "AIzaSyBb8Wnm_8Su5SYR4SwyrJOzC-Yl3Sd5DM4",
          authDomain: "timeline-715a5.firebaseapp.com",
          projectId: "timeline-715a5",
          storageBucket: "timeline-715a5.firebasestorage.app",
          messagingSenderId: "396178765786",
          appId: "1:396178765786:web:fbf38fe8b12a11fbf872e3",
          measurementId: "G-6FQS8Q2WZ5"
        };
        // --------------------------------------------------


        // Firebase services
        let app, auth, db;
        
        // App state
        let userId = null;
        let isAuthReady = false;
        
        // --- Timeline State ---
        let timelineEventsRef = null;
        let unsubscribeTimeline = null; 

        // --- Context Bar State ---
        let contextEventsRef = null;
        let unsubscribeContext = null;
        let allContextData = [];
        
        // --- New Sidebar State ---
        let summariesRef = null;
        let keyFiguresRef = null;
        let unsubscribeSummaries = null;
        let unsubscribeKeyFigures = null;
        let allSummaries = new Map(); // Map<year, summaryText>
        let allKeyFigures = []; // Array of figure objects
        let currentActiveYear = '1947'; // Default year
        
        // NEW: IntersectionObserver for sticky year
        let yearObserver = null;

        // Constants
        const MONTHS = [
            "January", "February", "March", "April", "May", "June", 
            "July", "August", "September", "October", "November", "December"
        ];
        const START_YEAR = 1947;
        const END_YEAR = 1951;
        
        let DAY_OPTIONS_HTML = ''; // Will be populated once

        // DOM Elements
        const header = document.querySelector('header'); // NEW
        const timelineContainer = document.getElementById('timeline-container');
        const userInfo = document.getElementById('userInfo');
        const modal = document.getElementById('infoModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalSubTitle = document.getElementById('modalSubTitle');
        const modalForm = document.getElementById('infoForm');
        const modalYear = document.getElementById('modalYear');
        const modalMonth = document.getElementById('modalMonth');
        const modalDocId = document.getElementById('modalDocId');
        const notesContainer = document.getElementById('notesContainer');
        const addNoteEntryBtn = document.getElementById('addNoteEntry');
        const modalCancel = document.getElementById('modalCancel');
        
        const modalEventType = document.getElementById('modalEventType');
        const modalDurationFields = document.getElementById('modalDurationFields');
        const modalEventTitle = document.getElementById('modalEventTitle');
        const modalEventColorWrapper = document.getElementById('modalEventColorWrapper');
        const modalEventColor = document.getElementById('modalEventColor');
        const colorPreview = document.getElementById('colorPreview');

        const manageContextBtn = document.getElementById('manageContextBtn');
        const contextToggle = document.getElementById('contextToggle');
        const contextBarContainer = document.getElementById('context-bar-container');
        const contextModal = document.getElementById('contextModal');
        const contextForm = document.getElementById('contextForm');
        const contextModalClose = document.getElementById('contextModalClose');
        const contextList = document.getElementById('contextList');
        const contextRole = document.getElementById('contextRole');
        const contextName = document.getElementById('contextName');
        const contextStartYear = document.getElementById('contextStartYear');
        const contextStartMonth = document.getElementById('contextStartMonth');
        const contextStartDay = document.getElementById('contextStartDay');
        const contextEndYear = document.getElementById('contextEndYear');
        const contextEndMonth = document.getElementById('contextEndMonth');
        const contextEndDay = document.getElementById('contextEndDay');
        const contextColor = document.getElementById('contextColor');
        
        const tagFilterInput = document.getElementById('tagFilter');
        
        // --- New Sidebar DOM Elements ---
        const sidebar = document.getElementById('sidebar'); // NEW
        const sidebarContent = document.getElementById('sidebar-content'); // NEW
        const sidebarYear = document.getElementById('sidebar-year');
        const summaryDisplay = document.getElementById('summary-display'); // MODIFIED
        const keyFiguresContainer = document.getElementById('key-figures-container');
        const keyFiguresPlaceholder = document.getElementById('key-figures-placeholder');
        
        // --- New Figure Modal DOM Elements ---
        const figureModal = document.getElementById('figureModal');
        const figureForm = document.getElementById('figureForm');
        const figureModalYear = document.getElementById('figure-modal-year');
        const figureYearHidden = document.getElementById('figure-year-hidden');
        const figureName = document.getElementById('figureName');
        const figureImageUrl = document.getElementById('figureImageUrl');
        const figurePreview = document.getElementById('figure-preview');
        const figureDescription = document.getElementById('figureDescription');
        const figureModalCancel = document.getElementById('figure-modal-cancel');
        
        // --- New Auth DOM Elements ---
        const loginOverlay = document.getElementById('login-overlay');
        const loginBtn = document.getElementById('login-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const mainAppContent = document.querySelector('.main-app-content');
        
        // --- NEW: UI Modal Elements ---
        const manageUiBtn = document.getElementById('manageUiBtn');
        const uiModal = document.getElementById('uiModal');
        const uiModalClose = document.getElementById('uiModalClose');
        const uiResetBtn = document.getElementById('uiResetBtn');
        const globalScaleSlider = document.getElementById('globalScaleSlider');
        const globalScaleValue = document.getElementById('globalScaleValue');
        const layoutGapSlider = document.getElementById('layoutGapSlider');
        const layoutGapValue = document.getElementById('layoutGapValue');
        // NEW: Line Height
        const lineHeightSlider = document.getElementById('lineHeightSlider');
        const lineHeightValue = document.getElementById('lineHeightValue');
        
        const verticalSpacingSlider = document.getElementById('verticalSpacingSlider');
        const verticalSpacingValue = document.getElementById('verticalSpacingValue');
        const yearHeaderFsSlider = document.getElementById('yearHeaderFsSlider');
        const yearHeaderFsValue = document.getElementById('yearHeaderFsValue');
        const monthCardFsSlider = document.getElementById('monthCardFsSlider');
        const monthCardFsValue = document.getElementById('monthCardFsValue');
        const sidebarTitleFsSlider = document.getElementById('sidebarTitleFsSlider');
        const sidebarTitleFsValue = document.getElementById('sidebarTitleFsValue');
        const sidebarBodyFsSlider = document.getElementById('sidebarBodyFsSlider');
        const sidebarBodyFsValue = document.getElementById('sidebarBodyFsValue');
        const modalTitleFsSlider = document.getElementById('modalTitleFsSlider');
        const modalTitleFsValue = document.getElementById('modalTitleFsValue');
        const modalBodyFsSlider = document.getElementById('modalBodyFsSlider');
        const modalBodyFsValue = document.getElementById('modalBodyFsValue');
        // --- NEW Padding Sliders ---
        const monthCardPadYSlider = document.getElementById('monthCardPadYSlider');
        const monthCardPadYValue = document.getElementById('monthCardPadYValue');
        const monthCardPadXSlider = document.getElementById('monthCardPadXSlider');
        const monthCardPadXValue = document.getElementById('monthCardPadXValue');
        const sidebarPadYSlider = document.getElementById('sidebarPadYSlider');
        const sidebarPadYValue = document.getElementById('sidebarPadYValue');
        const sidebarPadXSlider = document.getElementById('sidebarPadXSlider');
        const sidebarPadXValue = document.getElementById('sidebarPadXValue');
        const modalPadYSlider = document.getElementById('modalPadYSlider');
        const modalPadYValue = document.getElementById('modalPadYValue');
        const modalPadXSlider = document.getElementById('modalPadXSlider');
        const modalPadXValue = document.getElementById('modalPadXValue');
        // --- DELETED Margin Slider consts ---


        // --- NEW Analysis Modal Elements ---
        const manageAnalysisBtn = document.getElementById('manageAnalysisBtn');
        const analysisModal = document.getElementById('analysisModal');
        const analysisModalClose = document.getElementById('analysisModalClose');
        const analysisYearSelect = document.getElementById('analysisYearSelect');
        const analysisSummaryTextarea = document.getElementById('analysisSummaryTextarea');
        const analysisSaveSummaryBtn = document.getElementById('analysisSaveSummaryBtn');
        const analysisFiguresList = document.getElementById('analysisFiguresList');
        const analysisFigureForm = document.getElementById('analysisFigureForm');
        const analysisFigureName = document.getElementById('analysisFigureName');
        const analysisFigureImageUrl = document.getElementById('analysisFigureImageUrl');
        const analysisFigureDescription = document.getElementById('analysisFigureDescription');
        const analysisFigurePreview = document.getElementById('analysis-figure-preview'); // NEW
 
        // --- INITIALIZATION ---
 
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug'); // Enable detailed logs
                
                // Pre-generate day options
                let dayOptions = '<option value="">Day?</option>';
                for (let d = 1; d <= 31; d++) {
                    dayOptions += `<option value="${d}">${d}</option>`;
                }
                DAY_OPTIONS_HTML = dayOptions;

                // NEW: Load UI settings from localStorage
                loadUiSettings();
                
                // NEW: Populate Analysis Year Selector
                let yearOptions = '';
                for (let y = START_YEAR; y <= END_YEAR; y++) {
                    yearOptions += `<option value="${y}">${y}</option>`;
                }
                analysisYearSelect.innerHTML = yearOptions;

                // Render the static HTML structure
                renderTimelineStructure();

                // Set up authentication
                setupAuth();
                
                // Set up global event listeners
                setupEventListeners();
                
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                userInfo.textContent = "Error: Could not connect to services.";
            }
        });
        
        // NEW: Function to set sticky top
        function updateStickyTop() {
            if (header) { // sidebarContent is already checked
                const headerHeight = header.offsetHeight;
                const stickyTopValue = `${headerHeight + 20}px`;
                
                // 1. Update Sidebar
                if (sidebarContent) {
                    sidebarContent.style.top = stickyTopValue;
                }
                
                // 2. NEW: Update all Year Headers
                document.querySelectorAll('.year-block').forEach(block => { // Target the block
                    block.style.top = stickyTopValue; // Set top on the block
                });
                
                // 3. NEW: Re-initialize the observer with the new stickyTopValue
                observeYearHeaders(headerHeight + 20);
            }
        }

        /**
         * Sets up Firebase authentication and listens for state changes.
         */
        async function setupAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // --- User is SIGNED IN ---
                    userId = user.uid;
                    isAuthReady = true;
                    userInfo.textContent = `Signed in as: ${user.displayName || user.email}`;
                    
                    // --- PART 2: Update database paths ---
                    timelineEventsRef = collection(db, 'users', userId, 'timeline_events');
                    contextEventsRef = collection(db, 'users', userId, 'political_context');
                    summariesRef = collection(db, 'users', userId, 'year_summaries');
                    keyFiguresRef = collection(db, 'users', userId, 'key_figures');
                    // ------------------------------------

                    await addInitialData();

                    // --- Start all data listeners ---
                    listenForTimelineData();
                    listenForContextData();
                    listenForSummaries();
                    listenForKeyFigures();
                    // --------------------------------
                    
                    // Show the app, hide the login
                    mainAppContent.style.display = 'block';
                    loginOverlay.style.display = 'none';
                    
                    // NEW: Set sticky top position
                    updateStickyTop();
                    
                    // NEW: Update analysis modal for the default selected year
                    updateAnalysisModal(analysisYearSelect.value);

                } else {
                    // --- User is SIGNED OUT ---
                    userId = null;
                    isAuthReady = false;
                    userInfo.textContent = "Please sign in.";
                    
                    // Stop all listeners
                    if (unsubscribeTimeline) unsubscribeTimeline();
                    if (unsubscribeContext) unsubscribeContext();
                    if (unsubscribeSummaries) unsubscribeSummaries();
                    if (unsubscribeKeyFigures) unsubscribeKeyFigures();
                    
                    // Hide the app, show the login
                    mainAppContent.style.display = 'none';
                    loginOverlay.style.display = 'flex';
                }
            });
            
            // --- PART 2: New Sign-in Logic ---
            loginBtn.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                    // onAuthStateChanged will handle the rest
                } catch (error) {
                    console.error("Error during sign-in:", error);
                    userInfo.textContent = "Sign-in failed. Please try again.";
                }
            });
            
            // --- PART 2: New Sign-out Logic ---
            signOutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    // onAuthStateChanged will handle the rest
                } catch (error) {
                    console.error("Error during sign-out:", error);
                }
            });
        }
        
        /**
         * Checks if initial data exists and adds it if not.
         * This ensures the user sees an example entry on first load.
         */
        async function addInitialData() {
            if (!timelineEventsRef) return;
            
            const flagDocRef = doc(timelineEventsRef, 'init_flag');
            
            try {
                const flagDoc = await getDoc(flagDocRef);
                if (!flagDoc.exists()) {
                    // New "notes object" format
                    await addDoc(timelineEventsRef, {
                        year: 1947,
                        month: "August",
                        info: [
                            { day: "14", note: "Pakistan becomes an independent dominion.", tag: "partition" },
                            { day: "15", note: "Partition of British India. East Bengal becomes part of Pakistan.", tag: "partition" }
                        ],
                        eventType: "single"
                    });
                    
                    await setDoc(flagDocRef, { initialized: true });
                }
            } catch (error) {
                console.error("Error checking/adding initial data:", error);
            }
        }

        /**
         * Renders the static HTML structure of the timeline (years, months).
         * Data will be populated separately.
         */
        function renderTimelineStructure() {
            timelineContainer.innerHTML = ''; // Clear existing
            
            timelineContainer.innerHTML = '<div id="context-bar-container"></div>';

            for (let year = START_YEAR; year <= END_YEAR; year++) {
                const yearHeader = document.createElement('div');
                yearHeader.className = 'year-block text-center';
                yearHeader.dataset.year = year; // <-- Important for IntersectionObserver
                // RESTORED old logic with new, larger classes
                yearHeader.innerHTML = ` 
                    <!-- DELETED: Anchor for observer -->
                    <span class="relative z-10 inline-block px-8 py-3 bg-emerald-700 text-white font-bold rounded-lg shadow-lg">
                        ${year}
                    </span>
                `;
                timelineContainer.appendChild(yearHeader);

                MONTHS.forEach(month => {
                    const monthItem = document.createElement('div');
                    monthItem.className = 'month-item flex flex-col';
                    monthItem.id = `month-item-${year}-${month}`; 
                    monthItem.dataset.year = year;
                    monthItem.dataset.month = month;
                    
                    // RESTORED old logic with new, larger classes
                    monthItem.innerHTML = `
                        <div class="timeline-dot"></div>
                        <div class="month-card z-10 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                            <h3 class="font-bold text-emerald-600">${month}</h3>
                            
                            <div class="month-content mt-2" id="content-${year}-${month}">
                                <p class="text-gray-500 italic">No notes added yet.</p>
                            </div>
                            
                            <div class="month-buttons mt-3 flex" id="buttons-${year}-${month}">
                                <button class="btn-add px-4 py-2 bg-emerald-100 text-emerald-700 font-medium rounded-md hover:bg-emerald-200 transition-colors"
                                        data-year="${year}" data-month="${month}">
                                    Add Info
                                </button>
                            </div>
                        </div>
                    `;
                    timelineContainer.appendChild(monthItem);
                });
            }
            
            populateContextDateDropdowns();
            
            // After rendering, set up the observer
            // observeYearHeaders(); // REMOVED: Called by updateStickyTop now
        }

        /**
         * Populates the date dropdowns in the context modal.
         */
        function populateContextDateDropdowns() {
            const yearOptions = [];
            for (let y = START_YEAR; y <= END_YEAR; y++) {
                yearOptions.push(`<option value="${y}">${y}</option>`);
            }
            const monthOptions = MONTHS.map(m => `<option value="${m}">${m}</option>`);
            
            const dayOptions = [];
            for (let d = 1; d <= 31; d++) {
                dayOptions.push(`<option value="${d}">${d}</option>`);
            }

            const yearOptionsHtml = yearOptions.join('');
            const monthOptionsHtml = monthOptions.join('');
            const dayOptionsHtml = dayOptions.join('');
            
            contextStartYear.innerHTML = yearOptionsHtml;
            contextEndYear.innerHTML = yearOptionsHtml;
            contextStartMonth.innerHTML = monthOptionsHtml;
            contextEndMonth.innerHTML = monthOptionsHtml;
            contextStartDay.innerHTML = dayOptionsHtml;
            contextEndDay.innerHTML = dayOptionsHtml;
            
            contextStartYear.value = START_YEAR;
            contextStartMonth.value = "January";
            contextStartDay.value = 1;
            contextEndYear.value = END_YEAR;
            contextEndMonth.value = "December";
            contextEndDay.value = 31;
        }
 
        // --- DATA LISTENER FUNCTIONS ---

        /**
         * Listens for real-time data from Firestore and updates the UI.
         */
        function listenForTimelineData() {
            if (!isAuthReady || !timelineEventsRef) return;
            if (unsubscribeTimeline) unsubscribeTimeline();

            const q = query(timelineEventsRef);
            
            unsubscribeTimeline = onSnapshot(q, (snapshot) => {
                resetAllMonthItems();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    
                    if (id === 'init_flag') return;

                    const { year, month, info } = data;
                    
                    const contentEl = document.getElementById(`content-${year}-${month}`);
                    const buttonsEl = document.getElementById(`buttons-${year}-${month}`);
                    const monthItemEl = document.getElementById(`month-item-${year}-${month}`);
                    
                    if (contentEl && buttonsEl && monthItemEl) {
                        monthItemEl.dataset.id = id;
                        
                        let infoContent = '';
                        let hasNotes = false;
                        
                        if (Array.isArray(info) && info.length > 0) {
                            const noteItems = info.map(noteData => {
                                let noteObj = {};
                                // Handle backward compatibility
                                if (typeof noteData === 'string') {
                                    noteObj = { note: noteData, day: '', tag: '' };
                                } else {
                                    noteObj = noteData;
                                }

                                const dayHtml = noteObj.day ? `<span class="note-day">${noteObj.day}: </span>` : '';
                                const tagHtml = noteObj.tag ? `<span class="note-tag">#${escapeHTML(noteObj.tag)}</span>` : '';
                                const tagDataAttr = noteObj.tag ? `data-tag="${escapeHTML(noteObj.tag.toLowerCase())}"` : '';

                                return `<li class="month-note-item" ${tagDataAttr}>
                                    ${dayHtml}${escapeHTML(noteObj.note)} ${tagHtml}
                                </li>`;
                            }).join('');
                            
                            infoContent = `<ul class="space-y-2">${noteItems}</ul>`;
                            hasNotes = true;
                        } 
                        
                        if (hasNotes) {
                            contentEl.innerHTML = infoContent;
                            monthItemEl.classList.add('has-data'); // Mark as having data
                        } else {
                            contentEl.innerHTML = `<p class="text-gray-500 italic">No notes added yet.</p>`;
                            monthItemEl.classList.remove('has-data'); // No notes, so no data
                        }

                        if (data.eventType === 'start' || data.eventType === 'end') {
                            contentEl.innerHTML += `
                                <span class="mt-2 inline-block text-xs font-medium px-2 py-0.5 rounded
                                    ${data.eventType === 'start' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}">
                                    ${data.eventType === 'start' ? 'Start' : 'End'}: ${escapeHTML(data.eventTitle)}
                                </span>
                            `;
                             monthItemEl.classList.add('has-data'); // Duration counts as data
                        }

                        buttonsEl.innerHTML = `
                            <button class="btn-edit px-4 py-2 bg-blue-100 text-blue-700 font-medium rounded-md hover:bg-blue-200 transition-colors"
                                    data-year="${year}" data-month="${month}" data-id="${id}">
                                Edit
                            </button>
                            <button class="btn-delete ml-2 px-4 py-2 bg-red-100 text-red-700 font-medium rounded-md hover:bg-red-200 transition-colors"
                                    data-id="${id}">
                                Delete
                            </button>
                        `;
                    }
                });
                
                applyTagFilter();
                renderDurationSpans(snapshot);
                updateYearBlockVisibility(document.getElementById('compactToggle').checked);
                renderContextBars();

            }, (error) => {
                console.error("Error with onSnapshot:", error);
            });
        }
        
        /**
         * Listens for real-time context data from Firestore.
         */
        function listenForContextData() {
            if (!isAuthReady || !contextEventsRef) return;
            if (unsubscribeContext) unsubscribeContext();

            const q = query(contextEventsRef);
            
            unsubscribeContext = onSnapshot(q, (snapshot) => {
                allContextData = [];
                snapshot.forEach(doc => {
                    allContextData.push({ id: doc.id, ...doc.data() });
                });
                
                allContextData.sort((a, b) => {
                    if (a.startYear !== b.startYear) return a.startYear - b.startYear;
                    const monthIndexA = MONTHS.indexOf(a.startMonth);
                    const monthIndexB = MONTHS.indexOf(b.startMonth);
                    if (monthIndexA !== monthIndexB) return monthIndexA - monthIndexB;
                    return (a.startDay || 1) - (b.startDay || 1);
                });
 
                renderContextListInModal();
                renderContextBars();
            }, (error) => {
                console.error("Error with context onSnapshot:", error);
            });
        }
        
        /**
         * Listens for yearly summaries data.
         */
        function listenForSummaries() {
            if (!isAuthReady || !summariesRef) return;
            if (unsubscribeSummaries) unsubscribeSummaries();
            
            unsubscribeSummaries = onSnapshot(summariesRef, (snapshot) => {
                allSummaries.clear();
                snapshot.forEach(doc => {
                    allSummaries.set(doc.id, doc.data().summaryText); // doc.id is the year
                });
                // Update sidebar for the currently active year
                updateSidebarContent(currentActiveYear);
                // NEW: Update analysis modal if it's open
                updateAnalysisModal(analysisYearSelect.value);
            });
        }
        
        /**
         * Listens for key figures data.
         */
        function listenForKeyFigures() {
            if (!isAuthReady || !keyFiguresRef) return;
            if (unsubscribeKeyFigures) unsubscribeKeyFigures();
            
            // This listener gets all figures. We filter by year in the update function.
            const q = query(keyFiguresRef);
            unsubscribeKeyFigures = onSnapshot(q, (snapshot) => {
                allKeyFigures = [];
                snapshot.forEach(doc => {
                    allKeyFigures.push({ id: doc.id, ...doc.data() });
                });
                // Update sidebar for the currently active year
                updateSidebarContent(currentActiveYear);
                // NEW: Update analysis modal if it's open
                updateAnalysisModal(analysisYearSelect.value);
            });
        }

        // --- RENDER/UPDATE FUNCTIONS ---

        /**
         * Draws the visual span bars on the timeline for duration events.
         */
        function renderDurationSpans(snapshot) {
            document.querySelectorAll('.duration-span').forEach(el => el.remove());
            const spansMap = new Map();

            snapshot.forEach(doc => {
                const data = doc.data();
                const { eventType, eventTitle, eventColor, year, month } = data;
                if (!eventTitle || (eventType !== 'start' && eventType !== 'end')) return;
                
                const monthItemEl = document.getElementById(`month-item-${year}-${month}`);
                if (!monthItemEl) return;
                
                const dotEl = monthItemEl.querySelector('.timeline-dot');
                if (!dotEl) return;

                const top = monthItemEl.offsetTop + dotEl.offsetTop;

                if (!spansMap.has(eventTitle)) {
                    spansMap.set(eventTitle, {});
                }
                if (eventType === 'start') {
                    spansMap.get(eventTitle).startTop = top;
                    spansMap.get(eventTitle).color = eventColor || '#cbd5e1';
                    spansMap.get(eventTitle).title = eventTitle;
                } else if (eventType === 'end') {
                    spansMap.get(eventTitle).endTop = top;
                }
            });

            const allSpans = Array.from(spansMap.values())
                .filter(s => s.startTop !== undefined && s.endTop !== undefined && s.endTop > s.startTop)
                .sort((a, b) => a.startTop - b.startTop);

            const activeLanes = []; 
            for (const span of allSpans) {
                let foundLane = false;
                for (let i = 0; i < activeLanes.length; i++) {
                    if (span.startTop >= activeLanes[i]) {
                        activeLanes[i] = span.endTop;
                        span.lane = i;
                        foundLane = true;
                        break;
                    }
                }
                if (!foundLane) {
                    span.lane = activeLanes.length;
                    activeLanes.push(span.endTop);
                }
            }

            const barWidthPx = 8;
            const barGapPx = 2;
            const initialOffsetFromMainLinePx = 4;

            for (const span of allSpans) {
                const totalOffsetForThisLane = initialOffsetFromMainLinePx + (span.lane * (barWidthPx + barGapPx));
                const height = span.endTop - span.startTop;

                const spanBar = document.createElement('div');
                spanBar.className = 'duration-span';
                spanBar.style.backgroundColor = span.color;
                spanBar.style.top = `${span.startTop}px`;
                spanBar.style.height = `${height}px`;
                spanBar.style.width = `${barWidthPx}px`;
                spanBar.style.transform = `translateX(calc(-100% - ${totalOffsetForThisLane}px))`;
                spanBar.title = span.title; // Show title on hover
                timelineContainer.appendChild(spanBar);
            }
        }

        /**
         * Renders the vertical context bars on the timeline.
         */
        function renderContextBars() {
            const contextBarContainer = document.getElementById('context-bar-container');
            if (!contextBarContainer) return;
            contextBarContainer.innerHTML = '';
            
            const rolesMap = new Map();
            allContextData.forEach(item => {
                if (!rolesMap.has(item.role)) {
                    rolesMap.set(item.role, []);
                }
                rolesMap.get(item.role).push(item);
            });

            const laneWidth = 12;
            const laneGap = 16;
            let laneIndex = 0;

            rolesMap.forEach((segments, role) => {
                const laneOffset = laneIndex * (laneWidth + laneGap);
                
                const laneEl = document.createElement('div');
                laneEl.className = 'context-bar-lane';
                laneEl.style.left = `${laneOffset}px`;
                
                const legendEl = document.createElement('div');
                legendEl.className = 'context-bar-legend';
                legendEl.textContent = role;
                laneEl.appendChild(legendEl);

                segments.forEach(segment => {
                    const startEl = document.getElementById(`month-item-${segment.startYear}-${segment.startMonth}`);
                    const endEl = document.getElementById(`month-item-${segment.endYear}-${segment.endMonth}`);
                    
                    if (!startEl || !endEl) return;

                    const startDot = startEl.querySelector('.timeline-dot');
                    const endDot = endEl.querySelector('.timeline-dot');
                    
                    if (!startDot || !endDot) return;

                    const startTop = startEl.offsetTop + startDot.offsetTop;
                    const endTop = endEl.offsetTop + endDot.offsetTop;
                    const height = endTop - startTop;

                    if (height < 0) return;

                    const segmentEl = document.createElement('div');
                    segmentEl.className = 'context-bar-segment';
                    segmentEl.style.backgroundColor = segment.color;
                    segmentEl.style.top = `${startTop}px`;
                    segmentEl.style.height = `${height}px`;
                    segmentEl.title = `${role}: ${segment.name}\n(${segment.startDay || ''} ${segment.startMonth} ${segment.startYear} - ${segment.endDay || ''} ${segment.endMonth} ${segment.endYear})`;
                    
                    laneEl.appendChild(segmentEl);
                });
                
                contextBarContainer.appendChild(laneEl);
                laneIndex++;
            });
        }

        /**
         * Renders the list of context items in the management modal.
         */
        function renderContextListInModal() {
            if (allContextData.length === 0) {
                contextList.innerHTML = `<p class="text-gray-500 italic text-base">No context eras added yet.</p>`;
                return;
            }

            contextList.innerHTML = allContextData.map(item => `
                <div class="flex items-center justify-between p-3 bg-white border rounded-md">
                    <div class="flex-1">
                        <span class="font-medium text-base" style="color: ${item.color};"> ${escapeHTML(item.role)}:</span>
                        <span class="text-gray-700 text-base">${escapeHTML(item.name)}</span>
                        <span class="text-sm text-gray-500 block">
                            (${item.startDay || ''} ${item.startMonth} ${item.startYear} - ${item.endDay || ''} ${item.endMonth} ${item.endYear})
                        </span>
                    </div>
                    <button class="btn-delete-context ml-4 px-4 py-2 bg-red-100 text-red-700 text-base font-medium rounded-md hover:bg-red-200 transition-colors"
                            data-id="${item.id}">
                        Delete
                    </button>
                </div>
            `).join('');
        }
        
        /**
         * Resets all month items to their default "empty" state.
         */
        function resetAllMonthItems() {
            document.querySelectorAll('.month-item').forEach(item => {
                const { year, month } = item.dataset;
                if (!year || !month) return;
                
                const contentEl = document.getElementById(`content-${year}-${month}`);
                const buttonsEl = document.getElementById(`buttons-${year}-${month}`);
                
                if (contentEl) {
                    contentEl.innerHTML = `<p class="text-gray-500 italic text-base">No notes added yet.</p>`;
                }
                if (buttonsEl) {
                    buttonsEl.innerHTML = `
                        <button class="btn-add px-4 py-2 bg-emerald-100 text-emerald-700 text-base font-medium rounded-md hover:bg-emerald-200 transition-colors"
                                data-year="${year}" data-month="${month}">
                            Add Info
                        </button>
                    `;
                }
                delete item.dataset.id;
                item.classList.remove('has-data');
                item.classList.remove('filtered-out'); // Reset filter
            });
            // Reset all note items
            document.querySelectorAll('.month-note-item').forEach(note => {
                note.classList.remove('filtered-out');
            });
        }
        
        /**
         * Updates the content of the sticky sidebar based on the active year.
         */
        function updateSidebarContent(year) {
            if (!year) return;
            
            // 1. Update Title
            sidebarYear.textContent = year;
            
            // 2. Update Summary Textarea
            const summary = allSummaries.get(year) || '';
            summaryDisplay.textContent = summary; // MODIFIED: Set textContent on the div
            if (!summary) {
                summaryDisplay.innerHTML = `<p class="text-gray-500 italic text-base">No summary added for this year.</p>`;
            }
            
            // 3. Update Key Figures
            keyFiguresContainer.innerHTML = ''; // Clear existing
            const figuresForYear = allKeyFigures.filter(fig => fig.year == year);
            
            if (figuresForYear.length === 0) {
                keyFiguresContainer.appendChild(keyFiguresPlaceholder);
                keyFiguresPlaceholder.style.display = 'block';
            } else {
                keyFiguresPlaceholder.style.display = 'none';
                figuresForYear.forEach(fig => {
                    const figEl = document.createElement('div');
                    figEl.className = 'figure-item relative';
                    figEl.dataset.description = escapeHTML(fig.description); // NEW: Add data attribute
                    
                    figEl.innerHTML = `
                        <img src="${escapeHTML(fig.imageUrl)}" alt="${escapeHTML(fig.name)}" class="w-full h-24 object-cover rounded-md border" onerror="this.src='https://placehold.co/100x100?text=Image'">
                        <p class="text-sm text-center font-medium truncate mt-1">${escapeHTML(fig.name)}</p>
                        <!-- DELETED: Inline tooltip div -->
                    `;
                    keyFiguresContainer.appendChild(figEl);
                });
            }
        }
        
        /**
         * NEW: Updates the content of the Analysis Modal based on the selected year.
         */
        function updateAnalysisModal(year) {
            if (!year) return;
            
            // 1. Update Summary Textarea
            const summary = allSummaries.get(year) || '';
            analysisSummaryTextarea.value = summary;
            
            // 2. Update Key Figures List
            analysisFiguresList.innerHTML = ''; // Clear existing
            const figuresForYear = allKeyFigures.filter(fig => fig.year == year);
            
            if (figuresForYear.length === 0) {
                analysisFiguresList.innerHTML = `<p class="text-gray-500 italic text-base">No figures added for this year.</p>`;
            } else {
                figuresForYear.forEach(fig => {
                    const figEl = document.createElement('div');
                    figEl.className = 'flex items-center justify-between p-3 bg-white border rounded-md';
                    figEl.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <img src="${escapeHTML(fig.imageUrl)}" alt="${escapeHTML(fig.name)}" class="w-12 h-12 object-cover rounded-md border" onerror="this.src='https://placehold.co/50x50?text=Img'">
                            <span class="text-base font-medium text-gray-700">${escapeHTML(fig.name)}</span>
                        </div>
                        <button class="btn-delete-figure-modal ml-4 px-3 py-1 bg-red-100 text-red-700 text-sm font-medium rounded-md hover:bg-red-200"
                                data-id="${fig.id}">
                            Delete
                        </button>
                    `;
                    analysisFiguresList.appendChild(figEl);
                });
            }
        }
        
        // --- EVENT LISTENER SETUP ---

        /**
         * Sets up global event listeners for buttons and modal.
         */
        function setupEventListeners() {
            // --- Timeline Listeners ---
            timelineContainer.addEventListener('click', (e) => {
                const target = e.target;
                
                if (target.classList.contains('btn-add')) {
                    const { year, month } = target.dataset;
                    openModalForAdd(year, month);
                } 
                else if (target.classList.contains('btn-edit')) {
                    const { year, month, id } = target.dataset;
                    openModalForEdit(year, month, id);
                }
                else if (target.classList.contains('btn-delete')) {
                    const { id } = target.dataset;
                    handleDelete(id);
                }
            });
            
            // --- Header Listeners ---
            compactToggle.addEventListener('change', () => {
                const isChecked = compactToggle.checked;
                timelineContainer.classList.toggle('compact-view', isChecked);
                updateYearBlockVisibility(isChecked);
                renderContextBars(); 
            });
            
            contextToggle.addEventListener('change', () => {
                timelineContainer.classList.toggle('show-context', contextToggle.checked);
            });
            
            manageContextBtn.addEventListener('click', () => {
                contextModal.showModal();
            });
            
            tagFilterInput.addEventListener('input', applyTagFilter);
            
            // NEW: Listen for window resize to update sticky top
            window.addEventListener('resize', updateStickyTop);

            // --- Notes Modal Listeners ---
            modalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleSave();
            });
            modalCancel.addEventListener('click', () => modal.close());
            modalEventType.addEventListener('change', () => {
                const type = modalEventType.value;
                modalDurationFields.classList.toggle('hidden', type === 'single');
                modalEventColorWrapper.classList.toggle('hidden', type !== 'start');
                colorPreview.style.display = (type === 'start') ? 'inline-block' : 'none';
            });
            modalEventColor.addEventListener('input', () => {
                colorPreview.style.backgroundColor = modalEventColor.value;
            });
            addNoteEntryBtn.addEventListener('click', () => createNoteEntry());
            notesContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-remove-note')) {
                    e.target.closest('.note-entry-group').remove();
                }
            });
            
            // --- Context Modal Listeners ---
            contextModalClose.addEventListener('click', () => contextModal.close());
            contextForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleSaveContext();
            });
            contextList.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-delete-context')) {
                    const id = e.target.dataset.id;
                    handleDeleteContext(id);
                }
            });
            
            // --- UPDATED: Sidebar Listeners (for new tooltip) ---
            const globalTooltip = document.getElementById('global-tooltip');

            keyFiguresContainer.addEventListener('mouseover', (e) => {
                const figureItem = e.target.closest('.figure-item');
                if (!figureItem || !globalTooltip) return;

                const description = figureItem.dataset.description;
                if (!description) return;

                // 1. Populate and set horizontal position
                globalTooltip.innerHTML = description;
                const rect = figureItem.getBoundingClientRect();
                globalTooltip.style.left = `${rect.left + (rect.width / 2)}px`;

                // 2. Show hidden to measure
                globalTooltip.style.visibility = 'hidden';
                globalTooltip.style.opacity = '1';

                // 3. Measure height
                const tooltipHeight = globalTooltip.offsetHeight;
                
                // 4. Check if it will be cut off (with a 10px buffer)
                if (rect.bottom + tooltipHeight + 10 > window.innerHeight) {
                    // Position above
                    globalTooltip.style.top = `${rect.top - tooltipHeight - 10}px`;
                    globalTooltip.style.transform = 'translate(-50%, -10px)'; // Adjust transform for above
                } else {
                    // Position below
                    globalTooltip.style.top = `${rect.bottom}px`;
                    globalTooltip.style.transform = 'translate(-50%, 10px)'; // Adjust transform for below
                }

                // 5. Make visible
                globalTooltip.style.visibility = 'visible';
            });

            keyFiguresContainer.addEventListener('mouseout', (e) => {
                const figureItem = e.target.closest('.figure-item');
                if (!figureItem || !globalTooltip) return;

                // Hide the tooltip
                globalTooltip.style.opacity = '0';
                globalTooltip.style.visibility = 'hidden';
            });
            
            // --- Figure Modal Listeners (Deprecated) ---
            figureModalCancel.addEventListener('click', () => figureModal.close());
            figureForm.addEventListener('submit', (e) => {
                e.preventDefault();
                // handleSaveFigure(); // This form is no longer used
            });
            figureImageUrl.addEventListener('input', () => {
                figurePreview.src = figureImageUrl.value || 'https://placehold.co/100x100?text=Preview';
            });
            
            // --- NEW: UI Modal Listeners ---
            manageUiBtn.addEventListener('click', () => uiModal.showModal());
            uiModalClose.addEventListener('click', () => uiModal.close());
            
            // Helper to update a CSS var, localStorage, and a text display
            const createSliderListener = (slider, valueDisplay, storageKey, cssVar, unit = '%', unitless = false) => { // NEW: unitless flag
                slider.addEventListener('input', (e) => {
                    const value = e.target.value;
                    const displayValue = unitless ? value : `${value}${unit}`;
                    document.documentElement.style.setProperty(cssVar, displayValue);
                    valueDisplay.textContent = displayValue;
                    localStorage.setItem(storageKey, value);
                    // DELETED Special case for sidebar margins
                });
            };

            createSliderListener(globalScaleSlider, globalScaleValue, 'uiScale', 'font-size', '%');
            createSliderListener(layoutGapSlider, layoutGapValue, 'uiGap', '--main-gap', 'rem');
            createSliderListener(lineHeightSlider, lineHeightValue, 'uiLineHeight', '--global-line-height', '', true); // NEW
            createSliderListener(verticalSpacingSlider, verticalSpacingValue, 'uiSpacing', '--timeline-v-spacing', 'rem');
            createSliderListener(yearHeaderFsSlider, yearHeaderFsValue, 'uiYearHeaderFs', '--timeline-year-fs', 'rem');
            createSliderListener(monthCardFsSlider, monthCardFsValue, 'uiMonthCardFs', '--timeline-card-fs', 'rem');
            createSliderListener(sidebarTitleFsSlider, sidebarTitleFsValue, 'uiSidebarTitleFs', '--sidebar-title-fs', 'rem');
            createSliderListener(sidebarBodyFsSlider, sidebarBodyFsValue, 'uiSidebarBodyFs', '--sidebar-body-fs', 'rem');
            createSliderListener(modalTitleFsSlider, modalTitleFsValue, 'uiModalTitleFs', '--modal-title-fs', 'rem');
            createSliderListener(modalBodyFsSlider, modalBodyFsValue, 'uiModalBodyFs', '--modal-body-fs', 'rem');
            // --- NEW Padding Listeners ---
            createSliderListener(monthCardPadYSlider, monthCardPadYValue, 'uiCardPadY', '--card-padding-y', 'rem');
            createSliderListener(monthCardPadXSlider, monthCardPadXValue, 'uiCardPadX', '--card-padding-x', 'rem');
            createSliderListener(sidebarPadYSlider, sidebarPadYValue, 'uiSidebarPadY', '--sidebar-padding-y', 'rem');
            createSliderListener(sidebarPadXSlider, sidebarPadXValue, 'uiSidebarPadX', '--sidebar-padding-x', 'rem');
            createSliderListener(modalPadYSlider, modalPadYValue, 'uiModalPadY', '--modal-padding-y', 'rem');
            createSliderListener(modalPadXSlider, modalPadXValue, 'uiModalPadX', '--modal-padding-x', 'rem');
            // --- DELETED Margin Listeners ---


            uiResetBtn.addEventListener('click', () => {
                // List of all settings [slider, storageKey, cssVar, defaultValue, unit, unitless]
                const allSettings = [
                    [globalScaleSlider, 'uiScale', 'font-size', 100, '%', false],
                    [layoutGapSlider, 'uiGap', '--main-gap', 3, 'rem', false], // New Default
                    [lineHeightSlider, 'uiLineHeight', '--global-line-height', 1.6, '', true], // NEW
                    [verticalSpacingSlider, 'uiSpacing', '--timeline-v-spacing', 2, 'rem', false],
                    [yearHeaderFsSlider, 'uiYearHeaderFs', '--timeline-year-fs', 2.25, 'rem', false],
                    [monthCardFsSlider, 'uiMonthCardFs', '--timeline-card-fs', 1, 'rem', false],
                    [sidebarTitleFsSlider, 'uiSidebarTitleFs', '--sidebar-title-fs', 3.75, 'rem', false], // 200% default
                    [sidebarBodyFsSlider, 'uiSidebarBodyFs', '--sidebar-body-fs', 2, 'rem', false], // 200% default
                    [modalTitleFsSlider, 'uiModalTitleFs', '--modal-title-fs', 1.875, 'rem', false],
                    [modalBodyFsSlider, 'uiModalBodyFs', '--modal-body-fs', 1, 'rem', false],
                    // --- NEW Padding/Margin Resets ---
                    [monthCardPadYSlider, 'uiCardPadY', '--card-padding-y', 1.5, 'rem', false],
                    [monthCardPadXSlider, 'uiCardPadX', '--card-padding-x', 1.5, 'rem', false],
                    [sidebarPadYSlider, 'uiSidebarPadY', '--sidebar-padding-y', 1.5, 'rem', false],
                    [sidebarPadXSlider, 'uiSidebarPadX', '--sidebar-padding-x', 1.5, 'rem', false],
                    [modalPadYSlider, 'uiModalPadY', '--modal-padding-y', 2, 'rem', false],
                    [modalPadXSlider, 'uiModalPadX', '--modal-padding-x', 2, 'rem', false],
                    // --- DELETED Margin Resets ---
                ];
                
                allSettings.forEach(([slider, key, cssVar, value, unit, unitless]) => {
                    localStorage.removeItem(key);
                    const displayValue = unitless ? value : `${value}${unit}`;
                    document.documentElement.style.setProperty(cssVar, displayValue);
                    slider.value = value;
                    // Find the corresponding value display element
                    const valueDisplay = document.getElementById(slider.id.replace('Slider', 'Value'));
                    if (valueDisplay) valueDisplay.textContent = displayValue;
                    // DELETED Special case for sidebar margins
                });
            });
            
            // --- NEW Analysis Modal Listeners ---
            manageAnalysisBtn.addEventListener('click', () => {
                updateAnalysisModal(analysisYearSelect.value); // Ensure it's up to date
                analysisModal.showModal();
                // NEW: Reset image preview on open
                analysisFigurePreview.src = 'https://placehold.co/100x100?text=Preview';
            });
            analysisModalClose.addEventListener('click', () => analysisModal.close());
            analysisYearSelect.addEventListener('change', (e) => {
                updateAnalysisModal(e.target.value);
            });
            analysisSaveSummaryBtn.addEventListener('click', handleSaveSummary);
            analysisFigureForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleSaveFigure();
            });
            // NEW: Image preview listener
            analysisFigureImageUrl.addEventListener('input', () => {
                const url = analysisFigureImageUrl.value.trim();
                analysisFigurePreview.src = url || 'https://placehold.co/100x100?text=Preview';
            });
            analysisFiguresList.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-delete-figure-modal')) {
                    const id = e.target.dataset.id;
                    handleDeleteFigure(id);
                }
            });
        }
        
        /**
         * NEW: Loads and applies UI settings from localStorage
         */
        function loadUiSettings() {
             // List of all settings [slider, storageKey, cssVar, defaultValue, unit, unitless]
            const allSettings = [
                [globalScaleSlider, 'uiScale', 'font-size', 100, '%', false],
                [layoutGapSlider, 'uiGap', '--main-gap', 3, 'rem', false], // New Default
                [lineHeightSlider, 'uiLineHeight', '--global-line-height', 1.6, '', true], // NEW
                [verticalSpacingSlider, 'uiSpacing', '--timeline-v-spacing', 2, 'rem', false],
                [yearHeaderFsSlider, 'uiYearHeaderFs', '--timeline-year-fs', 2.25, 'rem', false],
                [monthCardFsSlider, 'uiMonthCardFs', '--timeline-card-fs', 1, 'rem', false],
                [sidebarTitleFsSlider, 'uiSidebarTitleFs', '--sidebar-title-fs', 3.75, 'rem', false], // 200% default
                [sidebarBodyFsSlider, 'uiSidebarBodyFs', '--sidebar-body-fs', 2, 'rem', false], // 200% default
                [modalTitleFsSlider, 'uiModalTitleFs', '--modal-title-fs', 1.875, 'rem', false],
                [modalBodyFsSlider, 'uiModalBodyFs', '--modal-body-fs', 1, 'rem', false],
                // --- NEW Padding/Margin Loads ---
                [monthCardPadYSlider, 'uiCardPadY', '--card-padding-y', 1.5, 'rem', false],
                [monthCardPadXSlider, 'uiCardPadX', '--card-padding-x', 1.5, 'rem', false],
                [sidebarPadYSlider, 'uiSidebarPadY', '--sidebar-padding-y', 1.5, 'rem', false],
                [sidebarPadXSlider, 'uiSidebarPadX', '--sidebar-padding-x', 1.5, 'rem', false],
                [modalPadYSlider, 'uiModalPadY', '--modal-padding-y', 2, 'rem', false],
                [modalPadXSlider, 'uiModalPadX', '--modal-padding-x', 2, 'rem', false],
                // --- DELETED Margin Loads ---
            ];
            
            allSettings.forEach(([slider, key, cssVar, defaultValue, unit, unitless]) => {
                if (!slider) return; // Guard against missing elements
                const savedValue = localStorage.getItem(key) || defaultValue;
                const displayValue = unitless ? savedValue : `${savedValue}${unit}`;
                
                document.documentElement.style.setProperty(cssVar, displayValue);
                slider.value = savedValue;
                // Find the corresponding value display element
                const valueDisplay = document.getElementById(slider.id.replace('Slider', 'Value'));
                if (valueDisplay) valueDisplay.textContent = displayValue;
                
                // DELETED Special case for sidebar margins on load
            });
        }
        
        /**
         * Sets up the IntersectionObserver to watch year headers.
         */
        function observeYearHeaders(stickyTopPx = 180) { // NEW: Accepts dynamic top value
            if (yearObserver) yearObserver.disconnect(); // Disconnect old observer
            
            // This defines the "active" area of the screen. It starts `stickyTopPx` from the top
            // and ends 100px from the bottom (an arbitrary buffer).
            const observerOptions = {
                root: null, // viewport
                rootMargin: `-${stickyTopPx}px 0px -100px 0px`,
                threshold: 0 // Fire as soon as any part of the element enters this region
            };
            
            // This map will hold the elements currently in the "active" zone
            const intersectingElements = new Map();

            yearObserver = new IntersectionObserver((entries) => {
                
                // Update our map of intersecting elements
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        intersectingElements.set(entry.target, entry);
                    } else {
                        intersectingElements.delete(entry.target);
                    }
                });

                // Find the element that is "most active"
                // This means it's in the map and is the one closest to the top (smallest boundingClientRect.top)
                let mostActiveElement = null;
                let smallestTopValue = Infinity;

                intersectingElements.forEach((entry, element) => {
                    // Re-check bounding rect in case it's changed since observer fired
                    const top = element.getBoundingClientRect().top; 
                    if (top < smallestTopValue) {
                        smallestTopValue = top;
                        mostActiveElement = element;
                    }
                });

                if (mostActiveElement) {
                    const year = mostActiveElement.dataset.year;
                    if (year && year !== currentActiveYear) {
                        currentActiveYear = year;
                        updateSidebarContent(year);
                    }
                } else if (intersectingElements.size === 0) {
                    // This can happen if scrolling up *very* fast past the START_YEAR
                    // or scrolling down past the END_YEAR.
                    // We need to check our position relative to the first/last elements.
                    
                    const firstYearBlock = document.querySelector('.year-block[data-year="' + START_YEAR + '"]');
                    if (!firstYearBlock) return;

                    const firstBlockTop = firstYearBlock.getBoundingClientRect().top;
                    
                    if (firstBlockTop > stickyTopPx) {
                        // We are scrolled all the way to the top, above the first block
                        if (currentActiveYear !== START_YEAR.toString()) {
                            currentActiveYear = START_YEAR.toString();
                            updateSidebarContent(currentActiveYear);
                        }
                    }
                    // If we scroll past the end, the last active year will just remain active.
                }

            }, observerOptions);


            // NEW: Observe the .year-block elements
            document.querySelectorAll('.year-block').forEach(block => {
                yearObserver.observe(block);
            });
        }
        
        
        // --- MODAL/FORM HANDLER FUNCTIONS ---

        /**
         * Creates a new blank note entry field in the modal.
         */
        function createNoteEntry(note = { note: '', day: '', tag: '' }) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'note-entry-group p-4 border rounded-md bg-white shadow-sm';
            entryDiv.innerHTML = `
                <textarea class="note-text-input w-full p-3 text-base border border-gray-300 rounded-md" rows="2" placeholder="Enter note...">${escapeHTML(note.note)}</textarea>
                <div class="flex items-center space-x-2 mt-2">
                    <select class="note-day-input p-3 text-base border border-gray-300 rounded-md">
                        ${DAY_OPTIONS_HTML}
                    </select>
                    <input type="text" class="note-tag-input w-full p-3 text-base border border-gray-300 rounded-md" placeholder="Tag (optional)" value="${escapeHTML(note.tag)}">
                    <button type="button" class="btn-remove-note px-3 py-2 bg-red-100 text-red-700 text-sm font-medium rounded-md hover:bg-red-200">
                        Remove
                    </button>
                </div>
            `;
            // Set the selected day
            entryDiv.querySelector('.note-day-input').value = note.day;
            notesContainer.appendChild(entryDiv);
        }
        
        /**
         * Opens the modal to add a new note.
         */
        function openModalForAdd(year, month) {
            modalTitle.textContent = "Add Information";
            modalSubTitle.textContent = `Year ${year}, ${month}`;
            modalYear.value = year;
            modalMonth.value = month;
            modalDocId.value = "";
            
            notesContainer.innerHTML = '';
            createNoteEntry(); 
            
            modalEventType.value = "single";
            modalEventTitle.value = "";
            modalEventColor.value = "#3b82f6";
            colorPreview.style.backgroundColor = "#3b82f6";
            modalDurationFields.classList.add('hidden');
            colorPreview.style.display = 'none';

            modal.showModal();
        }
        
        /**
         * Opens the modal to edit an existing note.
         */
        async function openModalForEdit(year, month, docId) {
            if (!docId || !timelineEventsRef) return;
            
            const docRef = doc(timelineEventsRef, docId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    modalTitle.textContent = "Edit Information";
                    modalSubTitle.textContent = `Year ${year}, ${month}`;
                    modalYear.value = year;
                    modalMonth.value = month;
                    modalDocId.value = docId;
                    
                    notesContainer.innerHTML = ''; 
                    const info = data.info || [];
                    
                    if (Array.isArray(info) && info.length > 0) {
                        info.forEach(noteData => {
                            if (typeof noteData === 'string') {
                                createNoteEntry({ note: noteData, day: '', tag: '' });
                            } else {
                                createNoteEntry(noteData);
                            }
                        });
                    } else {
                        createNoteEntry();
                    }
                    
                    modalEventType.value = data.eventType || "single";
                    modalEventTitle.value = data.eventTitle || "";
                    modalEventColor.value = data.eventColor || "#3b82f6";
                    
                    const type = modalEventType.value;
                    modalDurationFields.classList.toggle('hidden', type === 'single');
                    modalEventColorWrapper.classList.toggle('hidden', type !== 'start');
                    colorPreview.style.display = (type === 'start') ? 'inline-block' : 'none';

                    modal.showModal();
                } else {
                    console.error("No such document to edit!");
                }
            } catch (error) {
                console.error("Error fetching document for edit:", error);
            }
        }
        
        /**
         * Opens the modal to add a new key figure.
         */
        function handleAddFigure() {
            // This function is now deprecated, as the form is in the Analysis modal.
            // Kept here in case any old references exist, but it should not be called.
            console.warn("handleAddFigure() called, but this UI is deprecated.");
        }

        // --- DATABASE SAVE/DELETE FUNCTIONS ---

        /**
         * Handles saving a new context era.
         */
        async function handleSaveContext() {
            if (!contextEventsRef) return;

            const dataToSave = {
                role: contextRole.value.trim(),
                name: contextName.value.trim(),
                startYear: parseInt(contextStartYear.value),
                startMonth: contextStartMonth.value,
                startDay: parseInt(contextStartDay.value),
                endYear: parseInt(contextEndYear.value),
                endMonth: contextEndMonth.value,
                endDay: parseInt(contextEndDay.value),
                color: contextColor.value
            };
 
            if (!dataToSave.role || !dataToSave.name) return;
            
            const startMonthIndex = MONTHS.indexOf(dataToSave.startMonth);
            const endMonthIndex = MONTHS.indexOf(dataToSave.endMonth);
 
            if (dataToSave.startYear > dataToSave.endYear || 
                (dataToSave.startYear === dataToSave.endYear && startMonthIndex > endMonthIndex) ||
                (dataToSave.startYear === dataToSave.endYear && startMonthIndex === endMonthIndex && dataToSave.startDay > dataToSave.endDay)) {
                console.error("Start date must be before end date.");
                return;
            }
            
            try {
                await addDoc(contextEventsRef, dataToSave);
                contextForm.reset();
                populateContextDateDropdowns(); // Reset dropdowns to default
            } catch (error) {
                console.error("Error saving context:", error);
            }
        }

        /**
         * Handles deleting a context era.
         */
        async function handleDeleteContext(docId) {
            if (!docId || !contextEventsRef) return;
            try {
                await deleteDoc(doc(contextEventsRef, docId));
            } catch (error) {
                console.error("Error deleting context:", error);
            }
        }


        /**
         * Handles saving data (either new or updated).
         */
        async function handleSave() {
            if (!timelineEventsRef) return;

            const year = modalYear.value;
            const month = modalMonth.value;
            const docId = modalDocId.value;
            const eventType = modalEventType.value;
            const eventTitle = modalEventTitle.value.trim();
            const eventColor = modalEventColor.value;

            const notesData = [];
            const noteEntryElements = notesContainer.querySelectorAll('.note-entry-group');
            
            noteEntryElements.forEach(entry => {
                const noteText = entry.querySelector('.note-text-input').value.trim();
                const day = entry.querySelector('.note-day-input').value;
                const tag = entry.querySelector('.note-tag-input').value.trim();
                
                if (noteText) { // Only save notes that have text
                    notesData.push({ note: noteText, day: day, tag: tag });
                }
            });

            if (notesData.length === 0 && eventType === 'single') {
                console.log("No notes to save.");
            }

            const dataToSave = {
                year: parseInt(year),
                month: month,
                info: notesData, // Save the array of note objects
                eventType: eventType
            };

            if (eventType === 'start' || eventType === 'end') {
                if (!eventTitle) {
                    modalEventTitle.classList.add('border-red-500');
                    setTimeout(() => modalEventTitle.classList.remove('border-red-500'), 2000);
                    return;
                }
                dataToSave.eventTitle = eventTitle;
                if (eventType === 'start') {
                    dataToSave.eventColor = eventColor;
                }
            }

            try {
                if (docId) {
                    await updateDoc(doc(timelineEventsRef, docId), dataToSave);
                } else {
                    await addDoc(timelineEventsRef, dataToSave);
                }
                modal.close();
            } catch (error) {
                console.error("Error saving document:", error);
            }
        }
        
        /**
         * Handles deleting a note.
         */
        async function handleDelete(docId) {
            if (!docId || !timelineEventsRef) return;
            try {
                await deleteDoc(doc(timelineEventsRef, docId));
            } catch (error) {
                console.error("Error deleting document:", error);
            }
        }
        
        /**
         * Saves the summary text for the current active year.
         */
        async function handleSaveSummary() {
            // MODIFIED: Reads from the new analysis modal
            const yearToSave = analysisYearSelect.value;
            if (!summariesRef || !yearToSave) return;
            
            const summaryText = analysisSummaryTextarea.value;
            const docRef = doc(summariesRef, yearToSave); // Use selected year as doc ID
            try {
                await setDoc(docRef, { summaryText: summaryText });
                // Visual feedback
                analysisSaveSummaryBtn.textContent = 'Saved!';
                analysisSaveSummaryBtn.classList.add('bg-green-500');
                setTimeout(() => {
                    analysisSaveSummaryBtn.textContent = 'Save Summary';
                    analysisSaveSummaryBtn.classList.remove('bg-green-500');
                }, 2000);
            } catch (e) { 
                console.error("Error saving summary: ", e); 
                analysisSaveSummaryBtn.textContent = 'Error!';
                analysisSaveSummaryBtn.classList.add('bg-red-500');
                setTimeout(() => {
                    analysisSaveSummaryBtn.textContent = 'Save Summary';
                    analysisSaveSummaryBtn.classList.remove('bg-red-500');
                }, 2000);
            }
        }
        
        /**
         * Saves a new key figure from the modal.
         */
        async function handleSaveFigure() {
            // MODIFIED: Reads from the new analysis modal form
            if (!keyFiguresRef) return;
            
            const dataToSave = {
                year: parseInt(analysisYearSelect.value), // Get year from the modal's select
                name: analysisFigureName.value.trim(),
                imageUrl: analysisFigureImageUrl.value.trim(),
                description: analysisFigureDescription.value.trim()
            };
            
            if (!dataToSave.name || !dataToSave.imageUrl || !dataToSave.description) {
                console.error("All figure fields are required.");
                return;
            }
            
            try {
                await addDoc(keyFiguresRef, dataToSave);
                analysisFigureForm.reset(); // Reset the form in the modal
                analysisFigurePreview.src = 'https://placehold.co/100x100?text=Preview'; // NEW: Reset preview
            } catch (error) {
                console.error("Error saving figure:", error);
            }
        }
        
        /**
         * Deletes a key figure.
         */
        async function handleDeleteFigure(docId) {
            if (!docId || !keyFiguresRef) return;
            try {
                await deleteDoc(doc(keyFiguresRef, docId));
            } catch (error) {
                console.error("Error deleting figure:", error);
            }
        }
        
        // --- FILTERING & VISIBILITY ---

        /**
         * Applies the tag filter to all notes on the timeline.
         */
        function applyTagFilter() {
            const filterText = tagFilterInput.value.toLowerCase().trim();

            if (!filterText) {
                document.querySelectorAll('.month-item').forEach(item => {
                    item.classList.remove('filtered-out');
                });
                document.querySelectorAll('.month-note-item').forEach(note => {
                    note.classList.remove('filtered-out');
                });
                
                updateYearBlockVisibility(document.getElementById('compactToggle').checked);
                return; 
            }
            
            document.querySelectorAll('.month-item').forEach(monthItem => {
                let monthHasVisibleNote = false;
                const noteItems = monthItem.querySelectorAll('.month-note-item');
                
                noteItems.forEach(noteItem => {
                    const tag = noteItem.dataset.tag || '';
                    if (tag.includes(filterText)) { 
                        noteItem.classList.remove('filtered-out');
                        monthHasVisibleNote = true;
                    } else {
                        noteItem.classList.add('filtered-out');
                    }
                });
                
                const hasDurationInfo = monthItem.querySelector('.bg-blue-100, .bg-red-100');

                if (monthHasVisibleNote || (hasDurationInfo && !filterText)) {
                    monthItem.classList.remove('filtered-out');
                } else {
                    monthItem.classList.add('filtered-out');
                }
            });
            
            updateYearBlockVisibility(document.getElementById('compactToggle').checked);
        }
        
        /**
         * Hides or shows year blocks based on whether they have populated months.
         */
        function updateYearBlockVisibility(isCompactView) {
            const yearBlocks = document.querySelectorAll('.year-block');
            
            yearBlocks.forEach(yearBlock => {
                let hasVisibleData = false;
                let nextElement = yearBlock.nextElementSibling;
                
                while (nextElement && !nextElement.classList.contains('year-block')) {
                    if (nextElement.classList.contains('month-item')) {
                        const hasData = nextElement.classList.contains('has-data');
                        const isFiltered = nextElement.classList.contains('filtered-out');
                        
                        if (hasData && !isFiltered) {
                            hasVisibleData = true;
                            break; 
                        }
                    }
                    nextElement = nextElement.nextElementSibling;
                }
                
                if (isCompactView && !hasVisibleData) {
                    yearBlock.classList.add('is-empty');
                } else {
                    yearBlock.classList.remove('is-empty');
                }
            });
        }

        /**
         * Utility to escape HTML for safe rendering.
         */
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                }[m];
            });
        }
        
    </script>
</body>
</html>
