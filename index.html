<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCS History Timeline (1947-1951)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6; /* A very light, calming green-gray */
        }
        
        /* New Login Overlay */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        #login-overlay h1 { font-size: 2.25rem; /* text-4xl */ }
        #login-overlay p { font-size: 1.25rem; /* text-xl */ }
        #login-overlay button { font-size: 1.125rem; /* text-lg */ padding: 1rem 2rem; }

        /* Hide main content by default */
        .main-app-content {
            display: none;
        }

        /* The main timeline vertical line */
        .timeline-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 6px; /* Increased */
            height: 100%;
            background-color: #cbd5e1; /* slate-300 */
            z-index: 2; 
        }

        /* Styling for each year block */
        .year-block {
            position: relative;
            padding: 2.5rem 0; /* Increased */
        }

        /* Styling for each month's "dot" on the timeline */
        .timeline-dot {
            position: absolute;
            top: 1.125rem; /* Adjusted for larger text */
            left: 50%;
            transform: translateX(-50%);
            width: 24px; /* Increased */
            height: 24px; /* Increased */
            background-color: white;
            border: 5px solid #059669; /* Increased */
            border-radius: 50%;
            z-index: 5; 
            transition: all 0.3s ease;
        }
        
        .month-item:hover .timeline-dot {
            transform: translateX(-50%) scale(1.1);
            border-color: #047857; /* emerald-700 */
        }

        /* Positioning month items on the left and right */
        .month-item {
            position: relative;
            width: 50%;
            padding: 0 3rem; /* Increased */
            margin-bottom: 2rem; /* Increased */
        }

        /* Even items on the right */
        .month-item:nth-child(even) {
            align-self: flex-end;
            padding-left: 3rem; /* Increased */
        }
        
        /* Odd items on the left */
        .month-item:nth-child(odd) {
            align-self: flex-start;
            padding-right: 3rem; /* Increased */
            text-align: right;
        }

        /* Adjust button alignment for left/right items */
        .month-item:nth-child(odd) .month-buttons {
            justify-content: flex-end;
        }
        
        .month-item:nth-child(even) .month-buttons {
            justify-content: flex-start;
        }

        /* The small horizontal line connecting dot to card */
        .month-item::after {
            content: '';
            position: absolute;
            top: 1.375rem; /* Adjusted for dot */
            width: 3rem; /* Increased */
            height: 3px; /* Increased */
            background: #cbd5e1; /* slate-300 */
            z-index: 2; 
        }

        .month-item:nth-child(even)::after {
            left: 0;
            transform: translateX(-100%);
        }

        .month-item:nth-child(odd)::after {
            right: 0;
            transform: translateX(100%);
        }

        /* Modal backdrop */
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        /* Styles for compact view */
        .compact-view .month-item {
            display: none;
        }
        
        /* This rule shows items that have data AND are not filtered out */
        .compact-view .month-item.has-data:not(.filtered-out) {
            display: flex; 
        }
        
        .compact-view .year-block.is-empty {
            display: none;
        }
        
        /* Styles for tag filtering */
        .month-item.filtered-out {
            display: none !important; /* Hide month item if all notes are filtered */
        }
        
        .month-note-item.filtered-out {
            display: none; /* Hide individual note item */
        }
        

        /* Style for the duration span bars */
        .duration-span {
            position: absolute;
            left: calc(50% - 3px); /* Adjusted */
            transform: translateX(-100%); 
            width: 8px; /* Increased */
            z-index: 3; 
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        /* I-beam caps */
        .duration-span::before,
        .duration-span::after {
            content: '';
            position: absolute;
            left: 50%; 
            transform: translateX(-50%); 
            width: 16px; /* Increased */
            height: 8px; /* Increased */
            background-color: inherit; 
            z-index: 4; 
        }
        .duration-span::before { /* Start cap */
            top: 0;
            transform: translateX(-50%) translateY(-50%); 
        }
        .duration-span::after { /* End cap */
            bottom: 0;
            transform: translateX(-50%) translateY(50%); 
        }

        /* Color preview in modal */
        #colorPreview {
            display: inline-block;
            width: 28px; /* Increased */
            height: 28px; /* Increased */
            border-radius: 50%;
            border: 1px solid #ccc;
            vertical-align: middle;
            margin-left: 8px;
        }
        
        /* Styles for Political Context Bars */
        #context-bar-container {
            position: absolute;
            top: 0;
            left: 6px; /* Far left with 6px padding */
            height: 100%;
            z-index: 1; 
            padding-top: 60px; /* Align with first year block */
            display: none; /* Hidden by default */
        }
        
        /* Show the container when the toggle is active */
        .show-context #context-bar-container {
            display: block;
        }

        .context-bar-lane {
            position: absolute;
            top: 0;
            height: 100%;
            width: 12px; /* Increased */
            z-index: 1; 
            background-color: rgba(200, 200, 200, 0.2);
            border-radius: 5px;
        }
        
        .context-bar-segment {
            position: absolute;
            width: 100%;
            opacity: 0.6;
            transition: opacity 0.3s ease;
            border-radius: 2px;
            z-index: 2; /* Ensure segment is on top of lane bg */
        }
        
        .context-bar-segment:hover {
            opacity: 1.0;
        }

        .context-bar-legend {
            position: absolute;
            top: 0;
            writing-mode: vertical-rl;
            transform: rotate(180deg) translateX(100%) translateY(5px);
            transform-origin: bottom right;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
            color: #555;
            padding-bottom: 5px;
            white-space: nowrap;
        }

        /* Styling for multi-note list in card */
        .month-content ul {
            list-style-type: none;
            padding-left: 0;
            margin: 0;
            space-y: 1;
        }
        .month-content ul li {
            padding: 12px 16px; /* Increased */
            background-color: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            text-align: left; /* Ensure list items are left-aligned */
            margin-bottom: 8px; /* Increased */
            font-size: 1rem; /* text-base */
        }
        .month-content ul li:last-child {
            margin-bottom: 0;
        }
        /* Ensure even in right-aligned cards, the list is readable */
        .month-item:nth-child(odd) .month-content ul {
            text-align: left;
        }
        
        .note-day {
            font-weight: 700;
            color: #059669; /* emerald-600 */
            font-size: 1rem; /* text-base */
        }
        .note-tag {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            color: #4338ca; /* indigo-700 */
            background-color: #e0e7ff; /* indigo-100 */
            padding: 3px 8px; /* Increased */
            border-radius: 4px;
            margin-left: 8px;
        }
        
        /* New Sidebar Styles */
        #sidebar-content {
            /* top-32 (128px) to be below sticky header */
            position: sticky;
            top: 180px; /* Increased */
        }
        
        #key-figures-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .figure-item .btn-delete-figure {
            display: none;
            position: absolute;
            top: -6px; /* Adjusted */
            right: -6px; /* Adjusted */
            width: 24px; /* Increased */
            height: 24px; /* Increased */
            line-height: 24px; /* Increased */
            text-align: center;
            font-size: 12px; /* Increased */
            font-weight: bold;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .figure-item:hover .btn-delete-figure {
            display: block;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- New Login Screen -->
    <div id="login-overlay">
        <div class="text-center p-8 bg-white shadow-xl rounded-lg">
            <h1 class="text-4xl font-bold text-emerald-700">BCS History Timeline</h1>
            <p class="text-xl text-gray-600 my-4">Please sign in to access your personal study timeline.</p>
            <button id="login-btn" class="px-8 py-4 text-lg bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main App Content (hidden by default) -->
    <div class="main-app-content">
        <!-- Header -->
        <header class="bg-white shadow-md p-8 sticky top-0 z-50"> <!-- Increased padding -->
            <!-- Increased max-width to max-w-7xl -->
            <div class="container mx-auto max-w-7xl">
                <h1 class="text-4xl font-bold text-emerald-700">BCS History Timeline</h1> <!-- Increased size -->
                <p class="text-xl text-gray-600">Focus: 1947 - 1951</p> <!-- Increased size -->
                
                <div class="flex items-center justify-between mt-4">
                    <div id="userInfo" class="text-sm text-gray-500 mt-2">Connecting...</div> <!-- Increased size -->
                    <div class="flex items-center space-x-4">
                        <!-- New Manage Context Button -->
                        <button id="manageContextBtn" class="px-4 py-2 bg-gray-600 text-white text-base font-medium rounded-md hover:bg-gray-700 transition-colors"> <!-- Increased size -->
                            Manage Context
                        </button>
                        <!-- New Context Toggle -->
                        <div class="flex items-center space-x-2">
                            <span class="text-base font-medium text-gray-700">Context</span> <!-- Increased size -->
                            <label for="contextToggle" class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="contextToggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-gray-300 peer-checked:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                            </label>
                        </div>
                        <!-- Existing Compact Toggle -->
                        <div class="flex items-center space-x-2">
                            <span class="text-base font-medium text-gray-700">Compact</span> <!-- Increased size -->
                            <label for="compactToggle" class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="compactToggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-emerald-300 peer-checked:bg-emerald-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                            </label>
                        </div>
                        <!-- New Sign Out Button -->
                         <button id="sign-out-btn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md hover:bg-red-700 transition-colors"> <!-- Increased size -->
                            Sign Out
                        </button>
                    </div>
                </div>
                <!-- New Tag Filter Bar -->
                <div class="mt-4">
                    <input type="text" id="tagFilter" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="Filter by tag (e.g., politics)..."> <!-- Increased size -->
                </div>
            </div>
        </header>

        <!-- Main Content - Changed to Grid Layout -->
        <main class="container mx-auto max-w-7xl py-16 px-6 grid grid-cols-1 lg:grid-cols-3 gap-12"> <!-- Increased padding/gap -->
            
            <!-- Column 1: Timeline -->
            <div class="lg:col-span-2">
                <div id="timeline-container" class="relative timeline-container">
                    <!-- New container for political context bars -->
                    <div id="context-bar-container">
                        <!-- Context bars will be injected here by JS -->
                    </div>
                    <!-- Timeline will be generated by JS -->
                </div>
            </div>

            <!-- Column 2: New Sidebar -->
            <aside id="sidebar" class="lg:col-span-1 relative">
                <div id="sidebar-content" class="sticky top-[180px] p-6 bg-white shadow-lg rounded-lg border border-gray-200"> <!-- Increased padding -->
                    <h2 class="text-3xl font-bold mb-4">Analysis for <span id="sidebar-year">1947</span></h2> <!-- Increased size -->
            
                    <!-- Summary Box -->
                    <div>
                        <h3 class="text-xl font-semibold text-gray-700">My Summary & Analysis</h3> <!-- Increased size -->
                        <textarea id="summary-textarea" class="w-full h-48 p-3 text-base border rounded-md mt-2 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Your 'big picture' analysis for this year..."></textarea> <!-- Increased size -->
                        <button id="save-summary-btn" class="mt-2 px-5 py-2 bg-emerald-600 text-white text-base rounded-md hover:bg-emerald-700 transition-colors"> <!-- Increased size -->
                            Save Summary
                        </button>
                    </div>
                    
                    <!-- Key Figures Box -->
                    <div class="mt-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-semibold text-gray-700">Key Figures</h3> <!-- Increased size -->
                            <button id="add-figure-btn" class="px-4 py-2 bg-gray-600 text-white text-base rounded-full font-bold hover:bg-gray-700">+</button> <!-- Increased size -->
                        </div>
                        <div id="key-figures-container" class="mt-2 grid grid-cols-3 gap-2 p-2 bg-gray-50 rounded-md border">
                            <!-- Figures will be injected here -->
                            <p id="key-figures-placeholder" class="text-base text-gray-500 italic col-span-3">No figures added for this year.</p> <!-- Increased size -->
                        </div>
                    </div>
                </div>
            </aside>
        </main>
        
        <!-- Footer -->
        <footer class="text-center p-8 text-base text-gray-500"> <!-- Increased size -->
            A study tool crafted for your success.
        </footer>
    </div> <!-- End .main-app-content -->


    <!-- Info Modal Dialog -->
    <dialog id="infoModal" class="p-0 rounded-lg shadow-xl w-full max-w-xl"> <!-- Increased size -->
        <form id="infoForm" class="p-8 space-y-6"> <!-- Increased padding/spacing -->
            <div>
                <h2 class="text-3xl font-semibold" id="modalTitle">Add Information</h2> <!-- Increased size -->
                <p class="text-lg text-gray-600" id="modalSubTitle">Year 1947, January</p> <!-- Increased size -->
            </div>
            
            <!-- Hidden fields -->
            <input type="hidden" id="modalYear">
            <input type="hidden" id="modalMonth">
            <input type="hidden" id="modalDocId">
            
            <!-- New Note Management Area -->
            <div>
                <label class="block text-base font-medium text-gray-700 mb-2">Notes:</label> <!-- Increased size -->
                <!-- Container for dynamic note entries -->
                <div id="notesContainer" class="space-y-4 max-h-60 overflow-y-auto p-3 border rounded-md bg-gray-50"> <!-- Increased spacing -->
                    <!-- Note entries will be dynamically added here -->
                </div>
                <!-- Add Note Button -->
                <button type="button" id="addNoteEntry" class="mt-3 w-full px-4 py-3 bg-emerald-100 text-emerald-700 text-base font-medium rounded-md hover:bg-emerald-200 transition-colors"> <!-- Increased size -->
                    + Add Note
                </button>
            </div>

            <!-- Duration Event Fields -->
            <div class="p-5 bg-gray-50 rounded-md border border-gray-200 space-y-4"> <!-- Increased padding/spacing -->
                <h3 class="font-medium text-lg">Event Duration (Optional)</h3> <!-- Increased size -->
                <p class="text-base text-gray-500">Use this to mark a multi-month event, like a war. This is separate from the notes above.</p> <!-- Increased size -->
                <div>
                    <label for="modalEventType" class="block text-base font-medium text-gray-700 mb-1">Type:</label> <!-- Increased size -->
                    <select id="modalEventType" class="w-full p-3 text-base border border-gray-300 rounded-md"> <!-- Increased size -->
                        <option value="single" selected>Not a duration event</option>
                        <option value="start">Start of Event</option>
                        <option value="end">End of Event</option>
                    </select>
                </div>
                
                <!-- Fields shown for start/end -->
                <div id="modalDurationFields" class="hidden space-y-4"> <!-- Increased spacing -->
                    <div>
                        <label for="modalEventTitle" class="block text-base font-medium text-gray-700 mb-1"> <!-- Increased size -->
                            Event Title (must be identical for start and end)
                        </label>
                        <input type="text" id="modalEventTitle" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="e.g., Language Movement"> <!-- Increased size -->
                    </div>
                    
                    <!-- Color picker (only for 'start') -->
                    <div id="modalEventColorWrapper">
                        <label for="modalEventColor" class="inline-block text-base font-medium text-gray-700 mb-1">Event Color:</label> <!-- Increased size -->
                        <input type="color" id="modalEventColor" class="w-12 h-10 p-1 border border-gray-300 rounded-md align-middle" value="#3b82f6"> <!-- Increased size -->
                        <span id="colorPreview" style="background-color: #3b82f6;"></span>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="modalCancel" class="px-6 py-3 text-base bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors"> <!-- Increased size -->
                    Cancel
                </button>
                <button type="submit" id="modalSave" class="px-6 py-3 text-base bg-emerald-600 text-white rounded-md hover:bg-emerald-700 transition-colors"> <!-- Increased size -->
                    Save
                </button>
            </div>
        </form>
    </dialog>

    <!-- Context Modal Dialog -->
    <dialog id="contextModal" class="p-0 rounded-lg shadow-xl w-full max-w-3xl"> <!-- Increased size -->
        <div class="p-8"> <!-- Increased padding -->
            <h2 class="text-3xl font-semibold">Manage Political Context</h2> <!-- Increased size -->
            <p class="text-lg text-gray-600">Add or remove governing eras. These will be shown as vertical bars on the timeline.</p> <!-- Increased size -->
            
            <!-- Form for adding new context -->
            <form id="contextForm" class="mt-6 p-6 border border-gray-200 rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-2 gap-6"> <!-- Increased padding/gap -->
                <h3 class="text-xl font-medium col-span-1 md:col-span-2">Add New Era</h3> <!-- Increased size -->
                <div>
                    <label for="contextRole" class="block text-base font-medium text-gray-700 mb-1">Role / Title</label> <!-- Increased size -->
                    <input type="text" id="contextRole" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="e.g., Governor-General" required> <!-- Increased size -->
                </div>
                <div>
                    <label for="contextName" class="block text-base font-medium text-gray-700 mb-1">Person / Party Name</label> <!-- Increased size -->
                    <input type="text" id="contextName" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="e.g., Khawaja Nazimuddin" required> <!-- Increased size -->
                </div>
                <!-- Start Date -->
                <div class="grid grid-cols-3 gap-3"> <!-- Increased gap -->
                    <div>
                        <label for="contextStartYear" class="block text-base font-medium text-gray-700 mb-1">Start Year</label> <!-- Increased size -->
                        <select id="contextStartYear" class="w-full p-3 text-base border border-gray-300 rounded-md" required> <!-- Increased size -->
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="contextStartMonth" class="block text-base font-medium text-gray-700 mb-1">Start Month</label> <!-- Increased size -->
                        <select id="contextStartMonth" class="w-full p-3 text-base border border-gray-300 rounded-md" required> <!-- Increased size -->
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="contextStartDay" class="block text-base font-medium text-gray-700 mb-1">Start Day</label> <!-- Increased size -->
                        <select id="contextStartDay" class="w-full p-3 text-base border border-gray-300 rounded-md" required> <!-- Increased size -->
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                </div>
                <!-- End Date -->
                <div class="grid grid-cols-3 gap-3"> <!-- Increased gap -->
                    <div>
                        <label for="contextEndYear" class="block text-base font-medium text-gray-700 mb-1">End Year</label> <!-- Increased size -->
                        <select id="contextEndYear" class="w-full p-3 text-base border border-gray-300 rounded-md" required> <!-- Increased size -->
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="contextEndMonth" class="block text-base font-medium text-gray-700 mb-1">End Month</label> <!-- Increased size -->
                        <select id="contextEndMonth" class="w-full p-3 text-base border border-gray-300 rounded-md" required> <!-- Increased size -->
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="contextEndDay" class="block text-base font-medium text-gray-700 mb-1">End Day</label> <!-- Increased size -->
                        <select id="contextEndDay" class="w-full p-3 text-base border border-gray-300 rounded-md" required> <!-- Increased size -->
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                </div>
                <div>
                    <label for="contextColor" class="block text-base font-medium text-gray-700 mb-1">Bar Color</label> <!-- Increased size -->
                    <input type="color" id="contextColor" class="w-full h-12 p-1 border border-gray-300 rounded-md" value="#eab308"> <!-- Increased size -->
                </div>
                <div class="flex items-end">
                    <button type="submit" class="w-full px-6 py-3 text-base bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors"> <!-- Increased size -->
                        Save Context Era
                    </button>
                </div>
            </form>

            <!-- List of existing contexts -->
            <div class="mt-6">
                <h3 class="text-xl font-medium">Existing Eras</h3> <!-- Increased size -->
                <div id="contextList" class="mt-2 space-y-3 max-h-60 overflow-y-auto p-3 border rounded-md"> <!-- Increased padding/spacing -->
                    <p class="text-gray-500 italic text-base">No context eras added yet.</p> <!-- Increased size -->
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button type="button" id="contextModalClose" class="px-6 py-3 text-base bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors"> <!-- Increased size -->
                    Close
                </button>
            </div>
        </div>
    </dialog>

    <!-- New Figure Modal Dialog -->
    <dialog id="figureModal" class="p-0 rounded-lg shadow-xl w-full max-w-lg"> <!-- Increased size -->
        <form id="figureForm" class="p-8 space-y-5"> <!-- Increased padding/spacing -->
            <h2 class="text-2xl font-semibold">Add Key Figure for <span id="figure-modal-year">1947</span></h2> <!-- Increased size -->
            <input type="hidden" id="figure-year-hidden">
            <div>
                <label for="figureName" class="block text-base font-medium text-gray-700 mb-1">Name</label> <!-- Increased size -->
                <input type="text" id="figureName" class="w-full p-3 text-base border border-gray-300 rounded-md" required> <!-- Increased size -->
            </div>
            <div>
                <label for="figureImageUrl" class="block text-base font-medium text-gray-700 mb-1">Image URL</label> <!-- Increased size -->
                <input type="text" id="figureImageUrl" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="https://... image link" required> <!-- Increased size -->
                <img id="figure-preview" src="https://placehold.co/100x100?text=Preview" alt="preview" class="w-24 h-24 object-cover mt-2 rounded-md border">
            </div>
            <div>
                <label for="figureDescription" class="block text-base font-medium text-gray-700 mb-1">Description (for hover)</label> <!-- Increased size -->
                <textarea id="figureDescription" class="w-full p-3 text-base border border-gray-300 rounded-md" rows="3" placeholder="e.g., Role in the Language Movement..." required></textarea> <!-- Increased size -->
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" id="figure-modal-cancel" class="px-5 py-3 text-base bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button> <!-- Increased size -->
                <button type="submit" class="px-5 py-3 text-base bg-emerald-600 text-white rounded-md hover:bg-emerald-700">Save Figure</button> <!-- Increased size -->
            </div>
        </form>
    </dialog>
    
    <!-- Year Block (for calculations, outside of visible flow) -->
    <div id="year-block-template" class="year-block text-center" style="visibility: hidden; position: absolute; z-index: -10;">
        <span class="relative z-10 inline-block px-8 py-3 bg-emerald-700 text-white font-bold text-3xl rounded-lg shadow-lg">YEAR</span>
    </div>
    
    <!-- Month Item (for calculations, outside of visible flow) -->
    <div id="month-item-template" class="month-item flex flex-col" style="visibility: hidden; position: absolute; z-index: -10;">
        <div class="timeline-dot"></div>
        <div class="month-card z-10 bg-white p-6 rounded-lg shadow-md border border-gray-200">
            <h3 class="font-bold text-xl text-emerald-600">MONTH</h3>
            <div class="month-content mt-2">
                <p class="text-gray-500 italic text-base">No notes added yet.</p>
            </div>
            <div class="month-buttons mt-3 flex">
                <button class="btn-add px-4 py-2 bg-emerald-100 text-emerald-700 text-base font-medium rounded-md hover:bg-emerald-200 transition-colors">
                    Add Info
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // --- PART 2: Updated Auth Imports ---
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // -------------------------------------
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection,
            query,
            setLogLevel,
            where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES ---
        
        // --- PART 2: YOUR FIREBASE CONFIG IS NOW HERE ---
        const firebaseConfig = {
          apiKey: "AIzaSyBb8Wnm_8Su5SYR4SwyrJOzC-Yl3Sd5DM4",
          authDomain: "timeline-715a5.firebaseapp.com",
          projectId: "timeline-715a5",
          storageBucket: "timeline-715a5.firebasestorage.app",
          messagingSenderId: "396178765786",
          appId: "1:396178765786:web:fbf38fe8b12a11fbf872e3",
          measurementId: "G-6FQS8Q2WZ5"
        };
        // --------------------------------------------------


        // Firebase services
        let app, auth, db;
        
        // App state
        let userId = null;
        let isAuthReady = false;
        
        // --- Timeline State ---
        let timelineEventsRef = null;
        let unsubscribeTimeline = null; 

        // --- Context Bar State ---
        let contextEventsRef = null;
        let unsubscribeContext = null;
        let allContextData = [];
        
        // --- New Sidebar State ---
        let summariesRef = null;
        let keyFiguresRef = null;
        let unsubscribeSummaries = null;
        let unsubscribeKeyFigures = null;
        let allSummaries = new Map(); // Map<year, summaryText>
        let allKeyFigures = []; // Array of figure objects
        let currentActiveYear = '1947'; // Default year

        // Constants
        const MONTHS = [
            "January", "February", "March", "April", "May", "June", 
            "July", "August", "September", "October", "November", "December"
        ];
        const START_YEAR = 1947;
        const END_YEAR = 1951;
        
        let DAY_OPTIONS_HTML = ''; // Will be populated once

        // DOM Elements
        const timelineContainer = document.getElementById('timeline-container');
        const userInfo = document.getElementById('userInfo');
        const modal = document.getElementById('infoModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalSubTitle = document.getElementById('modalSubTitle');
        const modalForm = document.getElementById('infoForm');
        const modalYear = document.getElementById('modalYear');
        const modalMonth = document.getElementById('modalMonth');
        const modalDocId = document.getElementById('modalDocId');
        const notesContainer = document.getElementById('notesContainer');
        const addNoteEntryBtn = document.getElementById('addNoteEntry');
        const modalCancel = document.getElementById('modalCancel');
        
        const modalEventType = document.getElementById('modalEventType');
        const modalDurationFields = document.getElementById('modalDurationFields');
        const modalEventTitle = document.getElementById('modalEventTitle');
        const modalEventColorWrapper = document.getElementById('modalEventColorWrapper');
        const modalEventColor = document.getElementById('modalEventColor');
        const colorPreview = document.getElementById('colorPreview');

        const manageContextBtn = document.getElementById('manageContextBtn');
        const contextToggle = document.getElementById('contextToggle');
        const contextBarContainer = document.getElementById('context-bar-container');
        const contextModal = document.getElementById('contextModal');
        const contextForm = document.getElementById('contextForm');
        const contextModalClose = document.getElementById('contextModalClose');
        const contextList = document.getElementById('contextList');
        const contextRole = document.getElementById('contextRole');
        const contextName = document.getElementById('contextName');
        const contextStartYear = document.getElementById('contextStartYear');
        const contextStartMonth = document.getElementById('contextStartMonth');
        const contextStartDay = document.getElementById('contextStartDay');
        const contextEndYear = document.getElementById('contextEndYear');
        const contextEndMonth = document.getElementById('contextEndMonth');
        const contextEndDay = document.getElementById('contextEndDay');
        const contextColor = document.getElementById('contextColor');
        
        const tagFilterInput = document.getElementById('tagFilter');
        
        // --- New Sidebar DOM Elements ---
        const sidebarYear = document.getElementById('sidebar-year');
        const summaryTextarea = document.getElementById('summary-textarea');
        const saveSummaryBtn = document.getElementById('save-summary-btn');
        const addFigureBtn = document.getElementById('add-figure-btn');
        const keyFiguresContainer = document.getElementById('key-figures-container');
        const keyFiguresPlaceholder = document.getElementById('key-figures-placeholder');
        
        // --- New Figure Modal DOM Elements ---
        const figureModal = document.getElementById('figureModal');
        const figureForm = document.getElementById('figureForm');
        const figureModalYear = document.getElementById('figure-modal-year');
        const figureYearHidden = document.getElementById('figure-year-hidden');
        const figureName = document.getElementById('figureName');
        const figureImageUrl = document.getElementById('figureImageUrl');
        const figurePreview = document.getElementById('figure-preview');
        const figureDescription = document.getElementById('figureDescription');
        const figureModalCancel = document.getElementById('figure-modal-cancel');
        
        // --- New Auth DOM Elements ---
        const loginOverlay = document.getElementById('login-overlay');
        const loginBtn = document.getElementById('login-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const mainAppContent = document.querySelector('.main-app-content');
 
        // --- INITIALIZATION ---
 
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug'); // Enable detailed logs
                
                // Pre-generate day options
                let dayOptions = '<option value="">Day?</option>';
                for (let d = 1; d <= 31; d++) {
                    dayOptions += `<option value="${d}">${d}</option>`;
                }
                DAY_OPTIONS_HTML = dayOptions;


                // Render the static timeline structure
                renderTimelineStructure();

                // Set up authentication
                setupAuth();
                
                // Set up global event listeners
                setupEventListeners();
                
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                userInfo.textContent = "Error: Could not connect to services.";
            }
        });

        /**
         * Sets up Firebase authentication and listens for state changes.
         */
        async function setupAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // --- User is SIGNED IN ---
                    userId = user.uid;
                    isAuthReady = true;
                    userInfo.textContent = `Signed in as: ${user.displayName || user.email}`;
                    
                    // --- PART 2: Update database paths ---
                    timelineEventsRef = collection(db, 'users', userId, 'timeline_events');
                    contextEventsRef = collection(db, 'users', userId, 'political_context');
                    summariesRef = collection(db, 'users', userId, 'year_summaries');
                    keyFiguresRef = collection(db, 'users', userId, 'key_figures');
                    // ------------------------------------

                    await addInitialData();

                    // --- Start all data listeners ---
                    listenForTimelineData();
                    listenForContextData();
                    listenForSummaries();
                    listenForKeyFigures();
                    // --------------------------------
                    
                    // Show the app, hide the login
                    mainAppContent.style.display = 'block';
                    loginOverlay.style.display = 'none';

                } else {
                    // --- User is SIGNED OUT ---
                    userId = null;
                    isAuthReady = false;
                    userInfo.textContent = "Please sign in.";
                    
                    // Stop all listeners
                    if (unsubscribeTimeline) unsubscribeTimeline();
                    if (unsubscribeContext) unsubscribeContext();
                    if (unsubscribeSummaries) unsubscribeSummaries();
                    if (unsubscribeKeyFigures) unsubscribeKeyFigures();
                    
                    // Hide the app, show the login
                    mainAppContent.style.display = 'none';
                    loginOverlay.style.display = 'flex';
                }
            });
            
            // --- PART 2: New Sign-in Logic ---
            loginBtn.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                    // onAuthStateChanged will handle the rest
                } catch (error) {
                    console.error("Error during sign-in:", error);
                    userInfo.textContent = "Sign-in failed. Please try again.";
                }
            });
            
            // --- PART 2: New Sign-out Logic ---
            signOutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    // onAuthStateChanged will handle the rest
                } catch (error) {
                    console.error("Error during sign-out:", error);
                }
            });
        }
        
        /**
         * Checks if initial data exists and adds it if not.
         * This ensures the user sees an example entry on first load.
         */
        async function addInitialData() {
            if (!timelineEventsRef) return;
            
            const flagDocRef = doc(timelineEventsRef, 'init_flag');
            
            try {
                const flagDoc = await getDoc(flagDocRef);
                if (!flagDoc.exists()) {
                    // New "notes object" format
                    await addDoc(timelineEventsRef, {
                        year: 1947,
                        month: "August",
                        info: [
                            { day: "14", note: "Pakistan becomes an independent dominion.", tag: "partition" },
                            { day: "15", note: "Partition of British India. East Bengal becomes part of Pakistan.", tag: "partition" }
                        ],
                        eventType: "single"
                    });
                    
                    await setDoc(flagDocRef, { initialized: true });
                }
            } catch (error) {
                console.error("Error checking/adding initial data:", error);
            }
        }

        /**
         * Renders the static HTML structure of the timeline (years, months).
         * Data will be populated separately.
         */
        function renderTimelineStructure() {
            timelineContainer.innerHTML = ''; // Clear existing
            
            timelineContainer.innerHTML = '<div id="context-bar-container"></div>';

            // Get templates
            const yearTemplate = document.getElementById('year-block-template').innerHTML;
            const monthTemplate = document.getElementById('month-item-template').innerHTML;

            for (let year = START_YEAR; year <= END_YEAR; year++) {
                const yearHeader = document.createElement('div');
                yearHeader.className = 'year-block text-center';
                yearHeader.dataset.year = year; // <-- Important for IntersectionObserver
                yearHeader.innerHTML = yearTemplate.replace('YEAR', year);
                timelineContainer.appendChild(yearHeader);

                MONTHS.forEach(month => {
                    const monthItem = document.createElement('div');
                    monthItem.className = 'month-item flex flex-col';
                    monthItem.id = `month-item-${year}-${month}`; 
                    monthItem.dataset.year = year;
                    monthItem.dataset.month = month;
                    
                    // Populate template
                    let monthHtml = monthTemplate.replace('MONTH', month);
                    monthHtml = monthHtml.replace(/content-template/g, `content-${year}-${month}`);
                    monthHtml = monthHtml.replace(/buttons-template/g, `buttons-${year}-${month}`);
                    monthHtml = monthHtml.replace(/data-year-template/g, `data-year="${year}"`);
                    monthHtml = monthHtml.replace(/data-month-template/g, `data-month="${month}"`);
                    
                    monthItem.innerHTML = monthHtml;
                    timelineContainer.appendChild(monthItem);
                });
            }
            
            populateContextDateDropdowns();
            
            // After rendering, set up the observer
            observeYearHeaders();
        }

        /**
         * Populates the date dropdowns in the context modal.
         */
        function populateContextDateDropdowns() {
            const yearOptions = [];
            for (let y = START_YEAR; y <= END_YEAR; y++) {
                yearOptions.push(`<option value="${y}">${y}</option>`);
            }
            const monthOptions = MONTHS.map(m => `<option value="${m}">${m}</option>`);
            
            const dayOptions = [];
            for (let d = 1; d <= 31; d++) {
                dayOptions.push(`<option value="${d}">${d}</option>`);
            }

            const yearOptionsHtml = yearOptions.join('');
            const monthOptionsHtml = monthOptions.join('');
            const dayOptionsHtml = dayOptions.join('');
            
            contextStartYear.innerHTML = yearOptionsHtml;
            contextEndYear.innerHTML = yearOptionsHtml;
            contextStartMonth.innerHTML = monthOptionsHtml;
            contextEndMonth.innerHTML = monthOptionsHtml;
            contextStartDay.innerHTML = dayOptionsHtml;
            contextEndDay.innerHTML = dayOptionsHtml;
            
            contextStartYear.value = START_YEAR;
            contextStartMonth.value = "January";
            contextStartDay.value = 1;
            contextEndYear.value = END_YEAR;
            contextEndMonth.value = "December";
            contextEndDay.value = 31;
        }
 
        // --- DATA LISTENER FUNCTIONS ---

        /**
         * Listens for real-time data from Firestore and updates the UI.
         */
        function listenForTimelineData() {
            if (!isAuthReady || !timelineEventsRef) return;
            if (unsubscribeTimeline) unsubscribeTimeline();

            const q = query(timelineEventsRef);
            
            unsubscribeTimeline = onSnapshot(q, (snapshot) => {
                resetAllMonthItems();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    
                    if (id === 'init_flag') return;

                    const { year, month, info } = data;
                    
                    const contentEl = document.getElementById(`content-${year}-${month}`);
                    const buttonsEl = document.getElementById(`buttons-${year}-${month}`);
                    const monthItemEl = document.getElementById(`month-item-${year}-${month}`);
                    
                    if (contentEl && buttonsEl && monthItemEl) {
                        monthItemEl.dataset.id = id;
                        
                        let infoContent = '';
                        let hasNotes = false;
                        
                        if (Array.isArray(info) && info.length > 0) {
                            const noteItems = info.map(noteData => {
                                let noteObj = {};
                                // Handle backward compatibility
                                if (typeof noteData === 'string') {
                                    noteObj = { note: noteData, day: '', tag: '' };
                                } else {
                                    noteObj = noteData;
                                }

                                const dayHtml = noteObj.day ? `<span class="note-day">${noteObj.day}: </span>` : '';
                                const tagHtml = noteObj.tag ? `<span class="note-tag">#${escapeHTML(noteObj.tag)}</span>` : '';
                                const tagDataAttr = noteObj.tag ? `data-tag="${escapeHTML(noteObj.tag.toLowerCase())}"` : '';

                                return `<li class="month-note-item" ${tagDataAttr}>
                                    ${dayHtml}${escapeHTML(noteObj.note)} ${tagHtml}
                                </li>`;
                            }).join('');
                            
                            infoContent = `<ul class="space-y-2">${noteItems}</ul>`;
                            hasNotes = true;
                        } 
                        
                        if (hasNotes) {
                            contentEl.innerHTML = infoContent;
                            monthItemEl.classList.add('has-data'); // Mark as having data
                        } else {
                            contentEl.innerHTML = `<p class="text-gray-500 italic text-base">No notes added yet.</p>`;
                            monthItemEl.classList.remove('has-data'); // No notes, so no data
                        }

                        if (data.eventType === 'start' || data.eventType === 'end') {
                            contentEl.innerHTML += `
                                <span class="mt-2 inline-block text-xs font-medium px-2 py-0.5 rounded
                                    ${data.eventType === 'start' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}">
                                    ${data.eventType === 'start' ? 'Start' : 'End'}: ${escapeHTML(data.eventTitle)}
                                </span>
                            `;
                             monthItemEl.classList.add('has-data'); // Duration counts as data
                        }

                        buttonsEl.innerHTML = `
                            <button class="btn-edit px-4 py-2 bg-blue-100 text-blue-700 text-base font-medium rounded-md hover:bg-blue-200 transition-colors"
                                    data-year="${year}" data-month="${month}" data-id="${id}">
                                Edit
                            </button>
                            <button class="btn-delete ml-2 px-4 py-2 bg-red-100 text-red-700 text-base font-medium rounded-md hover:bg-red-200 transition-colors"
                                    data-id="${id}">
                                Delete
                            </button>
                        `;
                    }
                });
                
                applyTagFilter();
                renderDurationSpans(snapshot);
                updateYearBlockVisibility(document.getElementById('compactToggle').checked);
                renderContextBars();

            }, (error) => {
                console.error("Error with onSnapshot:", error);
            });
        }
        
        /**
         * Listens for real-time context data from Firestore.
         */
        function listenForContextData() {
            if (!isAuthReady || !contextEventsRef) return;
            if (unsubscribeContext) unsubscribeContext();

            const q = query(contextEventsRef);
            
            unsubscribeContext = onSnapshot(q, (snapshot) => {
                allContextData = [];
                snapshot.forEach(doc => {
                    allContextData.push({ id: doc.id, ...doc.data() });
                });
                
                allContextData.sort((a, b) => {
                    if (a.startYear !== b.startYear) return a.startYear - b.startYear;
                    const monthIndexA = MONTHS.indexOf(a.startMonth);
                    const monthIndexB = MONTHS.indexOf(b.startMonth);
                    if (monthIndexA !== monthIndexB) return monthIndexA - monthIndexB;
                    return (a.startDay || 1) - (b.startDay || 1);
                });
 
                renderContextListInModal();
                renderContextBars();
            }, (error) => {
                console.error("Error with context onSnapshot:", error);
            });
        }
        
        /**
         * Listens for yearly summaries data.
         */
        function listenForSummaries() {
            if (!isAuthReady || !summariesRef) return;
            if (unsubscribeSummaries) unsubscribeSummaries();
            
            unsubscribeSummaries = onSnapshot(summariesRef, (snapshot) => {
                allSummaries.clear();
                snapshot.forEach(doc => {
                    allSummaries.set(doc.id, doc.data().summaryText); // doc.id is the year
                });
                // Update sidebar for the currently active year
                updateSidebarContent(currentActiveYear);
            });
        }
        
        /**
         * Listens for key figures data.
         */
        function listenForKeyFigures() {
            if (!isAuthReady || !keyFiguresRef) return;
            if (unsubscribeKeyFigures) unsubscribeKeyFigures();
            
            // This listener gets all figures. We filter by year in the update function.
            const q = query(keyFiguresRef);
            unsubscribeKeyFigures = onSnapshot(q, (snapshot) => {
                allKeyFigures = [];
                snapshot.forEach(doc => {
                    allKeyFigures.push({ id: doc.id, ...doc.data() });
                });
                // Update sidebar for the currently active year
                updateSidebarContent(currentActiveYear);
            });
        }

        // --- RENDER/UPDATE FUNCTIONS ---

        /**
         * Draws the visual span bars on the timeline for duration events.
         */
        function renderDurationSpans(snapshot) {
            document.querySelectorAll('.duration-span').forEach(el => el.remove());
            const spansMap = new Map();

            snapshot.forEach(doc => {
                const data = doc.data();
                const { eventType, eventTitle, eventColor, year, month } = data;
                if (!eventTitle || (eventType !== 'start' && eventType !== 'end')) return;
                
                const monthItemEl = document.getElementById(`month-item-${year}-${month}`);
                if (!monthItemEl) return;
                
                const dotEl = monthItemEl.querySelector('.timeline-dot');
                if (!dotEl) return;

                const top = monthItemEl.offsetTop + dotEl.offsetTop;

                if (!spansMap.has(eventTitle)) {
                    spansMap.set(eventTitle, {});
                }
                if (eventType === 'start') {
                    spansMap.get(eventTitle).startTop = top;
                    spansMap.get(eventTitle).color = eventColor || '#cbd5e1';
                    spansMap.get(eventTitle).title = eventTitle;
                } else if (eventType === 'end') {
                    spansMap.get(eventTitle).endTop = top;
                }
            });

            const allSpans = Array.from(spansMap.values())
                .filter(s => s.startTop !== undefined && s.endTop !== undefined && s.endTop > s.startTop)
                .sort((a, b) => a.startTop - b.startTop);

            const activeLanes = []; 
            for (const span of allSpans) {
                let foundLane = false;
                for (let i = 0; i < activeLanes.length; i++) {
                    if (span.startTop >= activeLanes[i]) {
                        activeLanes[i] = span.endTop;
                        span.lane = i;
                        foundLane = true;
                        break;
                    }
                }
                if (!foundLane) {
                    span.lane = activeLanes.length;
                    activeLanes.push(span.endTop);
                }
            }

            const barWidthPx = 8;
            const barGapPx = 2;
            const initialOffsetFromMainLinePx = 4;

            for (const span of allSpans) {
                const totalOffsetForThisLane = initialOffsetFromMainLinePx + (span.lane * (barWidthPx + barGapPx));
                const height = span.endTop - span.startTop;

                const spanBar = document.createElement('div');
                spanBar.className = 'duration-span';
                spanBar.style.backgroundColor = span.color;
                spanBar.style.top = `${span.startTop}px`;
                spanBar.style.height = `${height}px`;
                spanBar.style.width = `${barWidthPx}px`;
                spanBar.style.transform = `translateX(calc(-100% - ${totalOffsetForThisLane}px))`;
                spanBar.title = span.title; // Show title on hover
                timelineContainer.appendChild(spanBar);
            }
        }

        /**
         * Renders the vertical context bars on the timeline.
         */
        function renderContextBars() {
            const contextBarContainer = document.getElementById('context-bar-container');
            if (!contextBarContainer) return;
            contextBarContainer.innerHTML = '';
            
            const rolesMap = new Map();
            allContextData.forEach(item => {
                if (!rolesMap.has(item.role)) {
                    rolesMap.set(item.role, []);
                }
                rolesMap.get(item.role).push(item);
            });

            const laneWidth = 12;
            const laneGap = 16;
            let laneIndex = 0;

            rolesMap.forEach((segments, role) => {
                const laneOffset = laneIndex * (laneWidth + laneGap);
                
                const laneEl = document.createElement('div');
                laneEl.className = 'context-bar-lane';
                laneEl.style.left = `${laneOffset}px`;
                
                const legendEl = document.createElement('div');
                legendEl.className = 'context-bar-legend';
                legendEl.textContent = role;
                laneEl.appendChild(legendEl);

                segments.forEach(segment => {
                    const startEl = document.getElementById(`month-item-${segment.startYear}-${segment.startMonth}`);
                    const endEl = document.getElementById(`month-item-${segment.endYear}-${segment.endMonth}`);
                    
                    if (!startEl || !endEl) return;

                    const startDot = startEl.querySelector('.timeline-dot');
                    const endDot = endEl.querySelector('.timeline-dot');
                    
                    if (!startDot || !endDot) return;

                    const startTop = startEl.offsetTop + startDot.offsetTop;
                    const endTop = endEl.offsetTop + endDot.offsetTop;
                    const height = endTop - startTop;

                    if (height < 0) return;

                    const segmentEl = document.createElement('div');
                    segmentEl.className = 'context-bar-segment';
                    segmentEl.style.backgroundColor = segment.color;
                    segmentEl.style.top = `${startTop}px`;
                    segmentEl.style.height = `${height}px`;
                    segmentEl.title = `${role}: ${segment.name}\n(${segment.startDay || ''} ${segment.startMonth} ${segment.startYear} - ${segment.endDay || ''} ${segment.endMonth} ${segment.endYear})`;
                    
                    laneEl.appendChild(segmentEl);
                });
                
                contextBarContainer.appendChild(laneEl);
                laneIndex++;
            });
        }

        /**
         * Renders the list of context items in the management modal.
         */
        function renderContextListInModal() {
            if (allContextData.length === 0) {
                contextList.innerHTML = `<p class="text-gray-500 italic text-base">No context eras added yet.</p>`;
                return;
            }

            contextList.innerHTML = allContextData.map(item => `
                <div class="flex items-center justify-between p-3 bg-white border rounded-md">
                    <div class="flex-1">
                        <span class="font-medium text-base" style="color: ${item.color};"> ${escapeHTML(item.role)}:</span>
                        <span class="text-gray-700 text-base">${escapeHTML(item.name)}</span>
                        <span class="text-sm text-gray-500 block">
                            (${item.startDay || ''} ${item.startMonth} ${item.startYear} - ${item.endDay || ''} ${item.endMonth} ${item.endYear})
                        </span>
                    </div>
                    <button class="btn-delete-context ml-4 px-4 py-2 bg-red-100 text-red-700 text-base font-medium rounded-md hover:bg-red-200 transition-colors"
                            data-id="${item.id}">
                        Delete
                    </button>
                </div>
            `).join('');
        }
        
        /**
         * Resets all month items to their default "empty" state.
         */
        function resetAllMonthItems() {
            document.querySelectorAll('.month-item').forEach(item => {
                const { year, month } = item.dataset;
                if (!year || !month) return;
                
                const contentEl = document.getElementById(`content-${year}-${month}`);
                const buttonsEl = document.getElementById(`buttons-${year}-${month}`);
                
                if (contentEl) {
                    contentEl.innerHTML = `<p class="text-gray-500 italic text-base">No notes added yet.</p>`;
                }
                if (buttonsEl) {
                    buttonsEl.innerHTML = `
                        <button class="btn-add px-4 py-2 bg-emerald-100 text-emerald-700 text-base font-medium rounded-md hover:bg-emerald-200 transition-colors"
                                data-year="${year}" data-month="${month}">
                            Add Info
                        </button>
                    `;
                }
                delete item.dataset.id;
                item.classList.remove('has-data');
                item.classList.remove('filtered-out'); // Reset filter
            });
            // Reset all note items
            document.querySelectorAll('.month-note-item').forEach(note => {
                note.classList.remove('filtered-out');
            });
        }
        
        /**
         * Updates the content of the sticky sidebar based on the active year.
         */
        function updateSidebarContent(year) {
            if (!year) return;
            
            // 1. Update Title
            sidebarYear.textContent = year;
            
            // 2. Update Summary Textarea
            const summary = allSummaries.get(year) || '';
            summaryTextarea.value = summary;
            
            // 3. Update Key Figures
            keyFiguresContainer.innerHTML = ''; // Clear existing
            const figuresForYear = allKeyFigures.filter(fig => fig.year == year);
            
            if (figuresForYear.length === 0) {
                keyFiguresContainer.appendChild(keyFiguresPlaceholder);
                keyFiguresPlaceholder.style.display = 'block';
            } else {
                keyFiguresPlaceholder.style.display = 'none';
                figuresForYear.forEach(fig => {
                    const figEl = document.createElement('div');
                    figEl.className = 'figure-item relative group';
                    figEl.title = escapeHTML(fig.description); // Description on hover
                    
                    figEl.innerHTML = `
                        <img src="${escapeHTML(fig.imageUrl)}" alt="${escapeHTML(fig.name)}" class="w-full h-24 object-cover rounded-md border" onerror="this.src='https://placehold.co/100x100?text=Image'">
                        <p class="text-sm text-center font-medium truncate mt-1">${escapeHTML(fig.name)}</p>
                        <button class="btn-delete-figure bg-red-600 text-white" data-id="${fig.id}">
                            &times;
                        </button>
                    `;
                    keyFiguresContainer.appendChild(figEl);
                });
            }
        }
        
        // --- EVENT LISTENER SETUP ---

        /**
         * Sets up global event listeners for buttons and modal.
         */
        function setupEventListeners() {
            // --- Timeline Listeners ---
            timelineContainer.addEventListener('click', (e) => {
                const target = e.target;
                
                if (target.classList.contains('btn-add')) {
                    const { year, month } = target.dataset;
                    openModalForAdd(year, month);
                } 
                else if (target.classList.contains('btn-edit')) {
                    const { year, month, id } = target.dataset;
                    openModalForEdit(year, month, id);
                }
                else if (target.classList.contains('btn-delete')) {
                    const { id } = target.dataset;
                    handleDelete(id);
                }
            });
            
            // --- Header Listeners ---
            compactToggle.addEventListener('change', () => {
                const isChecked = compactToggle.checked;
                timelineContainer.classList.toggle('compact-view', isChecked);
                updateYearBlockVisibility(isChecked);
                renderContextBars(); 
            });
            
            contextToggle.addEventListener('change', () => {
                timelineContainer.classList.toggle('show-context', contextToggle.checked);
            });
            
            manageContextBtn.addEventListener('click', () => {
                contextModal.showModal();
            });
            
            tagFilterInput.addEventListener('input', applyTagFilter);

            // --- Notes Modal Listeners ---
            modalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleSave();
            });
            modalCancel.addEventListener('click', () => modal.close());
            modalEventType.addEventListener('change', () => {
                const type = modalEventType.value;
                modalDurationFields.classList.toggle('hidden', type === 'single');
                modalEventColorWrapper.classList.toggle('hidden', type !== 'start');
                colorPreview.style.display = (type === 'start') ? 'inline-block' : 'none';
            });
            modalEventColor.addEventListener('input', () => {
                colorPreview.style.backgroundColor = modalEventColor.value;
            });
            addNoteEntryBtn.addEventListener('click', () => createNoteEntry());
            notesContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-remove-note')) {
                    e.target.closest('.note-entry-group').remove();
                }
            });
            
            // --- Context Modal Listeners ---
            contextModalClose.addEventListener('click', () => contextModal.close());
            contextForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleSaveContext();
            });
            contextList.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-delete-context')) {
                    const id = e.target.dataset.id;
                    handleDeleteContext(id);
                }
            });
            
            // --- New Sidebar Listeners ---
            saveSummaryBtn.addEventListener('click', handleSaveSummary);
            addFigureBtn.addEventListener('click', handleAddFigure);
            keyFiguresContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-delete-figure')) {
                    const id = e.target.dataset.id;
                    handleDeleteFigure(id);
                }
            });
            
            // --- New Figure Modal Listeners ---
            figureModalCancel.addEventListener('click', () => figureModal.close());
            figureForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleSaveFigure();
            });
            figureImageUrl.addEventListener('input', () => {
                figurePreview.src = figureImageUrl.value || 'https://placehold.co/100x100?text=Preview';
            });
        }
        
        /**
         * Sets up the IntersectionObserver to watch year headers.
         */
        function observeYearHeaders() {
            const observerOptions = {
                root: null, // viewport
                rootMargin: '-50% 0px -50% 0px', // Triggers when the header is in the middle of the screen
                threshold: 0
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const year = entry.target.dataset.year;
                        if (year && year !== currentActiveYear) {
                            currentActiveYear = year;
                            updateSidebarContent(year);
                        }
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.year-block').forEach(header => {
                observer.observe(header);
            });
        }
        
        
        // --- MODAL/FORM HANDLER FUNCTIONS ---

        /**
         * Creates a new blank note entry field in the modal.
         */
        function createNoteEntry(note = { note: '', day: '', tag: '' }) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'note-entry-group p-4 border rounded-md bg-white shadow-sm';
            entryDiv.innerHTML = `
                <textarea class="note-text-input w-full p-3 text-base border border-gray-300 rounded-md" rows="2" placeholder="Enter note...">${escapeHTML(note.note)}</textarea>
                <div class="flex items-center space-x-2 mt-2">
                    <select class="note-day-input p-3 text-base border border-gray-300 rounded-md">
                        ${DAY_OPTIONS_HTML}
                    </select>
                    <input type="text" class="note-tag-input w-full p-3 text-base border border-gray-300 rounded-md" placeholder="Tag (optional)" value="${escapeHTML(note.tag)}">
                    <button type="button" class="btn-remove-note px-3 py-2 bg-red-100 text-red-700 text-sm font-medium rounded-md hover:bg-red-200">
                        Remove
                    </button>
                </div>
            `;
            // Set the selected day
            entryDiv.querySelector('.note-day-input').value = note.day;
            notesContainer.appendChild(entryDiv);
        }
        
        /**
         * Opens the modal to add a new note.
         */
        function openModalForAdd(year, month) {
            modalTitle.textContent = "Add Information";
            modalSubTitle.textContent = `Year ${year}, ${month}`;
            modalYear.value = year;
            modalMonth.value = month;
            modalDocId.value = "";
            
            notesContainer.innerHTML = '';
            createNoteEntry(); 
            
            modalEventType.value = "single";
            modalEventTitle.value = "";
            modalEventColor.value = "#3b82f6";
            colorPreview.style.backgroundColor = "#3b82f6";
            modalDurationFields.classList.add('hidden');
            colorPreview.style.display = 'none';

            modal.showModal();
        }
        
        /**
         * Opens the modal to edit an existing note.
         */
        async function openModalForEdit(year, month, docId) {
            if (!docId || !timelineEventsRef) return;
            
            const docRef = doc(timelineEventsRef, docId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    modalTitle.textContent = "Edit Information";
                    modalSubTitle.textContent = `Year ${year}, ${month}`;
                    modalYear.value = year;
                    modalMonth.value = month;
                    modalDocId.value = docId;
                    
                    notesContainer.innerHTML = ''; 
                    const info = data.info || [];
                    
                    if (Array.isArray(info) && info.length > 0) {
                        info.forEach(noteData => {
                            if (typeof noteData === 'string') {
                                createNoteEntry({ note: noteData, day: '', tag: '' });
                            } else {
                                createNoteEntry(noteData);
                            }
                        });
                    } else {
                        createNoteEntry();
                    }
                    
                    modalEventType.value = data.eventType || "single";
                    modalEventTitle.value = data.eventTitle || "";
                    modalEventColor.value = data.eventColor || "#3b82f6";
                    
                    const type = modalEventType.value;
                    modalDurationFields.classList.toggle('hidden', type === 'single');
                    modalEventColorWrapper.classList.toggle('hidden', type !== 'start');
                    colorPreview.style.display = (type === 'start') ? 'inline-block' : 'none';

                    modal.showModal();
                } else {
                    console.error("No such document to edit!");
                }
            } catch (error) {
                console.error("Error fetching document for edit:", error);
            }
        }
        
        /**
         * Opens the modal to add a new key figure.
         */
        function handleAddFigure() {
            figureModalYear.textContent = currentActiveYear;
            figureYearHidden.value = currentActiveYear;
            figureForm.reset();
            figurePreview.src = 'https://placehold.co/100x100?text=Preview';
            figureModal.showModal();
        }

        // --- DATABASE SAVE/DELETE FUNCTIONS ---

        /**
         * Handles saving a new context era.
         */
        async function handleSaveContext() {
            if (!contextEventsRef) return;

            const dataToSave = {
                role: contextRole.value.trim(),
                name: contextName.value.trim(),
                startYear: parseInt(contextStartYear.value),
                startMonth: contextStartMonth.value,
                startDay: parseInt(contextStartDay.value),
                endYear: parseInt(contextEndYear.value),
                endMonth: contextEndMonth.value,
                endDay: parseInt(contextEndDay.value),
                color: contextColor.value
            };
 
            if (!dataToSave.role || !dataToSave.name) return;
            
            const startMonthIndex = MONTHS.indexOf(dataToSave.startMonth);
            const endMonthIndex = MONTHS.indexOf(dataToSave.endMonth);
 
            if (dataToSave.startYear > dataToSave.endYear || 
                (dataToSave.startYear === dataToSave.endYear && startMonthIndex > endMonthIndex) ||
                (dataToSave.startYear === dataToSave.endYear && startMonthIndex === endMonthIndex && dataToSave.startDay > dataToSave.endDay)) {
                console.error("Start date must be before end date.");
                return;
            }
            
            try {
                await addDoc(contextEventsRef, dataToSave);
                contextForm.reset();
                populateContextDateDropdowns(); // Reset dropdowns to default
            } catch (error) {
                console.error("Error saving context:", error);
            }
        }

        /**
         * Handles deleting a context era.
         */
        async function handleDeleteContext(docId) {
            if (!docId || !contextEventsRef) return;
            try {
                await deleteDoc(doc(contextEventsRef, docId));
            } catch (error) {
                console.error("Error deleting context:", error);
            }
        }


        /**
         * Handles saving data (either new or updated).
         */
        async function handleSave() {
            if (!timelineEventsRef) return;

            const year = modalYear.value;
            const month = modalMonth.value;
            const docId = modalDocId.value;
            const eventType = modalEventType.value;
            const eventTitle = modalEventTitle.value.trim();
            const eventColor = modalEventColor.value;

            const notesData = [];
            const noteEntryElements = notesContainer.querySelectorAll('.note-entry-group');
            
            noteEntryElements.forEach(entry => {
                const noteText = entry.querySelector('.note-text-input').value.trim();
                const day = entry.querySelector('.note-day-input').value;
                const tag = entry.querySelector('.note-tag-input').value.trim();
                
                if (noteText) { // Only save notes that have text
                    notesData.push({ note: noteText, day: day, tag: tag });
                }
            });

            if (notesData.length === 0 && eventType === 'single') {
                console.log("No notes to save.");
            }

            const dataToSave = {
                year: parseInt(year),
                month: month,
                info: notesData, // Save the array of note objects
                eventType: eventType
            };

            if (eventType === 'start' || eventType === 'end') {
                if (!eventTitle) {
                    modalEventTitle.classList.add('border-red-500');
                    setTimeout(() => modalEventTitle.classList.remove('border-red-500'), 2000);
                    return;
                }
                dataToSave.eventTitle = eventTitle;
                if (eventType === 'start') {
                    dataToSave.eventColor = eventColor;
                }
            }

            try {
                if (docId) {
                    await updateDoc(doc(timelineEventsRef, docId), dataToSave);
                } else {
                    await addDoc(timelineEventsRef, dataToSave);
                }
                modal.close();
            } catch (error) {
                console.error("Error saving document:", error);
            }
        }
        
        /**
         * Handles deleting a note.
         */
        async function handleDelete(docId) {
            if (!docId || !timelineEventsRef) return;
            try {
                await deleteDoc(doc(timelineEventsRef, docId));
            } catch (error) {
                console.error("Error deleting document:", error);
            }
        }
        
        /**
         * Saves the summary text for the current active year.
         */
        async function handleSaveSummary() {
            if (!summariesRef || !currentActiveYear) return;
            const summaryText = summaryTextarea.value;
            const docRef = doc(summariesRef, currentActiveYear); // Use year as doc ID
            try {
                await setDoc(docRef, { summaryText: summaryText });
                // Visual feedback
                saveSummaryBtn.textContent = 'Saved!';
                saveSummaryBtn.classList.add('bg-green-500');
                setTimeout(() => {
                    saveSummaryBtn.textContent = 'Save Summary';
                    saveSummaryBtn.classList.remove('bg-green-500');
                }, 2000);
            } catch (e) { 
                console.error("Error saving summary: ", e); 
                saveSummaryBtn.textContent = 'Error!';
                saveSummaryBtn.classList.add('bg-red-500');
                setTimeout(() => {
                    saveSummaryBtn.textContent = 'Save Summary';
                    saveSummaryBtn.classList.remove('bg-red-500');
                }, 2000);
            }
        }
        
        /**
         * Saves a new key figure from the modal.
         */
        async function handleSaveFigure() {
            if (!keyFiguresRef) return;
            
            const dataToSave = {
                year: parseInt(figureYearHidden.value),
                name: figureName.value.trim(),
                imageUrl: figureImageUrl.value.trim(),
                description: figureDescription.value.trim()
            };
            
            if (!dataToSave.name || !dataToSave.imageUrl || !dataToSave.description) {
                console.error("All figure fields are required.");
                return;
            }
            
            try {
                await addDoc(keyFiguresRef, dataToSave);
                figureModal.close();
            } catch (error) {
                console.error("Error saving figure:", error);
            }
        }
        
        /**
         * Deletes a key figure.
         */
        async function handleDeleteFigure(docId) {
            if (!docId || !keyFiguresRef) return;
            try {
                await deleteDoc(doc(keyFiguresRef, docId));
            } catch (error) {
                console.error("Error deleting figure:", error);
            }
        }
        
        // --- FILTERING & VISIBILITY ---

        /**
         * Applies the tag filter to all notes on the timeline.
         */
        function applyTagFilter() {
            const filterText = tagFilterInput.value.toLowerCase().trim();

            if (!filterText) {
                document.querySelectorAll('.month-item').forEach(item => {
                    item.classList.remove('filtered-out');
                });
                document.querySelectorAll('.month-note-item').forEach(note => {
                    note.classList.remove('filtered-out');
                });
                
                updateYearBlockVisibility(document.getElementById('compactToggle').checked);
                return; 
            }
            
            document.querySelectorAll('.month-item').forEach(monthItem => {
                let monthHasVisibleNote = false;
                const noteItems = monthItem.querySelectorAll('.month-note-item');
                
                noteItems.forEach(noteItem => {
                    const tag = noteItem.dataset.tag || '';
                    if (tag.includes(filterText)) { 
                        noteItem.classList.remove('filtered-out');
                        monthHasVisibleNote = true;
                    } else {
                        noteItem.classList.add('filtered-out');
                    }
                });
                
                const hasDurationInfo = monthItem.querySelector('.bg-blue-100, .bg-red-100');

                if (monthHasVisibleNote || (hasDurationInfo && !filterText)) {
                    monthItem.classList.remove('filtered-out');
                } else {
                    monthItem.classList.add('filtered-out');
                }
            });
            
            updateYearBlockVisibility(document.getElementById('compactToggle').checked);
        }
        
        /**
         * Hides or shows year blocks based on whether they have populated months.
         */
        function updateYearBlockVisibility(isCompactView) {
            const yearBlocks = document.querySelectorAll('.year-block');
            
            yearBlocks.forEach(yearBlock => {
                let hasVisibleData = false;
                let nextElement = yearBlock.nextElementSibling;
                
                while (nextElement && !nextElement.classList.contains('year-block')) {
                    if (nextElement.classList.contains('month-item')) {
                        const hasData = nextElement.classList.contains('has-data');
                        const isFiltered = nextElement.classList.contains('filtered-out');
                        
                        if (hasData && !isFiltered) {
                            hasVisibleData = true;
                            break; 
                        }
                    }
                    nextElement = nextElement.nextElementSibling;
                }
                
                if (isCompactView && !hasVisibleData) {
                    yearBlock.classList.add('is-empty');
                } else {
                    yearBlock.classList.remove('is-empty');
                }
            });
        }

        /**
         * Utility to escape HTML for safe rendering.
         */
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                }[m];
            });
        }
        
    </script>
</body>
</html>
