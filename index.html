
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BCS History Timeline</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* Custom styles */

/* NEW: CSS Variables for UI Control */
:root {
/* Global */
font-size: var(--global-scale, 100%); /* Controlled by JS */
--main-gap: var(--layout-gap, 3rem); /* Controlled by JS - New Default */
--global-line-height: var(--line-height, 1.6); /* NEW: Controlled by JS */

/* Timeline */
--timeline-v-spacing: var(--month-spacing, 2rem); /* Controlled by JS */
--timeline-h-padding: 3rem; /* Stays proportional to global scale */
--timeline-year-fs: var(--year-header-fs, 2.25rem); /* Controlled by JS */
--timeline-card-fs: var(--month-card-fs, 1rem); /* Controlled by JS */
--card-padding-y: var(--month-card-pady, 1.5rem); /* NEW */
--card-padding-x: var(--month-card-padx, 1.5rem); /* NEW */

/* Sidebar */
/* NEW: 200% Larger Sidebar Fonts */
--sidebar-title-fs: var(--side-title-fs, 3.75rem); /* 200% of 1.875rem */
--sidebar-body-fs: var(--side-body-fs, 2rem); /* 200% of 1rem */
--sidebar-padding-y: var(--side-pady, 1.5rem); /* NEW */
--sidebar-padding-x: var(--side-padx, 1.5rem); /* NEW */
/* DELETED Sidebar Margin Vars */

/* Modals */
--modal-title-fs: var(--pop-title-fs, 1.875rem); /* Controlled by JS */
--modal-body-fs: var(--pop-body-fs, 1rem); /* Controlled by JS */
--modal-padding-y: var(--pop-pady, 2rem); /* NEW */
--modal-padding-x: var(--pop-padx, 2rem); /* NEW */
}

html {
  scroll-behavior: smooth; /* Enables smooth scrolling for the whole page */
}

body {
/* UPDATED: Font family changed */
font-family: 'Noto Sans', 'Noto Sans Bengali', sans-serif;
background-color: #f4f7f6; /* A very light, calming green-gray */
line-height: var(--global-line-height);
}

/* New Login Overlay */
#login-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: #f4f7f6;
display: flex;
justify-content: center;
align-items: center;
z-index: 100;
}

#login-overlay h1 { font-size: 2.25rem; /* text-4xl */ }
#login-overlay p { font-size: 1.25rem; /* text-xl */ }
#login-overlay button { font-size: 1.125rem; /* text-lg */ padding: 1rem 2rem; }

/* Hide main content by default */
.main-app-content {
display: none;
}

/* The main timeline vertical line */
.timeline-container::before {
content: '';
position: absolute;
top: 0;
left: 50%;
transform: translateX(-50%);
width: 6px; 
height: 100%;
background-color: #cbd5e1; /* slate-300 */
z-index: 2; 
}

/* Styling for each year block */
.year-block {
/* NEW: Sticky Year Header */
position: sticky;
top: 180px; /* Default, will be overridden by JS */
z-index: 45; /* Below header (50) but above sidebar (40) */
padding: 2.5rem 0; 
/* This div is now sticky */
}
.year-block span {
font-size: var(--timeline-year-fs);
/* REMOVED sticky from here */
}

/* DELETED: year-observer-anchor (no longer needed) */

/* Styling for each month's "dot" on the timeline */
.timeline-dot {
position: absolute;
top: 1.125rem; /* Adjusted for larger text */
left: 50%;
transform: translateX(-50%);
width: 24px; 
height: 24px; 
background-color: white;
border: 5px solid #059669; 
border-radius: 50%;
z-index: 5; 
transition: all 0.3s ease;
}

.month-item:hover .timeline-dot {
transform: translateX(-50%) scale(1.1);
border-color: #047857; /* emerald-700 */
}

/* Positioning month items on the left and right */
.month-item {
position: relative;
width: 50%;
padding: 0 var(--timeline-h-padding);
margin-bottom: var(--timeline-v-spacing);
}

.month-card {
padding: var(--card-padding-y) var(--card-padding-x); /* NEW: Controlled by JS */
}

/* Even items on the right */
.month-item:nth-child(even) {
align-self: flex-end;
padding-left: var(--timeline-h-padding);
}

/* Odd items on the left */
.month-item:nth-child(odd) {
align-self: flex-start;
padding-right: var(--timeline-h-padding);
text-align: right;
}

/* Month Card font size */
.month-card, .month-card h3, .month-card p, .month-card li, .month-card button {
font-size: var(--timeline-card-fs);
}
.month-card h3 { font-size: calc(var(--timeline-card-fs) * 1.25); font-weight: 600; } /* Make title slightly bigger */


/* Adjust button alignment for left/right items */
.month-item:nth-child(odd) .month-buttons {
justify-content: flex-end;
}

.month-item:nth-child(even) .month-buttons {
justify-content: flex-start;
}

/* The small horizontal line connecting dot to card */
.month-item::after {
content: '';
position: absolute;
top: 1.375rem; /* Adjusted for dot */
width: var(--timeline-h-padding);
height: 3px; 
background: #cbd5e1; /* slate-300 */
z-index: 2; 
}

.month-item:nth-child(even)::after {
left: 0;
transform: translateX(-100%);
}

.month-item:nth-child(odd)::after {
right: 0;
transform: translateX(100%);
}

/* Modal backdrop */
dialog::backdrop {
background: rgba(0, 0, 0, 0.5);
backdrop-filter: blur(2px);
}

/* Modal font sizes */
dialog h2 { font-size: var(--modal-title-fs); }
dialog h3 { font-size: calc(var(--modal-body-fs) * 1.25); }
dialog h4 { font-size: calc(var(--modal-body-fs) * 1.15); }
dialog p, dialog label, dialog button, dialog input, dialog select, dialog textarea, dialog span {
font-size: var(--modal-body-fs);
}

/* NEW: Modal Padding Control */
#infoModal form { padding: var(--modal-padding-y) var(--modal-padding-x); }
#contextModal > div { padding: var(--modal-padding-y) var(--modal-padding-x); }
#figureModal form { padding: var(--modal-padding-y) var(--modal-padding-x); }
#uiModal > div { padding: var(--modal-padding-y) var(--modal-padding-x); }
#analysisModal > div { padding: var(--modal-padding-y) var(--modal-padding-x); }
/* NEW: Added padding rule for new modal */
#timelineRangeModal form { padding: var(--modal-padding-y) var(--modal-padding-x); }
/* NEW: Added padding rule for manage timelines modal */
#manageTimelinesModal > div { padding: var(--modal-padding-y) var(--modal-padding-x); }


/* Styles for compact view */
.compact-view .month-item {
display: none;
}

/* This rule shows items that have data AND are not filtered out */
.compact-view .month-item.has-data:not(.filtered-out) {
display: flex; 
}

.compact-view .year-block.is-empty {
display: none;
}

/* Styles for tag filtering */
.month-item.filtered-out {
display: none !important; /* Hide month item if all notes are filtered */
}

.month-note-item.filtered-out {
display: none; /* Hide individual note item */
}


/* Style for the duration span bars */
.duration-span {
position: absolute;
left: calc(50% - 3px); /* Adjusted */
transform: translateX(-100%); 
width: 8px; 
z-index: 3; 
opacity: 0.8;
transition: all 0.3s ease;
}

/* I-beam caps */
.duration-span::before,
.duration-span::after {
content: '';
position: absolute;
left: 50%; 
transform: translateX(-50%); 
width: 16px; 
height: 8px; 
background-color: inherit; 
z-index: 4; 
}
.duration-span::before { /* Start cap */
top: 0;
transform: translateX(-50%) translateY(-50%); 
}
.duration-span::after { /* End cap */
bottom: 0;
transform: translateX(-50%) translateY(50%); 
}

/* Color preview in modal */
#colorPreview {
display: inline-block;
width: 28px; 
height: 28px; 
border-radius: 50%;
border: 1px solid #ccc;
vertical-align: middle;
margin-left: 8px;
}

/* Styles for Political Context Bars */
#context-bar-container {
position: absolute;
top: 0;
left: 6px; /* Far left with 6px padding */
height: 100%;
z-index: 1; 
padding-top: 60px; /* Align with first year block */
display: none; /* Hidden by default */
}

/* Show the container when the toggle is active */
.show-context #context-bar-container {
display: block;
}

.context-bar-lane {
position: absolute;
top: 0;
height: 100%;
width: 12px; 
z-index: 1; 
background-color: rgba(200, 200, 200, 0.2);
border-radius: 5px;
}

.context-bar-segment {
position: absolute;
width: 100%;
opacity: 0.6;
transition: opacity 0.3s ease;
border-radius: 2px;
z-index: 2; /* Ensure segment is on top of lane bg */
}

.context-bar-segment:hover {
opacity: 1.0;
}

.context-bar-legend {
position: absolute;
top: 0;
writing-mode: vertical-rl;
transform: rotate(180deg) translateX(100%) translateY(5px);
transform-origin: bottom right;
font-size: 0.875rem; /* text-sm */
font-weight: 600;
color: #555;
padding-bottom: 5px;
white-space: nowrap;
}

/* Styling for multi-note list in card */
.month-content ul {
list-style-type: none;
padding-left: 0;
margin: 0;
space-y: 1;
}
.month-content ul li {
padding: 12px 16px; 
background-color: #f8fafc;
border-radius: 6px;
border: 1px solid #e2e8f0;
text-align: left; /* Ensure list items are left-aligned */
margin-bottom: 8px; 
/* font-size: 1rem; /* text-base */ /* Handled by --timeline-card-fs */
}
.month-content ul li:last-child {
margin-bottom: 0;
}
/* Ensure even in right-aligned cards, the list is readable */
.month-item:nth-child(odd) .month-content ul {
text-align: left;
}

.note-day {
font-weight: 700;
color: #059669; /* emerald-600 */
/* font-size: 1rem; /* text-base */ /* Handled by --timeline-card-fs */
}
.note-tag {
/* font-size: 0.875rem; /* text-sm */ /* Proportional */
font-weight: 500;
color: #4338ca; /* indigo-700 */
background-color: #e0e7ff; /* indigo-100 */
padding: 3px 8px; 
border-radius: 4px;
margin-left: 8px;
}

/* NEW: Sidebar Styles */
#sidebar {
/* DELETED Margin Properties */
z-index: 40; /* NEW: Ensure sidebar is on top */
position: relative; /* NEW: Ensure z-index works */
}

#sidebar-content {
position: sticky;
/* top: 180px; */ /* REMOVED: Set by JS */
padding: var(--sidebar-padding-y) var(--sidebar-padding-x); /* NEW: Controlled by JS */

/* NEW: 200% Width + 40% Overlap */
width: 200%;
transform: translateX(-40%);
z-index: 40;
}

#sidebar-content h2 { font-size: var(--sidebar-title-fs); }
#sidebar-content h3 { font-size: calc(var(--sidebar-body-fs) * 1.25); }
#summary-display, #key-figures-container p, #key-figures-container .figure-item p {
font-size: var(--sidebar-body-fs);
}

#key-figures-container {
max-height: 300px;
overflow-y: auto;
}

/* NEW: Sidebar summary display */
#summary-display {
min-height: 12rem; /* h-48 */
padding: 0.75rem; /* p-3 */
border: 1px solid #e5e7eb; /* border-gray-200 */
border-radius: 0.375rem; /* rounded-md */
background-color: #f9fafb; /* bg-gray-50 */
white-space: pre-wrap; /* Show line breaks */
color: #374151; /* text-gray-700 */
}

/* DELETED btn-delete-figure styles (moved to modal) */

/* DELETED: Figure hover styles. This is now handled by the global tooltip. */
/* .figure-item .figure-description-tooltip { ... } */
/* .figure-item .figure-description-tooltip::after { ... } */
/* .figure-item:hover .figure-description-tooltip { ... } */

/* NEW: UI Modal styles */
#uiModal label {
/* font-size: 1rem; /* text-base */ /* Handled by --modal-body-fs */
font-weight: 500;
}
#uiModal .range-value {
/* font-size: 1rem; */
font-weight: 600;
color: #059669;
}
#uiModal input[type="range"] {
width: 100%;
}

/* NEW: Analysis Modal Styles */
#analysis-figures-list {
max-height: 300px;
overflow-y: auto;
}
</style>
</head>
<body class="antialiased text-gray-800">

<div id="login-overlay">
<div class="text-center p-8 bg-white shadow-xl rounded-lg">
<h1 class="text-4xl font-bold text-emerald-700">BCS History Timeline</h1>
<p class="text-xl text-gray-600 my-4">Please sign in to access your personal study timeline.</p>
<button id="login-btn" class="px-8 py-4 text-lg bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">
Sign in with Google
</button>
</div>
</div>

<div class="main-app-content">
<header class="bg-white shadow-md p-8 sticky top-0 z-50"> <div class="container mx-auto max-w-screen-2xl">
<h1 class="text-4xl font-bold text-emerald-700">BCS History Timeline</h1> <p id="headerFocus" class="text-xl text-gray-600">Focus: 1947 - 1951</p> <div class="flex items-center justify-between mt-4">
<div id="userInfo" class="text-sm text-gray-500 mt-2">Connecting...</div> <div class="flex items-center space-x-4">
<button id="manageTimelinesBtn" class="px-4 py-2 bg-yellow-600 text-white text-base font-medium rounded-md hover:bg-yellow-700 transition-colors">
Manage Timelines
</button>
<button id="createTimelineBtn" class="px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md hover:bg-green-700 transition-colors">
Create Timeline
</button>
<button id="manageUiBtn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md hover:bg-blue-700 transition-colors"> Manage UI
</button>
<button id="manageContextBtn" class="px-4 py-2 bg-gray-600 text-white text-base font-medium rounded-md hover:bg-gray-700 transition-colors"> Manage Context
</button>
<button id="manageAnalysisBtn" class="px-4 py-2 bg-purple-600 text-white text-base font-medium rounded-md hover:bg-purple-700 transition-colors">
Manage Analysis
</button>
<div class="flex items-center space-x-2">
<span class="text-base font-medium text-gray-700">Context</span> <label for="contextToggle" class="relative inline-flex items-center cursor-pointer">
<input type="checkbox" id="contextToggle" class="sr-only peer">
<div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-gray-300 peer-checked:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
</label>
</div>
<div class="flex items-center space-x-2">
<span class="text-base font-medium text-gray-700">Compact</span> <label for="compactToggle" class="relative inline-flex items-center cursor-pointer">
<input type="checkbox" id="compactToggle" class="sr-only peer">
<div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-emerald-300 peer-checked:bg-emerald-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
</label>
</div>
<button id="sign-out-btn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md hover:bg-red-700 transition-colors"> Sign Out
</button>
</div>
</div>
<div class="mt-4">
<input type="text" id="tagFilter" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="Filter by tag (e.g., politics)..."> </div>
</div>
</header>

<main class="container mx-auto max-w-screen-2xl py-16 px-6 grid grid-cols-1 lg:grid-cols-3" style="gap: var(--main-gap);"> <div class="lg:col-span-2">
<div id="timeline-container" class="relative timeline-container">
<div id="context-bar-container">
</div>
</div>
</div>

<aside id="sidebar" class="lg:col-span-1 relative">
<div id="sidebar-content" class="sticky bg-white shadow-lg rounded-lg border border-gray-200"> <h2 class="text-3xl font-bold mb-4">Analysis for <span id="sidebar-year">1947</span></h2> <div>
<h3 class="text-xl font-semibold text-gray-700">My Summary & Analysis</h3> <div id="summary-display" class="w-full h-48 p-3 text-base border rounded-md mt-2 bg-gray-50 whitespace-pre-wrap overflow-y-auto" placeholder="Your 'big picture' analysis for this year..."></div> </div>

<div class="mt-6">
<div class="flex justify-between items-center">
<h3 class="text-xl font-semibold text-gray-700">Key Figures</h3> </div>
<div id="key-figures-container" class="mt-2 grid grid-cols-4 gap-2 p-2 bg-gray-50 rounded-md border">
<p id="key-figures-placeholder" class="text-base text-gray-500 italic col-span-4">No figures added for this year.</p> </div>
</div>
</div>
</aside>
</main>

<footer class="text-center p-8 text-base text-gray-500"> A study tool crafted for your success.
</footer>
</div> <dialog id="manageTimelinesModal" class="p-0 rounded-lg shadow-xl w-full max-w-2xl">
<div class="p-8">
<h2 class="text-3xl font-semibold">Manage Timelines</h2>
<p class="text-lg text-gray-600">Activate or delete your saved timelines.</p>

<div id="manageTimelinesList" class="mt-6 space-y-3 max-h-96 overflow-y-auto p-3 border rounded-md bg-gray-50">
<p class="text-gray-500 italic text-base">Loading timelines...</p>
</div>

<div class="mt-6 flex justify-end">
<button type="button" id="manageTimelinesClose" class="px-6 py-3 text-base bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
Close
</button>
</div>
</div>
</dialog>


<dialog id="timelineRangeModal" class="p-0 rounded-lg shadow-xl w-full max-w-md">
<form id="timelineRangeForm" class="space-y-6">
<div>
<h2 class="text-3xl font-semibold">Create New Timeline</h2>
<p class="text-lg text-gray-600">Set the name and year range for your new timeline.</p>
</div>

<div class="space-y-4">
<div>
<label for="timelineNameInput" class="block text-base font-medium text-gray-700 mb-1">Timeline Name</label>
<input type="text" id="timelineNameInput" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="e.g., BCS Preli Focus" required>
</div>
<div>
<label for="startYearInput" class="block text-base font-medium text-gray-700 mb-1">Start Year</label>
<input type="number" id="startYearInput" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="e.g., 1947" required>
</div>
<div>
<label for="endYearInput" class="block text-base font-medium text-gray-700 mb-1">End Year</label>
<input type="number" id="endYearInput" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="e.g., 1951" required>
</div>
</div>

<div class="mt-6 flex justify-end space-x-3">
<button type="button" id="timelineRangeCancel" class="px-6 py-3 text-base bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
Cancel
</button>
<button type="submit" class="px-6 py-3 text-base bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
Create and Activate
</button>
</div>
</form>
</dialog>


<dialog id="infoModal" class="p-0 rounded-lg shadow-xl w-full max-w-xl"> <form id="infoForm" class="space-y-6"> <div>
<h2 class="text-3xl font-semibold" id="modalTitle">Add Information</h2> <p class="text-lg text-gray-600" id="modalSubTitle">Year 1947, January</p> </div>

<input type="hidden" id="modalYear">
<input type="hidden" id="modalMonth">
<input type="hidden" id="modalDocId">

<div>
<label class="block text-base font-medium text-gray-700 mb-2">Notes:</label> <div id="notesContainer" class="space-y-4 max-h-60 overflow-y-auto p-3 border rounded-md bg-gray-50"> </div>
<button type="button" id="addNoteEntry" class="mt-3 w-full px-4 py-3 bg-emerald-100 text-emerald-700 text-base font-medium rounded-md hover:bg-emerald-200 transition-colors"> + Add Note
</button>
</div>

<div class="p-5 bg-gray-50 rounded-md border border-gray-200 space-y-4"> <h3 class="font-medium text-lg">Event Duration (Optional)</h3> <p class="text-base text-gray-500">Use this to mark a multi-month event, like a war. This is separate from the notes above.</p> <div>
<label for="modalEventType" class="block text-base font-medium text-gray-700 mb-1">Type:</label> <select id="modalEventType" class="w-full p-3 text-base border border-gray-300 rounded-md"> <option value="single" selected>Not a duration event</option>
<option value="start">Start of Event</option>
<option value="end">End of Event</option>
</select>
</div>

<div id="modalDurationFields" class="hidden space-y-4"> <div>
<label for="modalEventTitle" class="block text-base font-medium text-gray-700 mb-1"> Event Title (must be identical for start and end)
</label>
<input type="text" id="modalEventTitle" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="e.g., Language Movement"> </div>

<div id="modalEventColorWrapper">
<label for="modalEventColor" class="inline-block text-base font-medium text-gray-700 mb-1">Event Color:</label> <input type="color" id="modalEventColor" class="w-12 h-10 p-1 border border-gray-300 rounded-md align-middle" value="#3b82f6"> <span id="colorPreview" style="background-color: #3b82f6;"></span>
</div>
</div>
</div>

<div class="mt-6 flex justify-end space-x-3">
<button type="button" id="modalCancel" class="px-6 py-3 text-base bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors"> Cancel
</button>
<button type="submit" id="modalSave" class="px-6 py-3 text-base bg-emerald-600 text-white rounded-md hover:bg-emerald-700 transition-colors"> Save
</button>
</div>
</form>
</dialog>

<dialog id="contextModal" class="p-0 rounded-lg shadow-xl w-full max-w-3xl"> <div class="p-8"> <h2 class="text-3xl font-semibold">Manage Political Context</h2> <p class="text-lg text-gray-600">Add or remove governing eras. These will be shown as vertical bars on the timeline.</p> <form id="contextForm" class="mt-6 p-6 border border-gray-200 rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-2 gap-6"> <h3 class="text-xl font-medium col-span-1 md:col-span-2">Add New Era</h3> <div>
<label for="contextRole" class="block text-base font-medium text-gray-700 mb-1">Role / Title</label> <input type="text" id="contextRole" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="e.g., Governor-General" required> </div>
<div>
<label for="contextName" class="block text-base font-medium text-gray-700 mb-1">Person / Party Name</label> <input type="text" id="contextName" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="e.g., Khawaja Nazimuddin" required> </div>
<div class="grid grid-cols-3 gap-3"> <div>
<label for="contextStartYear" class="block text-base font-medium text-gray-700 mb-1">Start Year</label> <select id="contextStartYear" class="w-full p-3 text-base border border-gray-300 rounded-md" required> </select>
</div>
<div>
<label for="contextStartMonth" class="block text-base font-medium text-gray-700 mb-1">Start Month</label> <select id="contextStartMonth" class="w-full p-3 text-base border border-gray-300 rounded-md" required> </select>
</div>
<div>
<label for="contextStartDay" class="block text-base font-medium text-gray-700 mb-1">Start Day</label> <select id="contextStartDay" class="w-full p-3 text-base border border-gray-300 rounded-md" required> </select>
</div>
</div>
<div class="grid grid-cols-3 gap-3"> <div>
<label for="contextEndYear" class="block text-base font-medium text-gray-700 mb-1">End Year</label> <select id="contextEndYear" class="w-full p-3 text-base border border-gray-300 rounded-md" required> </select>
</div>
<div>
<label for="contextEndMonth" class="block text-base font-medium text-gray-700 mb-1">End Month</label> <select id="contextEndMonth" class="w-full p-3 text-base border border-gray-300 rounded-md" required> </select>
</div>
<div>
<label for="contextEndDay" class="block text-base font-medium text-gray-700 mb-1">End Day</label> <select id="contextEndDay" class="w-full p-3 text-base border border-gray-300 rounded-md" required> </select>
</div>
</div>
<div>
<label for="contextColor" class="block text-base font-medium text-gray-700 mb-1">Bar Color</label> <input type="color" id="contextColor" class="w-full h-12 p-1 border border-gray-300 rounded-md" value="#eab308"> </div>
<div class="flex items-end">
<button type="submit" class="w-full px-6 py-3 text-base bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors"> Save Context Era
</button>
</div>
</form>

<div class="mt-6">
<h3 class="text-xl font-medium">Existing Eras</h3> <div id="contextList" class="mt-2 space-y-3 max-h-60 overflow-y-auto p-3 border rounded-md"> <p class="text-gray-500 italic text-base">No context eras added yet.</p> </div>
</div>

<div class="mt-6 flex justify-end">
<button type="button" id="contextModalClose" class="px-6 py-3 text-base bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors"> Close
</button>
</div>
</div>
</dialog>

<dialog id="figureModal" class="p-0 rounded-lg shadow-xl w-full max-w-lg">
<form id="figureForm" class="p-8 space-y-5"> 
<h2 class="text-2xl font-semibold">Add Key Figure for <span id="figure-modal-year">1947</span></h2>
<input type="hidden" id="figure-year-hidden">
<div>
<label for="figureName" class="block text-base font-medium text-gray-700 mb-1">Name</label> 
<input type="text" id="figureName" class="w-full p-3 text-base border border-gray-300 rounded-md" required>
</div>
<div>
<label for="figureImageUrl" class="block text-base font-medium text-gray-700 mb-1">Image URL</label> 
<input type="text" id="figureImageUrl" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="https://... image link" required>
<img id="figure-preview" src="https://placehold.co/100x100?text=Preview" alt="preview" class="w-24 h-24 object-cover mt-2 rounded-md border">
</div>
<div>
<label for="figureDescription" class="block text-base font-medium text-gray-700 mb-1">Description (for hover)</label>
<textarea id="figureDescription" class="w-full p-3 text-base border border-gray-300 rounded-md" rows="3" placeholder="e.g., Role in the Language Movement..." required></textarea>
</div>
<div class="flex justify-end space-x-3">
<button type="button" id="figure-modal-cancel" class="px-5 py-3 text-base bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
<button type="submit" class="px-5 py-3 text-base bg-emerald-600 text-white rounded-md hover:bg-emerald-700">Save Figure</button>
</div>
</form>
</dialog>

<dialog id="uiModal" class="p-0 rounded-lg shadow-xl w-full max-w-5xl"> <div class="p-8 space-y-6">
<h2 class="text-3xl font-semibold">Manage UI Settings</h2>

<div class="grid grid-cols-1 md:grid-cols-4 gap-6"> <div class="space-y-6 p-4 bg-gray-50 rounded-lg border">
<h3 class="text-xl font-semibold border-b pb-2">Global & Gaps</h3>
<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="globalScaleSlider" class="block text-base font-medium text-gray-700">Global Scale (Zoom)</label>
<span id="globalScaleValue" class="range-value">100%</span>
</div>
<input type="range" id="globalScaleSlider" min="80" max="150" value="100" class="w-full"> </div>

<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="layoutGapSlider" class="block text-base font-medium text-gray-700">Timeline/Sidebar Gap</label>
<span id="layoutGapValue" class="range-value">3rem</span>
</div>
<input type="range" id="layoutGapSlider" min="2" max="15" value="3" step="0.5" class="w-full"> </div>

<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="lineHeightSlider" class="block text-base font-medium text-gray-700">Global Line Height</label>
<span id="lineHeightValue" class="range-value">1.6</span>
</div>
<input type="range" id="lineHeightSlider" min="1.2" max="2.2" value="1.6" step="0.1" class="w-full">
</div>
</div>

<div class="space-y-6 p-4 bg-gray-50 rounded-lg border">
<h3 class="text-xl font-semibold border-b pb-2">Timeline</h3>
<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="verticalSpacingSlider" class="block text-base font-medium text-gray-700">Vertical Spacing</label>
<span id="verticalSpacingValue" class="range-value">2rem</span>
</div>
<input type="range" id="verticalSpacingSlider" min="1" max="5" value="2" step="0.25" class="w-full"> </div>

<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="yearHeaderFsSlider" class="block text-base font-medium text-gray-700">Year Header Font</label>
<span id="yearHeaderFsValue" class="range-value">2.25rem</span>
</div>
<input type="range" id="yearHeaderFsSlider" min="1.5" max="4" value="2.25" step="0.125" class="w-full"> </div>

<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="monthCardFsSlider" class="block text-base font-medium text-gray-700">Month Card Font</label>
<span id="monthCardFsValue" class="range-value">1rem</span>
</div>
<input type="range" id="monthCardFsSlider" min="0.75" max="1.5" value="1" step="0.125" class="w-full"> </div>

<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="monthCardPadYSlider" class="block text-base font-medium text-gray-700">Month Card Padding (Y)</label>
<span id="monthCardPadYValue" class="range-value">1.5rem</span>
</div>
<input type="range" id="monthCardPadYSlider" min="0.5" max="5" value="1.5" step="0.25" class="w-full"> </div>
<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="monthCardPadXSlider" class="block text-base font-medium text-gray-700">Month Card Padding (X)</label>
<span id="monthCardPadXValue" class="range-value">1.5rem</span>
</div>
<input type="range" id="monthCardPadXSlider" min="0.5" max="5" value="1.5" step="0.25" class="w-full"> </div>
</div>

<div class="space-y-6 p-4 bg-gray-50 rounded-lg border">
<h3 class="text-xl font-semibold border-b pb-2">Sidebar</h3>
<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="sidebarPadYSlider" class="block text-base font-medium text-gray-700">Content Padding (Y)</label>
<span id="sidebarPadYValue" class="range-value">1.5rem</span>
</div>
<input type="range" id="sidebarPadYSlider" min="0.5" max="5" value="1.5" step="0.25" class="w-full"> </div>
<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="sidebarPadXSlider" class="block text-base font-medium text-gray-700">Content Padding (X)</label>
<span id="sidebarPadXValue" class="range-value">1.5rem</span>
</div>
<input type="range" id="sidebarPadXSlider" min="0.5" max="5" value="1.5" step="0.25" class="w-full"> </div>
<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="sidebarTitleFsSlider" class="block text-base font-medium text-gray-700">Title Font</label>
<span id="sidebarTitleFsValue" class="range-value">3.75rem</span>
</div>
<input type="range" id="sidebarTitleFsSlider" min="1.25" max="5" value="3.75" step="0.125" class="w-full"> </div>

<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="sidebarBodyFsSlider" class="block text-base font-medium text-gray-700">Body Font</label>
<span id="sidebarBodyFsValue" class="range-value">2rem</span>
</div>
<input type="range" id="sidebarBodyFsSlider" min="0.75" max="3" value="2" step="0.125" class="w-full"> </div>
</div>

<div class="space-y-6 p-4 bg-gray-50 rounded-lg border">
<h3 class="text-xl font-semibold border-b pb-2">Modals (Pop-ups)</h3>
<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="modalPadYSlider" class="block text-base font-medium text-gray-700">Padding (Y)</label>
<span id="modalPadYValue" class="range-value">2rem</span>
</div>
<input type="range" id="modalPadYSlider" min="1" max="5" value="2" step="0.25" class="w-full"> </div>
<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="modalPadXSlider" class="block text-base font-medium text-gray-700">Padding (X)</label>
<span id="modalPadXValue" class="range-value">2rem</span>
</div>
<input type="range" id="modalPadXSlider" min="1" max="5" value="2" step="0.25" class="w-full"> </div>

<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="modalTitleFsSlider" class="block text-base font-medium text-gray-700">Title Font</label>
<span id="modalTitleFsValue" class="range-value">1.875rem</span>
</div>
<input type="range" id="modalTitleFsSlider" min="1.25" max="3" value="1.875" step="0.125" class="w-full"> </div>

<div class="space-y-2">
<div class="flex justify-between items-center">
<label for="modalBodyFsSlider" class="block text-base font-medium text-gray-700">Body Font</label>
<span id="modalBodyFsValue" class="range-value">1rem</span>
</div>
<input type="range" id="modalBodyFsSlider" min="0.75" max="1.5" value="1" step="0.125" class="w-full"> </div>
</div>
</div>

<div class="mt-8 flex justify-between space-x-3">
<button type="button" id="uiResetBtn" class="px-6 py-3 text-base bg-red-100 text-red-700 rounded-md hover:bg-red-200 transition-colors">
Reset to Default
</button>
<button type="button" id="uiModalClose" class="px-6 py-3 text-base bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
Close
</button>
</div>
</div>
</dialog>

<dialog id="analysisModal" class="p-0 rounded-lg shadow-xl w-full max-w-3xl">
<div class="p-8">
<h2 class="text-3xl font-semibold">Manage Yearly Analysis</h2>

<div class="mt-6 mb-6">
<label for="analysisYearSelect" class="block text-xl font-medium text-gray-700 mb-2">Select Year to Edit:</label>
<select id="analysisYearSelect" class="w-full p-3 text-base border border-gray-300 rounded-md">
</select>
</div>

<div class="space-y-2">
<h3 class="text-xl font-semibold text-gray-700">My Summary & Analysis</h3>
<textarea id="analysisSummaryTextarea" class="w-full h-40 p-3 text-base border rounded-md focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Your 'big picture' analysis for this year..."></textarea>
<button id="analysisSaveSummaryBtn" class="mt-2 px-5 py-2 bg-emerald-600 text-white text-base rounded-md hover:bg-emerald-700 transition-colors">
Save Summary
</button>
</div>

<div class="mt-8">
<h3 class="text-xl font-semibold text-gray-700">Key Figures</h3>

<form id="analysisFigureForm" class="mt-4 p-4 grid grid-cols-1 md:grid-cols-2 gap-4 border border-gray-200 rounded-lg bg-gray-50">
<h4 class="text-lg font-medium col-span-1 md:col-span-2">Add New Figure</h4>
<div>
<label for="analysisFigureName" class="block text-base font-medium text-gray-700 mb-1">Name</label>
<input type="text" id="analysisFigureName" class="w-full p-3 text-base border border-gray-300 rounded-md" required>
</div>
<div>
<label for="analysisFigureImageUrl" class="block text-base font-medium text-gray-700 mb-1">Image URL</label>
<input type="text" id="analysisFigureImageUrl" class="w-full p-3 text-base border border-gray-300 rounded-md" placeholder="https://... image link" required>
<img id="analysis-figure-preview" src="https://placehold.co/100x100?text=Preview" alt="preview" class="w-24 h-24 object-cover mt-2 rounded-md border" onerror="this.src='https://placehold.co/100x100/f87171/ffffff?text=Invalid+Link'">
</div>
<div class="col-span-1 md:col-span-2">
<label for="analysisFigureDescription" class="block text-base font-medium text-gray-700 mb-1">Description (for hover)</label>
<textarea id="analysisFigureDescription" class="w-full p-3 text-base border border-gray-300 rounded-md" rows="2" placeholder="e.g., Role in the Language Movement..." required></textarea>
</div>
<div class="col-span-1 md:col-span-2 flex justify-end">
<button type="submit" class="px-5 py-2 bg-gray-600 text-white text-base rounded-md hover:bg-gray-700 transition-colors">
Add Figure
</button>
</div>
</form>

<div class="mt-4">
<h4 class="text-lg font-medium">Existing Figures for this Year</h4>
<div id="analysisFiguresList" class="mt-2 space-y-3 max-h-48 overflow-y-auto p-3 border rounded-md">
<p class="text-gray-500 italic text-base">No figures added for this year.</p>
</div>
</div>
</div>

<div class="mt-8 flex justify-end">
<button type="button" id="analysisModalClose" class="px-6 py-3 text-base bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
Close
</button>
</div>
</div>
</dialog>

<div id="global-tooltip" class="fixed p-3 text-sm text-white bg-gray-900 rounded-lg shadow-lg z-[9999] opacity-0 transition-opacity duration-200 pointer-events-none" style="max-width: 300px; transform: translate(-50%, 10px); visibility: hidden;"></div>


<script type="module">
// Import Firebase modules
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
// --- PART 2: Updated Auth Imports ---
import { 
getAuth, 
onAuthStateChanged, 
GoogleAuthProvider, 
signInWithPopup,
signOut
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
// -------------------------------------
import { 
getFirestore, 
doc, 
getDoc, 
addDoc, 
setDoc, 
updateDoc, 
deleteDoc, 
onSnapshot, 
collection,
query,
setLogLevel,
where
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- GLOBAL VARIABLES ---

// --- PART 2: YOUR FIREBASE CONFIG IS NOW HERE ---
const firebaseConfig = {
apiKey: "AIzaSyBb8Wnm_8Su5SYR4SwyrJOzC-Yl3Sd5DM4",
authDomain: "timeline-715a5.firebaseapp.com",
projectId: "timeline-715a5",
storageBucket: "timeline-715a5.firebasestorage.app",
messagingSenderId: "396178765786",
appId: "1:396178765786:web:fbf38fe8b12a11fbf872e3",
measurementId: "G-6FQS8Q2WZ5"
};
// --------------------------------------------------


// Firebase services
let app, auth, db;

// App state
let userId = null;
let isAuthReady = false;

// --- NEW: Multi-Timeline State ---
let timelinesRef = null; // Ref to users/{userId}/timelines
let unsubscribeTimelinesList = null;
let allTimelines = []; // Array of {id, name, startYear, endYear}
let activeTimelineId = null;

// --- Timeline State (Now depends on activeTimelineId) ---
let timelineEventsRef = null;
let unsubscribeTimeline = null; 

// --- Context Bar State (Now depends on activeTimelineId) ---
let contextEventsRef = null;
let unsubscribeContext = null;
let allContextData = [];

// --- New Sidebar State (Now depends on activeTimelineId) ---
let summariesRef = null;
let keyFiguresRef = null;
let unsubscribeSummaries = null;
let unsubscribeKeyFigures = null;
let allSummaries = new Map(); // Map<year, summaryText>
let allKeyFigures = []; // Array of figure objects

// MODIFIED: This is now set by the active timeline
let currentActiveYear = '1947'; 

// NEW: IntersectionObserver for sticky year
let yearObserver = null;

// Constants
const MONTHS = [
"January", "February", "March", "April", "May", "June", 
"July", "August", "September", "October", "November", "December"
];
// MODIFIED: Changed from const to let
let START_YEAR = 1947;
let END_YEAR = 1951;

let DAY_OPTIONS_HTML = ''; // Will be populated once

// DOM Elements
const header = document.querySelector('header'); // NEW
const headerFocus = document.getElementById('headerFocus'); // NEW
const timelineContainer = document.getElementById('timeline-container');
const userInfo = document.getElementById('userInfo');
const modal = document.getElementById('infoModal');
const modalTitle = document.getElementById('modalTitle');
const modalSubTitle = document.getElementById('modalSubTitle');
const modalForm = document.getElementById('infoForm');
const modalYear = document.getElementById('modalYear');
const modalMonth = document.getElementById('modalMonth');
const modalDocId = document.getElementById('modalDocId');
const notesContainer = document.getElementById('notesContainer');
const addNoteEntryBtn = document.getElementById('addNoteEntry');
const modalCancel = document.getElementById('modalCancel');

const modalEventType = document.getElementById('modalEventType');
const modalDurationFields = document.getElementById('modalDurationFields');
const modalEventTitle = document.getElementById('modalEventTitle');
const modalEventColorWrapper = document.getElementById('modalEventColorWrapper');
const modalEventColor = document.getElementById('modalEventColor');
const colorPreview = document.getElementById('colorPreview');

const manageContextBtn = document.getElementById('manageContextBtn');
const contextToggle = document.getElementById('contextToggle');
const contextBarContainer = document.getElementById('context-bar-container');
const contextModal = document.getElementById('contextModal');
const contextForm = document.getElementById('contextForm');
const contextModalClose = document.getElementById('contextModalClose');
const contextList = document.getElementById('contextList');
const contextRole = document.getElementById('contextRole');
const contextName = document.getElementById('contextName');
const contextStartYear = document.getElementById('contextStartYear');
const contextStartMonth = document.getElementById('contextStartMonth');
const contextStartDay = document.getElementById('contextStartDay');
const contextEndYear = document.getElementById('contextEndYear');
const contextEndMonth = document.getElementById('contextEndMonth');
const contextEndDay = document.getElementById('contextEndDay');
const contextColor = document.getElementById('contextColor');

const tagFilterInput = document.getElementById('tagFilter');

// --- New Sidebar DOM Elements ---
const sidebar = document.getElementById('sidebar'); // NEW
const sidebarContent = document.getElementById('sidebar-content'); // NEW
const sidebarYear = document.getElementById('sidebar-year');
const summaryDisplay = document.getElementById('summary-display'); // MODIFIED
const keyFiguresContainer = document.getElementById('key-figures-container');
const keyFiguresPlaceholder = document.getElementById('key-figures-placeholder');

// --- New Figure Modal DOM Elements ---
const figureModal = document.getElementById('figureModal');
const figureForm = document.getElementById('figureForm');
const figureModalYear = document.getElementById('figure-modal-year');
const figureYearHidden = document.getElementById('figure-year-hidden');
const figureName = document.getElementById('figureName');
const figureImageUrl = document.getElementById('figureImageUrl');
const figurePreview = document.getElementById('figure-preview');
const figureDescription = document.getElementById('figureDescription');
const figureModalCancel = document.getElementById('figure-modal-cancel');

// --- New Auth DOM Elements ---
const loginOverlay = document.getElementById('login-overlay');
const loginBtn = document.getElementById('login-btn');
const signOutBtn = document.getElementById('sign-out-btn');
const mainAppContent = document.querySelector('.main-app-content');

// --- NEW: UI Modal Elements ---
const manageUiBtn = document.getElementById('manageUiBtn');
const uiModal = document.getElementById('uiModal');
const uiModalClose = document.getElementById('uiModalClose');
const uiResetBtn = document.getElementById('uiResetBtn');
const globalScaleSlider = document.getElementById('globalScaleSlider');
const globalScaleValue = document.getElementById('globalScaleValue');
const layoutGapSlider = document.getElementById('layoutGapSlider');
const layoutGapValue = document.getElementById('layoutGapValue');
// NEW: Line Height
const lineHeightSlider = document.getElementById('lineHeightSlider');
const lineHeightValue = document.getElementById('lineHeightValue');

const verticalSpacingSlider = document.getElementById('verticalSpacingSlider');
const verticalSpacingValue = document.getElementById('verticalSpacingValue');
const yearHeaderFsSlider = document.getElementById('yearHeaderFsSlider');
const yearHeaderFsValue = document.getElementById('yearHeaderFsValue');
const monthCardFsSlider = document.getElementById('monthCardFsSlider');
const monthCardFsValue = document.getElementById('monthCardFsValue');
const sidebarTitleFsSlider = document.getElementById('sidebarTitleFsSlider');
const sidebarTitleFsValue = document.getElementById('sidebarTitleFsValue');
const sidebarBodyFsSlider = document.getElementById('sidebarBodyFsSlider');
const sidebarBodyFsValue = document.getElementById('sidebarBodyFsValue');
const modalTitleFsSlider = document.getElementById('modalTitleFsSlider');
const modalTitleFsValue = document.getElementById('modalTitleFsValue');
const modalBodyFsSlider = document.getElementById('modalBodyFsSlider');
const modalBodyFsValue = document.getElementById('modalBodyFsValue');
// --- NEW Padding Sliders ---
const monthCardPadYSlider = document.getElementById('monthCardPadYSlider');
const monthCardPadYValue = document.getElementById('monthCardPadYValue');
const monthCardPadXSlider = document.getElementById('monthCardPadXSlider');
const monthCardPadXValue = document.getElementById('monthCardPadXValue');
const sidebarPadYSlider = document.getElementById('sidebarPadYSlider');
const sidebarPadYValue = document.getElementById('sidebarPadYValue');
const sidebarPadXSlider = document.getElementById('sidebarPadXSlider');
const sidebarPadXValue = document.getElementById('sidebarPadXValue');
const modalPadYSlider = document.getElementById('modalPadYSlider');
const modalPadYValue = document.getElementById('modalPadYValue');
const modalPadXSlider = document.getElementById('modalPadXSlider');
const modalPadXValue = document.getElementById('modalPadXValue');
// --- DELETED Margin Slider consts ---


// --- NEW Analysis Modal Elements ---
const manageAnalysisBtn = document.getElementById('manageAnalysisBtn');
const analysisModal = document.getElementById('analysisModal');
const analysisModalClose = document.getElementById('analysisModalClose');
const analysisYearSelect = document.getElementById('analysisYearSelect');
const analysisSummaryTextarea = document.getElementById('analysisSummaryTextarea');
const analysisSaveSummaryBtn = document.getElementById('analysisSaveSummaryBtn');
const analysisFiguresList = document.getElementById('analysisFiguresList');
const analysisFigureForm = document.getElementById('analysisFigureForm');
const analysisFigureName = document.getElementById('analysisFigureName');
const analysisFigureImageUrl = document.getElementById('analysisFigureImageUrl');
const analysisFigureDescription = document.getElementById('analysisFigureDescription');
const analysisFigurePreview = document.getElementById('analysis-figure-preview'); // NEW

// --- NEW: Timeline Range Modal Elements ---
const createTimelineBtn = document.getElementById('createTimelineBtn');
const timelineRangeModal = document.getElementById('timelineRangeModal');
const timelineRangeForm = document.getElementById('timelineRangeForm');
const timelineNameInput = document.getElementById('timelineNameInput'); // NEW
const startYearInput = document.getElementById('startYearInput');
const endYearInput = document.getElementById('endYearInput');
const timelineRangeCancel = document.getElementById('timelineRangeCancel');

// --- NEW: Manage Timelines Modal Elements ---
const manageTimelinesBtn = document.getElementById('manageTimelinesBtn');
const manageTimelinesModal = document.getElementById('manageTimelinesModal');
const manageTimelinesList = document.getElementById('manageTimelinesList');
const manageTimelinesClose = document.getElementById('manageTimelinesClose');


// --- INITIALIZATION ---

document.addEventListener('DOMContentLoaded', () => {
try {
// Initialize Firebase
app = initializeApp(firebaseConfig);
auth = getAuth(app);
db = getFirestore(app);
setLogLevel('Debug'); // Enable detailed logs

// Pre-generate day options
let dayOptions = '<option value="">Day?</option>';
for (let d = 1; d <= 31; d++) {
dayOptions += `<option value="${d}">${d}</option>`;
}
DAY_OPTIONS_HTML = dayOptions;

// NEW: Load UI settings from localStorage
loadUiSettings();

// NEW: Populate Analysis Year Selector
// MODIFIED: Moved logic to a helper function
populateAnalysisYearDropdown();

// Render the static HTML structure
renderTimelineStructure();

// Set up authentication
setupAuth();

// Set up global event listeners
setupEventListeners();

} catch (error) {
console.error("Error initializing Firebase:", error);
userInfo.textContent = "Error: Could not connect to services.";
}
});

// NEW: Function to set sticky top
function updateStickyTop() {
if (header) { // sidebarContent is already checked
const headerHeight = header.offsetHeight;
const stickyTopValue = `${headerHeight + 20}px`;

// 1. Update Sidebar
if (sidebarContent) {
sidebarContent.style.top = stickyTopValue;
}

// 2. NEW: Update all Year Headers
document.querySelectorAll('.year-block').forEach(block => { // Target the block
block.style.top = stickyTopValue; // Set top on the block
});

// 3. NEW: Re-initialize the observer with the new stickyTopValue
observeYearHeaders(headerHeight + 20);
}
}

/**
         * Sets up Firebase authentication and listens for state changes.
         */
async function setupAuth() {
onAuthStateChanged(auth, async (user) => {
if (user) {
// --- User is SIGNED IN ---
userId = user.uid;
isAuthReady = true;
userInfo.textContent = `Signed in as: ${user.displayName || user.email}`;

// --- NEW: Set up main timelines ref ---
timelinesRef = collection(db, 'users', userId, 'timelines');

// --- NEW: Listen for the list of timelines ---
// This will handle activating the correct timeline
listenForTimelinesList(); 
// ------------------------------------

// Show the app, hide the login
mainAppContent.style.display = 'block';
loginOverlay.style.display = 'none';

// NEW: Set sticky top position
// MODIFIED: This is now called *after* a timeline is activated
// updateStickyTop();

} else {
// --- User is SIGNED OUT ---
userId = null;
isAuthReady = false;
activeTimelineId = null;
userInfo.textContent = "Please sign in.";

// Stop all listeners
detachTimelinesListListener(); // NEW
detachDataListeners();

// Hide the app, show the login
mainAppContent.style.display = 'none';
loginOverlay.style.display = 'flex';
}
});

// --- PART 2: New Sign-in Logic ---
loginBtn.addEventListener('click', async () => {
const provider = new GoogleAuthProvider();
try {
await signInWithPopup(auth, provider);
// onAuthStateChanged will handle the rest
} catch (error) {
console.error("Error during sign-in:", error);
userInfo.textContent = "Sign-in failed. Please try again.";
}
});

// --- PART 2: New Sign-out Logic ---
signOutBtn.addEventListener('click', async () => {
try {
await signOut(auth);
// onAuthStateChanged will handle the rest
} catch (error) {
console.error("Error during sign-out:", error);
}
});
}

/**
         * Checks if initial data exists and adds it if not.
         * MODIFIED: This now operates on the *active* timeline.
         */
async function addInitialData() {
// NEW: Guard against running without an active timeline
if (!timelineEventsRef) return; 

const flagDocRef = doc(timelineEventsRef, 'init_flag');

try {
const flagDoc = await getDoc(flagDocRef);
if (!flagDoc.exists()) {
// New "notes object" format
// MODIFIED: Add initial data to the *active* timeline's START_YEAR
await addDoc(timelineEventsRef, {
year: START_YEAR, // Use active timeline's start year
month: "January",  // Use first month
info: [
{ day: "1", note: "Welcome to your new timeline! Add your first note.", tag: "example" }
],
eventType: "single"
});

await setDoc(flagDocRef, { initialized: true });
}
} catch (error) {
console.error("Error checking/adding initial data:", error);
}
}

/**
         * Renders the static HTML structure of the timeline (years, months).
         * Data will be populated separately.
         */
function renderTimelineStructure() {
timelineContainer.innerHTML = ''; // Clear existing

// Re-add the context bar container which was cleared
timelineContainer.innerHTML = '<div id="context-bar-container"></div>';

// NEW: Handle state with no active timeline
if (!activeTimelineId) {
timelineContainer.innerHTML += `<p class="text-center text-xl text-gray-500 p-10">No timeline selected. Click "Manage Timelines" to activate one, or "Create Timeline" to make a new one.</p>`;
return;
}

// MODIFIED: Uses global START_YEAR and END_YEAR
for (let year = START_YEAR; year <= END_YEAR; year++) {
const yearHeader = document.createElement('div');
yearHeader.className = 'year-block text-center';
yearHeader.dataset.year = year; // <-- Important for IntersectionObserver
// RESTORED old logic with new, larger classes
yearHeader.innerHTML = ` 
               <span class="relative z-10 inline-block px-8 py-3 bg-emerald-700 text-white font-bold rounded-lg shadow-lg">
                   ${year}
               </span>
           `;
timelineContainer.appendChild(yearHeader);

MONTHS.forEach(month => {
const monthItem = document.createElement('div');
monthItem.className = 'month-item flex flex-col';
monthItem.id = `month-item-${year}-${month}`; 
monthItem.dataset.year = year;
monthItem.dataset.month = month;

// RESTORED old logic with new, larger classes
monthItem.innerHTML = `
                           <div class="timeline-dot"></div>
                           <div class="month-card z-10 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                               <h3 class="font-bold text-emerald-600">${month}</h3>
                               
                               <div class="month-content mt-2" id="content-${year}-${month}">
                                   <p class="text-gray-500 italic">No notes added yet.</p>
                               </div>
                               
                               <div class="month-buttons mt-3 flex" id="buttons-${year}-${month}">
                                   <button class="btn-add px-4 py-2 bg-emerald-100 text-emerald-700 font-medium rounded-md hover:bg-emerald-200 transition-colors"
                                           data-year="${year}" data-month="${month}">
                                       Add Info
                                   </button>
                               </div>
                           </div>
                       `;
timelineContainer.appendChild(monthItem);
});
}

// MODIFIED: This function must be called to repopulate dropdowns
// with the new year range.
populateContextDateDropdowns();

// After rendering, set up the observer
// observeYearHeaders(); // REMOVED: Called by updateStickyTop now
}

/**
         * Populates the date dropdowns in the context modal.
         * MODIFIED: Now uses global START_YEAR and END_YEAR
         */
function populateContextDateDropdowns() {
const yearOptions = [];
for (let y = START_YEAR; y <= END_YEAR; y++) {
yearOptions.push(`<option value="${y}">${y}</option>`);
}
const monthOptions = MONTHS.map(m => `<option value="${m}">${m}</option>`);

const dayOptions = [];
for (let d = 1; d <= 31; d++) {
dayOptions.push(`<option value="${d}">${d}</option>`);
}

const yearOptionsHtml = yearOptions.join('');
const monthOptionsHtml = monthOptions.join('');
const dayOptionsHtml = dayOptions.join('');

contextStartYear.innerHTML = yearOptionsHtml;
contextEndYear.innerHTML = yearOptionsHtml;
contextStartMonth.innerHTML = monthOptionsHtml;
contextEndMonth.innerHTML = monthOptionsHtml;
contextStartDay.innerHTML = dayOptionsHtml;
contextEndDay.innerHTML = dayOptionsHtml;

contextStartYear.value = START_YEAR;
contextStartMonth.value = "January";
contextStartDay.value = 1;
contextEndYear.value = END_YEAR;
contextEndMonth.value = "December";
contextEndDay.value = 31;
}

/**
         * NEW: Populates the year dropdown in the analysis modal.
         */
function populateAnalysisYearDropdown() {
let yearOptions = '';
for (let y = START_YEAR; y <= END_YEAR; y++) {
yearOptions += `<option value="${y}">${y}</option>`;
}
analysisYearSelect.innerHTML = yearOptions;

// After populating, update the modal to show the first year's data
// (or reset to the new first year)
if (analysisYearSelect.value) {
updateAnalysisModal(analysisYearSelect.value);
}
}

// --- NEW: DATA LISTENER HELPER FUNCTIONS ---

/**
         * NEW: Detaches all active Firestore listeners for a specific timeline.
         */
function detachDataListeners() {
if (unsubscribeTimeline) unsubscribeTimeline();
if (unsubscribeContext) unsubscribeContext();
if (unsubscribeSummaries) unsubscribeSummaries();
if (unsubscribeKeyFigures) unsubscribeKeyFigures();
unsubscribeTimeline = null;
unsubscribeContext = null;
unsubscribeSummaries = null;
unsubscribeKeyFigures = null;
}

/**
         * NEW: Detaches the main timelines list listener.
         */
function detachTimelinesListListener() {
if (unsubscribeTimelinesList) unsubscribeTimelinesList();
unsubscribeTimelinesList = null;
}

/**
         * NEW: Initializes all Firestore listeners for the active timeline.
         */
function initializeDataListeners() {
// NEW: Guard against running without an active timeline
if (!isAuthReady || !activeTimelineId) return; 

listenForTimelineData();
listenForContextData();
listenForSummaries();
listenForKeyFigures();
}

// --- DATA LISTENER FUNCTIONS ---

/**
         * NEW: Listens for the user's list of timelines.
         */
function listenForTimelinesList() {
if (!isAuthReady || !timelinesRef) return;
if (unsubscribeTimelinesList) unsubscribeTimelinesList();

unsubscribeTimelinesList = onSnapshot(timelinesRef, (snapshot) => {
allTimelines = [];
snapshot.forEach(doc => {
allTimelines.push({ id: doc.id, ...doc.data() });
});

// Sort timelines by name
allTimelines.sort((a, b) => a.name.localeCompare(b.name));

renderTimelinesListInModal();

// Determine which timeline to activate
let newActiveId = localStorage.getItem('activeTimelineId');
let timelineData = allTimelines.find(t => t.id === newActiveId);

if (!timelineData) {
// If stored ID is invalid or not found, pick the first one
timelineData = allTimelines[0]; 
newActiveId = timelineData ? timelineData.id : null;
}

if (newActiveId) {
// We have a timeline to activate
// MODIFIED: Always activate to ensure data consistency,
// even if ID is the same but data (e.g., year) *could* have changed.
// This is simpler than deep-checking.
activateTimeline(newActiveId, timelineData);

} else {
// No timelines exist for this user
activeTimelineId = null;
detachDataListeners();
renderTimelineStructure(); // Show "No timeline" message
headerFocus.textContent = "No Timeline";
currentActiveYear = "----";
updateSidebarContent("----");
}
});
}

/**
         * NEW: Activates a specific timeline, setting all refs and reloading data.
         */
async function activateTimeline(timelineId, timelineData) {
if (!timelineId || !timelineData) return;

// if (activeTimelineId === timelineId) return; // Already active (REMOVED this check)

activeTimelineId = timelineId;
localStorage.setItem('activeTimelineId', timelineId);

               // NEW: Re-render the modal list to reflect the new active timeline
               renderTimelinesListInModal();

// Detach old listeners
detachDataListeners();

// Set new global refs based on the active timeline
timelineEventsRef = collection(db, 'users', userId, 'timelines', activeTimelineId, 'timeline_events');
contextEventsRef = collection(db, 'users', userId, 'timelines', activeTimelineId, 'political_context');
summariesRef = collection(db, 'users', userId, 'timelines', activeTimelineId, 'year_summaries');
keyFiguresRef = collection(db, 'users', userId, 'timelines', activeTimelineId, 'key_figures');

// Update global year range
START_YEAR = parseInt(timelineData.startYear);
END_YEAR = parseInt(timelineData.endYear);
currentActiveYear = timelineData.startYear.toString();

// Update header
headerFocus.textContent = `${timelineData.name} (${START_YEAR} - ${END_YEAR})`;

// Re-render everything
renderTimelineStructure();
populateAnalysisYearDropdown();
populateContextDateDropdowns();
updateStickyTop();

// Add initial "Welcome" note if this is a brand new timeline
await addInitialData(); 

// Attach listeners to new refs
initializeDataListeners(); 

// Update sidebar to new default year
updateSidebarContent(currentActiveYear);
}

/**
         * Listens for real-time data from Firestore and updates the UI.
         */
function listenForTimelineData() {
if (!isAuthReady || !timelineEventsRef) return;
if (unsubscribeTimeline) unsubscribeTimeline();

const q = query(timelineEventsRef);

unsubscribeTimeline = onSnapshot(q, (snapshot) => {
resetAllMonthItems();

snapshot.forEach(doc => {
const data = doc.data();
const id = doc.id;

if (id === 'init_flag') return;

const { year, month, info } = data;

// NEW: Filter out data not in the current year range
if (year < START_YEAR || year > END_YEAR) {
return;
}

const contentEl = document.getElementById(`content-${year}-${month}`);
const buttonsEl = document.getElementById(`buttons-${year}-${month}`);
const monthItemEl = document.getElementById(`month-item-${year}-${month}`);

if (contentEl && buttonsEl && monthItemEl) {
monthItemEl.dataset.id = id;

let infoContent = '';
let hasNotes = false;

if (Array.isArray(info) && info.length > 0) {
const noteItems = info.map(noteData => {
let noteObj = {};
// Handle backward compatibility
if (typeof noteData === 'string') {
noteObj = { note: noteData, day: '', tag: '' };
} else {
noteObj = noteData;
}

const dayHtml = noteObj.day ? `<span class="note-day">${noteObj.day}: </span>` : '';
const tagHtml = noteObj.tag ? `<span class="note-tag">#${escapeHTML(noteObj.tag)}</span>` : '';
const tagDataAttr = noteObj.tag ? `data-tag="${escapeHTML(noteObj.tag.toLowerCase())}"` : '';

return `<li class="month-note-item" ${tagDataAttr}>
                                       ${dayHtml}${escapeHTML(noteObj.note)} ${tagHtml}
                                   </li>`;
}).join('');

infoContent = `<ul class="space-y-2">${noteItems}</ul>`;
hasNotes = true;
} 

if (hasNotes) {
contentEl.innerHTML = infoContent;
monthItemEl.classList.add('has-data'); // Mark as having data
} else {
contentEl.innerHTML = `<p class="text-gray-500 italic">No notes added yet.</p>`;
monthItemEl.classList.remove('has-data'); // No notes, so no data
}

if (data.eventType === 'start' || data.eventType === 'end') {
contentEl.innerHTML += `
                                   <span class="mt-2 inline-block text-xs font-medium px-2 py-0.5 rounded
                                       ${data.eventType === 'start' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}">
                                       ${data.eventType === 'start' ? 'Start' : 'End'}: ${escapeHTML(data.eventTitle)}
                                   </span>
                               `;
monthItemEl.classList.add('has-data'); // Duration counts as data
}

buttonsEl.innerHTML = `
                               <button class="btn-edit px-4 py-2 bg-blue-100 text-blue-700 font-medium rounded-md hover:bg-blue-200 transition-colors"
                                       data-year="${year}" data-month="${month}" data-id="${id}">
                                   Edit
                               </button>
                               <button class="btn-delete ml-2 px-4 py-2 bg-red-100 text-red-700 font-medium rounded-md hover:bg-red-200 transition-colors"
                                       data-id="${id}">
                                   Delete
                               </button>
                           `;
}
});

applyTagFilter();
renderDurationSpans(snapshot);
updateYearBlockVisibility(document.getElementById('compactToggle').checked);
renderContextBars();

}, (error) => {
console.error("Error with onSnapshot:", error);
});
}

/**
         * Listens for real-time context data from Firestore.
         */
function listenForContextData() {
if (!isAuthReady || !contextEventsRef) return;
if (unsubscribeContext) unsubscribeContext();

const q = query(contextEventsRef);

unsubscribeContext = onSnapshot(q, (snapshot) => {
allContextData = [];
snapshot.forEach(doc => {
allContextData.push({ id: doc.id, ...doc.data() });
});

allContextData.sort((a, b) => {
if (a.startYear !== b.startYear) return a.startYear - b.startYear;
const monthIndexA = MONTHS.indexOf(a.startMonth);
const monthIndexB = MONTHS.indexOf(b.startMonth);
if (monthIndexA !== monthIndexB) return monthIndexA - monthIndexB;
return (a.startDay || 1) - (b.startDay || 1);
});

renderContextListInModal();
renderContextBars();
}, (error) => {
console.error("Error with context onSnapshot:", error);
});
}

/**
         * Listens for yearly summaries data.
         */
function listenForSummaries() {
if (!isAuthReady || !summariesRef) return;
if (unsubscribeSummaries) unsubscribeSummaries();

unsubscribeSummaries = onSnapshot(summariesRef, (snapshot) => {
allSummaries.clear();
snapshot.forEach(doc => {
allSummaries.set(doc.id, doc.data().summaryText); // doc.id is the year
});
// Update sidebar for the currently active year
updateSidebarContent(currentActiveYear);
// NEW: Update analysis modal if it's open
updateAnalysisModal(analysisYearSelect.value);
});
}

/**
         * Listens for key figures data.
         */
function listenForKeyFigures() {
if (!isAuthReady || !keyFiguresRef) return;
if (unsubscribeKeyFigures) unsubscribeKeyFigures();

// This listener gets all figures. We filter by year in the update function.
const q = query(keyFiguresRef);
unsubscribeKeyFigures = onSnapshot(q, (snapshot) => {
allKeyFigures = [];
snapshot.forEach(doc => {
allKeyFigures.push({ id: doc.id, ...doc.data() });
});
// Update sidebar for the currently active year
updateSidebarContent(currentActiveYear);
// NEW: Update analysis modal if it's open
updateAnalysisModal(analysisYearSelect.value);
});
}

// --- RENDER/UPDATE FUNCTIONS ---

/**
         * Draws the visual span bars on the timeline for duration events.
         */
function renderDurationSpans(snapshot) {
document.querySelectorAll('.duration-span').forEach(el => el.remove());
const spansMap = new Map();

snapshot.forEach(doc => {
const data = doc.data();
const { eventType, eventTitle, eventColor, year, month } = data;
if (!eventTitle || (eventType !== 'start' && eventType !== 'end')) return;

// NEW: Filter out data not in the current year range
if (year < START_YEAR || year > END_YEAR) {
return;
}

const monthItemEl = document.getElementById(`month-item-${year}-${month}`);
if (!monthItemEl) return;

const dotEl = monthItemEl.querySelector('.timeline-dot');
if (!dotEl) return;

const top = monthItemEl.offsetTop + dotEl.offsetTop;

if (!spansMap.has(eventTitle)) {
spansMap.set(eventTitle, {});
}
if (eventType === 'start') {
spansMap.get(eventTitle).startTop = top;
spansMap.get(eventTitle).color = eventColor || '#cbd5e1';
spansMap.get(eventTitle).title = eventTitle;
} else if (eventType === 'end') {
spansMap.get(eventTitle).endTop = top;
}
});

const allSpans = Array.from(spansMap.values())
.filter(s => s.startTop !== undefined && s.endTop !== undefined && s.endTop > s.startTop)
.sort((a, b) => a.startTop - b.startTop);

const activeLanes = []; 
for (const span of allSpans) {
let foundLane = false;
for (let i = 0; i < activeLanes.length; i++) {
if (span.startTop >= activeLanes[i]) {
activeLanes[i] = span.endTop;
span.lane = i;
foundLane = true;
break;
}
}
if (!foundLane) {
span.lane = activeLanes.length;
activeLanes.push(span.endTop);
}
}

const barWidthPx = 8;
const barGapPx = 2;
const initialOffsetFromMainLinePx = 4;

for (const span of allSpans) {
const totalOffsetForThisLane = initialOffsetFromMainLinePx + (span.lane * (barWidthPx + barGapPx));
const height = span.endTop - span.startTop;

const spanBar = document.createElement('div');
spanBar.className = 'duration-span';
spanBar.style.backgroundColor = span.color;
spanBar.style.top = `${span.startTop}px`;
spanBar.style.height = `${height}px`;
spanBar.style.width = `${barWidthPx}px`;
spanBar.style.transform = `translateX(calc(-100% - ${totalOffsetForThisLane}px))`;
spanBar.title = span.title; // Show title on hover
timelineContainer.appendChild(spanBar);
}
}

/**
         * Renders the vertical context bars on the timeline.
         */
function renderContextBars() {
const contextBarContainer = document.getElementById('context-bar-container');
if (!contextBarContainer) return;
contextBarContainer.innerHTML = '';

const rolesMap = new Map();
allContextData.forEach(item => {
// NEW: Filter out data not in the current year range
if (item.startYear > END_YEAR || item.endYear < START_YEAR) {
return;
}
if (!rolesMap.has(item.role)) {
rolesMap.set(item.role, []);
}
rolesMap.get(item.role).push(item);
});

const laneWidth = 12;
const laneGap = 16;
let laneIndex = 0;

rolesMap.forEach((segments, role) => {
const laneOffset = laneIndex * (laneWidth + laneGap);

const laneEl = document.createElement('div');
laneEl.className = 'context-bar-lane';
laneEl.style.left = `${laneOffset}px`;

const legendEl = document.createElement('div');
legendEl.className = 'context-bar-legend';
legendEl.textContent = role;
laneEl.appendChild(legendEl);

segments.forEach(segment => {
// NEW: Clamp start and end dates to the timeline range
let segmentStartYear = segment.startYear;
let segmentStartMonth = segment.startMonth;
let segmentEndYear = segment.endYear;
let segmentEndMonth = segment.endMonth;

if (segmentStartYear < START_YEAR) {
segmentStartYear = START_YEAR;
segmentStartMonth = MONTHS[0];
}
if (segmentEndYear > END_YEAR) {
segmentEndYear = END_YEAR;
segmentEndMonth = MONTHS[11];
}

const startEl = document.getElementById(`month-item-${segmentStartYear}-${segmentStartMonth}`);
const endEl = document.getElementById(`month-item-${segmentEndYear}-${segmentEndMonth}`);

if (!startEl || !endEl) return;

const startDot = startEl.querySelector('.timeline-dot');
const endDot = endEl.querySelector('.timeline-dot');

if (!startDot || !endDot) return;

const startTop = startEl.offsetTop + startDot.offsetTop;
const endTop = endEl.offsetTop + endDot.offsetTop;
const height = endTop - startTop;

if (height < 0) return;

const segmentEl = document.createElement('div');
segmentEl.className = 'context-bar-segment';
segmentEl.style.backgroundColor = segment.color;
segmentEl.style.top = `${startTop}px`;
segmentEl.style.height = `${height}px`;
segmentEl.title = `${role}: ${segment.name}\n(${segment.startDay || ''} ${segment.startMonth} ${segment.startYear} - ${segment.endDay || ''} ${segment.endMonth} ${segment.endYear})`;

laneEl.appendChild(segmentEl);
});

contextBarContainer.appendChild(laneEl);
laneIndex++;
});
}

/**
         * Renders the list of context items in the management modal.
         */
function renderContextListInModal() {
if (allContextData.length === 0) {
contextList.innerHTML = `<p class="text-gray-500 italic text-base">No context eras added yet.</p>`;
return;
}

contextList.innerHTML = allContextData.map(item => `
               <div class="flex items-center justify-between p-3 bg-white border rounded-md">
                   <div class="flex-1">
                       <span class="font-medium text-base" style="color: ${item.color};"> ${escapeHTML(item.role)}:</span>
                       <span class="text-gray-700 text-base">${escapeHTML(item.name)}</span>
                       <span class="text-sm text-gray-500 block">
                           (${item.startDay || ''} ${item.startMonth} ${item.startYear} - ${item.endDay || ''} ${item.endMonth} ${item.endYear})
                       </span>
                   </div>
                   <button class="btn-delete-context ml-4 px-4 py-2 bg-red-100 text-red-700 text-base font-medium rounded-md hover:bg-red-200 transition-colors"
                           data-id="${item.id}">
                       Delete
                   </button>
               </div>
           `).join('');
}

/**
         * NEW: Renders the list of timelines in the management modal.
         */
function renderTimelinesListInModal() {
if (allTimelines.length === 0) {
manageTimelinesList.innerHTML = `<p class="text-gray-500 italic text-base">No timelines created yet.</p>`;
return;
}

manageTimelinesList.innerHTML = allTimelines.map(timeline => {
const isActive = timeline.id === activeTimelineId;
return `
               <div class="flex items-center justify-between p-3 ${isActive ? 'bg-green-50 border-green-300' : 'bg-white border'} rounded-md">
                   <div class="flex-1">
                       <span class="font-medium text-base">${escapeHTML(timeline.name)}</span>
                       <span class="text-sm text-gray-500 block">
                           (${timeline.startYear} - ${timeline.endYear})
                           ${isActive ? '<span class="ml-2 font-bold text-green-700">(Active)</span>' : ''}
                       </span>
                   </div>
                   <div class="flex space-x-2">
                       <button class="btn-activate-timeline px-4 py-2 bg-green-100 text-green-700 text-base font-medium rounded-md hover:bg-green-200 transition-colors"
                               data-id="${timeline.id}" ${isActive ? 'disabled' : ''}>
                           ${isActive ? 'Active' : 'Activate'}
                       </button>
                       <button class="btn-delete-timeline ml-2 px-4 py-2 bg-red-100 text-red-700 text-base font-medium rounded-md hover:bg-red-200 transition-colors"
                               data-id="${timeline.id}">
                           Delete
                       </button>
                   </div>
               </div>
           `}).join('');
}

/**
         * Resets all month items to their default "empty" state.
         */
function resetAllMonthItems() {
document.querySelectorAll('.month-item').forEach(item => {
const { year, month } = item.dataset;
if (!year || !month) return;

const contentEl = document.getElementById(`content-${year}-${month}`);
const buttonsEl = document.getElementById(`buttons-${year}-${month}`);

if (contentEl) {
contentEl.innerHTML = `<p class="text-gray-500 italic text-base">No notes added yet.</p>`;
}
if (buttonsEl) {
buttonsEl.innerHTML = `
                               <button class="btn-add px-4 py-2 bg-emerald-100 text-emerald-700 text-base font-medium rounded-md hover:bg-emerald-200 transition-colors"
                                       data-year="${year}" data-month="${month}">
                                   Add Info
                               </button>
                           `;
}
delete item.dataset.id;
item.classList.remove('has-data');
item.classList.remove('filtered-out'); // Reset filter
});
// Reset all note items
document.querySelectorAll('.month-note-item').forEach(note => {
note.classList.remove('filtered-out');
});
}

/**
         * Updates the content of the sticky sidebar based on the active year.
         */
function updateSidebarContent(year) {
// NEW: Ensure the year is within the current range.
// If the user shrinks the range, the old `currentActiveYear` might be invalid.
// Default to the new START_YEAR if it's out of bounds.
if (year < START_YEAR || year > END_YEAR) {
year = START_YEAR.toString();
currentActiveYear = year;
}

if (!year || !activeTimelineId) {
// NEW: Handle no active timeline
sidebarYear.textContent = "----";
summaryDisplay.innerHTML = `<p class="text-gray-500 italic text-base">No timeline active.</p>`;
keyFiguresContainer.innerHTML = '';
keyFiguresContainer.appendChild(keyFiguresPlaceholder);
keyFiguresPlaceholder.style.display = 'block';
return;
};

// 1. Update Title
sidebarYear.textContent = year;

// 2. Update Summary Textarea
const summary = allSummaries.get(year) || '';
summaryDisplay.textContent = summary; // MODIFIED: Set textContent on the div
if (!summary) {
summaryDisplay.innerHTML = `<p class="text-gray-500 italic text-base">No summary added for this year.</p>`;
}

// 3. Update Key Figures
keyFiguresContainer.innerHTML = ''; // Clear existing
const figuresForYear = allKeyFigures.filter(fig => fig.year == year);

if (figuresForYear.length === 0) {
keyFiguresContainer.appendChild(keyFiguresPlaceholder);
keyFiguresPlaceholder.style.display = 'block';
} else {
keyFiguresPlaceholder.style.display = 'none';
figuresForYear.forEach(fig => {
const figEl = document.createElement('div');
figEl.className = 'figure-item relative';
figEl.dataset.description = escapeHTML(fig.description); // NEW: Add data attribute

figEl.innerHTML = `
                               <img src="${escapeHTML(fig.imageUrl)}" alt="${escapeHTML(fig.name)}" class="w-full h-24 object-cover rounded-md border" onerror="this.src='https://placehold.co/100x100?text=Image'">
                               <p class="text-sm text-center font-medium truncate mt-1">${escapeHTML(fig.name)}</p>
                               `;
keyFiguresContainer.appendChild(figEl);
});
}
}

/**
         * NEW: Updates the content of the Analysis Modal based on the selected year.
         */
function updateAnalysisModal(year) {
if (!year || !activeTimelineId) {
analysisSummaryTextarea.value = "";
analysisSummaryTextarea.disabled = true;
analysisFigureForm.reset();
analysisFigureForm.disabled = true;
analysisFiguresList.innerHTML = `<p class="text-gray-500 italic text-base">No timeline active.</p>`;
return;
};

analysisSummaryTextarea.disabled = false;
analysisFigureForm.disabled = false;

// 1. Update Summary Textarea
const summary = allSummaries.get(year) || '';
analysisSummaryTextarea.value = summary;

// 2. Update Key Figures List
analysisFiguresList.innerHTML = ''; // Clear existing
const figuresForYear = allKeyFigures.filter(fig => fig.year == year);

if (figuresForYear.length === 0) {
analysisFiguresList.innerHTML = `<p class="text-gray-500 italic text-base">No figures added for this year.</p>`;
} else {
figuresForYear.forEach(fig => {
const figEl = document.createElement('div');
figEl.className = 'flex items-center justify-between p-3 bg-white border rounded-md';
figEl.innerHTML = `
                               <div class="flex items-center space-x-3">
                                   <img src="${escapeHTML(fig.imageUrl)}" alt="${escapeHTML(fig.name)}" class="w-12 h-12 object-cover rounded-md border" onerror="this.src='https://placehold.co/50x50?text=Img'">
                                   <span class="text-base font-medium text-gray-700">${escapeHTML(fig.name)}</span>
                               </div>
                               <button class="btn-delete-figure-modal ml-4 px-3 py-1 bg-red-100 text-red-700 text-sm font-medium rounded-md hover:bg-red-200"
                                       data-id="${fig.id}">
                                   Delete
                               </button>
                           `;
analysisFiguresList.appendChild(figEl);
});
}
}

// --- EVENT LISTENER SETUP ---

/**
         * Sets up global event listeners for buttons and modal.
         */
function setupEventListeners() {
// --- Timeline Listeners ---
timelineContainer.addEventListener('click', (e) => {
const target = e.target;

if (target.classList.contains('btn-add')) {
if (!activeTimelineId) return; // NEW Guard
const { year, month } = target.dataset;
openModalForAdd(year, month);
} 
else if (target.classList.contains('btn-edit')) {
if (!activeTimelineId) return; // NEW Guard
const { year, month, id } = target.dataset;
openModalForEdit(year, month, id);
}
else if (target.classList.contains('btn-delete')) {
if (!activeTimelineId) return; // NEW Guard
const { id } = target.dataset;
handleDelete(id);
}
});

// --- Header Listeners ---
compactToggle.addEventListener('change', () => {
const isChecked = compactToggle.checked;
timelineContainer.classList.toggle('compact-view', isChecked);
updateYearBlockVisibility(isChecked);
renderContextBars(); 
});

contextToggle.addEventListener('change', () => {
timelineContainer.classList.toggle('show-context', contextToggle.checked);
});

manageContextBtn.addEventListener('click', () => {
if (!activeTimelineId) return; // NEW Guard
contextModal.showModal();
});

tagFilterInput.addEventListener('input', applyTagFilter);

// NEW: Listen for window resize to update sticky top
window.addEventListener('resize', updateStickyTop);

// --- Notes Modal Listeners ---
modalForm.addEventListener('submit', (e) => {
e.preventDefault();
handleSave();
});
modalCancel.addEventListener('click', () => modal.close());
modalEventType.addEventListener('change', () => {
const type = modalEventType.value;
modalDurationFields.classList.toggle('hidden', type === 'single');
modalEventColorWrapper.classList.toggle('hidden', type !== 'start');
colorPreview.style.display = (type === 'start') ? 'inline-block' : 'none';
});
modalEventColor.addEventListener('input', () => {
colorPreview.style.backgroundColor = modalEventColor.value;
});
addNoteEntryBtn.addEventListener('click', () => createNoteEntry());
notesContainer.addEventListener('click', (e) => {
if (e.target.classList.contains('btn-remove-note')) {
e.target.closest('.note-entry-group').remove();
}
});

// --- Context Modal Listeners ---
contextModalClose.addEventListener('click', () => contextModal.close());
contextForm.addEventListener('submit', (e) => {
e.preventDefault();
handleSaveContext();
});
contextList.addEventListener('click', (e) => {
if (e.target.classList.contains('btn-delete-context')) {
const id = e.target.dataset.id;
handleDeleteContext(id);
}
});

// --- UPDATED: Sidebar Listeners (for new tooltip) ---
const globalTooltip = document.getElementById('global-tooltip');

keyFiguresContainer.addEventListener('mouseover', (e) => {
const figureItem = e.target.closest('.figure-item');
if (!figureItem || !globalTooltip) return;

const description = figureItem.dataset.description;
if (!description) return;

// 1. Populate and set horizontal position
globalTooltip.innerHTML = description;
const rect = figureItem.getBoundingClientRect();
globalTooltip.style.left = `${rect.left + (rect.width / 2)}px`;

// 2. Show hidden to measure
globalTooltip.style.visibility = 'hidden';
globalTooltip.style.opacity = '1';

// 3. Measure height
const tooltipHeight = globalTooltip.offsetHeight;

// 4. Check if it will be cut off (with a 10px buffer)
if (rect.bottom + tooltipHeight + 10 > window.innerHeight) {
// Position above
globalTooltip.style.top = `${rect.top - tooltipHeight - 10}px`;
globalTooltip.style.transform = 'translate(-50%, -10px)'; // Adjust transform for above
} else {
// Position below
globalTooltip.style.top = `${rect.bottom}px`;
globalTooltip.style.transform = 'translate(-50%, 10px)'; // Adjust transform for below
}

// 5. Make visible
globalTooltip.style.visibility = 'visible';
});

keyFiguresContainer.addEventListener('mouseout', (e) => {
const figureItem = e.target.closest('.figure-item');
if (!figureItem || !globalTooltip) return;

// Hide the tooltip
globalTooltip.style.opacity = '0';
globalTooltip.style.visibility = 'hidden';
});

// --- Figure Modal Listeners (Deprecated) ---
figureModalCancel.addEventListener('click', () => figureModal.close());
figureForm.addEventListener('submit', (e) => {
e.preventDefault();
// handleSaveFigure(); // This form is no longer used
});
figureImageUrl.addEventListener('input', () => {
figurePreview.src = figureImageUrl.value || 'https://placehold.co/100x100?text=Preview';
});

// --- NEW: UI Modal Listeners ---
manageUiBtn.addEventListener('click', () => uiModal.showModal());
uiModalClose.addEventListener('click', () => uiModal.close());

// Helper to update a CSS var, localStorage, and a text display
const createSliderListener = (slider, valueDisplay, storageKey, cssVar, unit = '%', unitless = false) => { // NEW: unitless flag
slider.addEventListener('input', (e) => {
const value = e.target.value;
const displayValue = unitless ? value : `${value}${unit}`;
document.documentElement.style.setProperty(cssVar, displayValue);
valueDisplay.textContent = displayValue;
localStorage.setItem(storageKey, value);
// DELETED Special case for sidebar margins
});
};

createSliderListener(globalScaleSlider, globalScaleValue, 'uiScale', 'font-size', '%');
createSliderListener(layoutGapSlider, layoutGapValue, 'uiGap', '--main-gap', 'rem');
createSliderListener(lineHeightSlider, lineHeightValue, 'uiLineHeight', '--global-line-height', '', true); // NEW
createSliderListener(verticalSpacingSlider, verticalSpacingValue, 'uiSpacing', '--timeline-v-spacing', 'rem');
createSliderListener(yearHeaderFsSlider, yearHeaderFsValue, 'uiYearHeaderFs', '--timeline-year-fs', 'rem');
createSliderListener(monthCardFsSlider, monthCardFsValue, 'uiMonthCardFs', '--timeline-card-fs', 'rem');
createSliderListener(sidebarTitleFsSlider, sidebarTitleFsValue, 'uiSidebarTitleFs', '--sidebar-title-fs', 'rem');
createSliderListener(sidebarBodyFsSlider, sidebarBodyFsValue, 'uiSidebarBodyFs', '--sidebar-body-fs', 'rem');
createSliderListener(modalTitleFsSlider, modalTitleFsValue, 'uiModalTitleFs', '--modal-title-fs', 'rem');
createSliderListener(modalBodyFsSlider, modalBodyFsValue, 'uiModalBodyFs', '--modal-body-fs', 'rem');
// --- NEW Padding Listeners ---
createSliderListener(monthCardPadYSlider, monthCardPadYValue, 'uiCardPadY', '--card-padding-y', 'rem');
createSliderListener(monthCardPadXSlider, monthCardPadXValue, 'uiCardPadX', '--card-padding-x', 'rem');
createSliderListener(sidebarPadYSlider, sidebarPadYValue, 'uiSidebarPadY', '--sidebar-padding-y', 'rem');
createSliderListener(sidebarPadXSlider, sidebarPadXValue, 'uiSidebarPadX', '--sidebar-padding-x', 'rem');
createSliderListener(modalPadYSlider, modalPadYValue, 'uiModalPadY', '--modal-padding-y', 'rem');
createSliderListener(modalPadXSlider, modalPadXValue, 'uiModalPadX', '--modal-padding-x', 'rem');
// --- DELETED Margin Listeners ---


uiResetBtn.addEventListener('click', () => {
// List of all settings [slider, storageKey, cssVar, defaultValue, unit, unitless]
const allSettings = [
[globalScaleSlider, 'uiScale', 'font-size', 100, '%', false],
[layoutGapSlider, 'uiGap', '--main-gap', 3, 'rem', false], // New Default
[lineHeightSlider, 'uiLineHeight', '--global-line-height', 1.6, '', true], // NEW
[verticalSpacingSlider, 'uiSpacing', '--timeline-v-spacing', 2, 'rem', false],
[yearHeaderFsSlider, 'uiYearHeaderFs', '--timeline-year-fs', 2.25, 'rem', false],
[monthCardFsSlider, 'uiMonthCardFs', '--timeline-card-fs', 1, 'rem', false],
[sidebarTitleFsSlider, 'uiSidebarTitleFs', '--sidebar-title-fs', 3.75, 'rem', false], // 200% default
[sidebarBodyFsSlider, 'uiSidebarBodyFs', '--sidebar-body-fs', 2, 'rem', false], // 200% default
[modalTitleFsSlider, 'uiModalTitleFs', '--modal-title-fs', 1.875, 'rem', false],
[modalBodyFsSlider, 'uiModalBodyFs', '--modal-body-fs', 1, 'rem', false],
// --- NEW Padding/Margin Resets ---
[monthCardPadYSlider, 'uiCardPadY', '--card-padding-y', 1.5, 'rem', false],
[monthCardPadXSlider, 'uiCardPadX', '--card-padding-x', 1.5, 'rem', false],
[sidebarPadYSlider, 'uiSidebarPadY', '--sidebar-padding-y', 1.5, 'rem', false],
[sidebarPadXSlider, 'uiSidebarPadX', '--sidebar-padding-x', 1.5, 'rem', false],
[modalPadYSlider, 'uiModalPadY', '--modal-padding-y', 2, 'rem', false],
[modalPadXSlider, 'uiModalPadX', '--modal-padding-x', 2, 'rem', false],
// --- DELETED Margin Resets ---
];

allSettings.forEach(([slider, key, cssVar, value, unit, unitless]) => {
localStorage.removeItem(key);
const displayValue = unitless ? value : `${value}${unit}`;
document.documentElement.style.setProperty(cssVar, displayValue);
slider.value = value;
// Find the corresponding value display element
const valueDisplay = document.getElementById(slider.id.replace('Slider', 'Value'));
if (valueDisplay) valueDisplay.textContent = displayValue;
// DELETED Special case for sidebar margins
});
});

// --- NEW Analysis Modal Listeners ---
manageAnalysisBtn.addEventListener('click', () => {
if (!activeTimelineId) return; // NEW Guard
updateAnalysisModal(analysisYearSelect.value); // Ensure it's up to date
analysisModal.showModal();
// NEW: Reset image preview on open
analysisFigurePreview.src = 'https://placehold.co/100x100?text=Preview';
});
analysisModalClose.addEventListener('click', () => analysisModal.close());
analysisYearSelect.addEventListener('change', (e) => {
updateAnalysisModal(e.target.value);
});
analysisSaveSummaryBtn.addEventListener('click', handleSaveSummary);
analysisFigureForm.addEventListener('submit', (e) => {
e.preventDefault();
handleSaveFigure();
});
// NEW: Image preview listener
analysisFigureImageUrl.addEventListener('input', () => {
const url = analysisFigureImageUrl.value.trim();
analysisFigurePreview.src = url || 'https://placehold.co/100x100?text=Preview';
});
analysisFiguresList.addEventListener('click', (e) => {
if (e.target.classList.contains('btn-delete-figure-modal')) {
const id = e.target.dataset.id;
handleDeleteFigure(id);
}
});

// --- NEW: Timeline Range Modal Listeners ---
createTimelineBtn.addEventListener('click', () => {
// MODIFIED: Clear form, don't pre-fill
timelineRangeForm.reset(); 
timelineRangeModal.showModal();
});
timelineRangeCancel.addEventListener('click', () => timelineRangeModal.close());
timelineRangeForm.addEventListener('submit', (e) => {
e.preventDefault();
handleSaveNewTimeline(); // MODIFIED function name
});

// --- NEW: Manage Timelines Modal Listeners ---
manageTimelinesBtn.addEventListener('click', () => {
manageTimelinesModal.showModal();
});
manageTimelinesClose.addEventListener('click', () => {
manageTimelinesModal.close();
});
manageTimelinesList.addEventListener('click', (e) => {
const target = e.target;
if (target.classList.contains('btn-activate-timeline')) {
const timelineId = target.dataset.id;
const timelineData = allTimelines.find(t => t.id === timelineId);
if (timelineData) {
activateTimeline(timelineId, timelineData);
manageTimelinesModal.close();
}
} else if (target.classList.contains('btn-delete-timeline')) {
const timelineId = target.dataset.id;
const timelineData = allTimelines.find(t => t.id === timelineId);
if (timelineData) {
// Simple confirm, replace with better modal later if needed
if (confirm(`Are you sure you want to delete "${timelineData.name}"? This cannot be undone.`)) {
handleDeleteTimeline(timelineId);
}
}
}
});
}

/**
         * NEW: Loads and applies UI settings from localStorage
         */
function loadUiSettings() {
// List of all settings [slider, storageKey, cssVar, defaultValue, unit, unitless]
const allSettings = [
[globalScaleSlider, 'uiScale', 'font-size', 100, '%', false],
[layoutGapSlider, 'uiGap', '--main-gap', 3, 'rem', false], // New Default
[lineHeightSlider, 'uiLineHeight', '--global-line-height', 1.6, '', true], // NEW
[verticalSpacingSlider, 'uiSpacing', '--timeline-v-spacing', 2, 'rem', false],
[yearHeaderFsSlider, 'uiYearHeaderFs', '--timeline-year-fs', 2.25, 'rem', false],
[monthCardFsSlider, 'uiMonthCardFs', '--timeline-card-fs', 1, 'rem', false],
[sidebarTitleFsSlider, 'uiSidebarTitleFs', '--sidebar-title-fs', 3.75, 'rem', false], // 200% default
[sidebarBodyFsSlider, 'uiSidebarBodyFs', '--sidebar-body-fs', 2, 'rem', false], // 200% default
[modalTitleFsSlider, 'uiModalTitleFs', '--modal-title-fs', 1.875, 'rem', false],
[modalBodyFsSlider, 'uiModalBodyFs', '--modal-body-fs', 1, 'rem', false],
// --- NEW Padding/Margin Loads ---
[monthCardPadYSlider, 'uiCardPadY', '--card-padding-y', 1.5, 'rem', false],
[monthCardPadXSlider, 'uiCardPadX', '--card-padding-x', 1.5, 'rem', false],
[sidebarPadYSlider, 'uiSidebarPadY', '--sidebar-padding-y', 1.5, 'rem', false],
[sidebarPadXSlider, 'uiSidebarPadX', '--sidebar-padding-x', 1.5, 'rem', false],
[modalPadYSlider, 'uiModalPadY', '--modal-padding-y', 2, 'rem', false],
[modalPadXSlider, 'uiModalPadX', '--modal-padding-x', 2, 'rem', false],
// --- DELETED Margin Loads ---
];

allSettings.forEach(([slider, key, cssVar, defaultValue, unit, unitless]) => {
if (!slider) return; // Guard against missing elements
const savedValue = localStorage.getItem(key) || defaultValue;
const displayValue = unitless ? savedValue : `${savedValue}${unit}`;

document.documentElement.style.setProperty(cssVar, displayValue);
slider.value = savedValue;
// Find the corresponding value display element
const valueDisplay = document.getElementById(slider.id.replace('Slider', 'Value'));
if (valueDisplay) valueDisplay.textContent = displayValue;

// DELETED Special case for sidebar margins on load
});
}

/**
         * Sets up the IntersectionObserver to watch year headers.
         */
function observeYearHeaders(stickyTopPx = 180) { // NEW: Accepts dynamic top value
if (yearObserver) yearObserver.disconnect(); // Disconnect old observer

// NEW: Observe the year-block itself, not an anchor
// Trigger when the top of the block hits the sticky line
const observerOptions = {
root: null, // viewport
rootMargin: `-${stickyTopPx}px 0px -${window.innerHeight - stickyTopPx - 1}px 0px`,
threshold: 0
};

// UPDATED: Robust observer logic for scrolling up and down
yearObserver = new IntersectionObserver((entries) => {

// The `entries` array is chronological. We only care about the most recent change.
const latestEntry = entries[entries.length - 1];
if (!latestEntry) return;

if (latestEntry.isIntersecting) {
// This entry just *entered* the 1px line. This is our new active year.
// This happens when scrolling DOWN (e.g., 1948 enters)
// OR when scrolling UP (e.g., 1947 enters)
const year = latestEntry.target.dataset.year;
if (year && year !== currentActiveYear) {
currentActiveYear = year;
updateSidebarContent(year);
}
} else if (!latestEntry.isIntersecting && latestEntry.boundingClientRect.top < stickyTopPx) {
// This entry just *left* the 1px line, moving *upwards*.
// This means we are scrolling UP. The active year should be the one *before* this.
const yearThatLeft = parseInt(latestEntry.target.dataset.year);
if (yearThatLeft > START_YEAR) {
const yearToActivate = (yearThatLeft - 1).toString();
if (yearToActivate !== currentActiveYear) {
currentActiveYear = yearToActivate;
updateSidebarContent(yearToActivate);
}
}
}
// We don't need an `else` for `isIntersecting: false` and `boundingClientRect.top > stickyTopPx`
// because that's "scrolling down", and the *next* block's `isIntersecting: true`
// event will handle the update.

}, observerOptions);

// NEW: Observe the .year-block elements
document.querySelectorAll('.year-block').forEach(block => {
yearObserver.observe(block);
});
}


// --- MODAL/FORM HANDLER FUNCTIONS ---

/**
         * NEW: Handles saving a new timeline.
         */
async function handleSaveNewTimeline() {
if (!timelinesRef) return; // Guard

const timelineName = timelineNameInput.value.trim();
const newStart = parseInt(startYearInput.value);
const newEnd = parseInt(endYearInput.value);

if (!timelineName) {
console.error("Timeline name is required.");
timelineNameInput.focus();
return;
}
if (isNaN(newStart) || isNaN(newEnd) || newStart > newEnd) {
console.error("Invalid year range.");
startYearInput.focus();
return;
}

const timelineData = {
name: timelineName,
startYear: newStart,
endYear: newEnd
};

try {
const newTimelineDocRef = await addDoc(timelinesRef, timelineData);
// `listenForTimelinesList` will see this new doc and automatically
// activate it (since it will be the only one without a stored active ID,
// or if it's the first, it will be selected).
// To be more explicit, we can just activate it directly.
activateTimeline(newTimelineDocRef.id, timelineData);

timelineRangeModal.close();
timelineRangeForm.reset();
} catch (error) {
console.error("Error creating new timeline:", error);
}
}

/**
         * Creates a new blank note entry field in the modal.
         */
function createNoteEntry(note = { note: '', day: '', tag: '' }) {
const entryDiv = document.createElement('div');
entryDiv.className = 'note-entry-group p-4 border rounded-md bg-white shadow-sm';
entryDiv.innerHTML = `
               <textarea class="note-text-input w-full p-3 text-base border border-gray-300 rounded-md" rows="2" placeholder="Enter note...">${escapeHTML(note.note)}</textarea>
               <div class="flex items-center space-x-2 mt-2">
                   <select class="note-day-input p-3 text-base border border-gray-300 rounded-md">
                       ${DAY_OPTIONS_HTML}
                   </select>
                   <input type="text" class="note-tag-input w-full p-3 text-base border border-gray-300 rounded-md" placeholder="Tag (optional)" value="${escapeHTML(note.tag)}">
                   <button type="button" class="btn-remove-note px-3 py-2 bg-red-100 text-red-700 text-sm font-medium rounded-md hover:bg-red-200">
                       Remove
                   </button>
               </div>
           `;
// Set the selected day
entryDiv.querySelector('.note-day-input').value = note.day;
notesContainer.appendChild(entryDiv);
}

/**
         * Opens the modal to add a new note.
         */
function openModalForAdd(year, month) {
modalTitle.textContent = "Add Information";
modalSubTitle.textContent = `Year ${year}, ${month}`;
modalYear.value = year;
modalMonth.value = month;
modalDocId.value = "";

notesContainer.innerHTML = '';
createNoteEntry(); 

modalEventType.value = "single";
modalEventTitle.value = "";
modalEventColor.value = "#3b82f6";
colorPreview.style.backgroundColor = "#3b82f6";
modalDurationFields.classList.add('hidden');
colorPreview.style.display = 'none';

modal.showModal();
}

/**
         * Opens the modal to edit an existing note.
         */
async function openModalForEdit(year, month, docId) {
if (!docId || !timelineEventsRef) return;

const docRef = doc(timelineEventsRef, docId);
try {
const docSnap = await getDoc(docRef);
if (docSnap.exists()) {
const data = docSnap.data();

modalTitle.textContent = "Edit Information";
modalSubTitle.textContent = `Year ${year}, ${month}`;
modalYear.value = year;
modalMonth.value = month;
modalDocId.value = docId;

notesContainer.innerHTML = ''; 
const info = data.info || [];

if (Array.isArray(info) && info.length > 0) {
info.forEach(noteData => {
if (typeof noteData === 'string') {
createNoteEntry({ note: noteData, day: '', tag: '' });
} else {
createNoteEntry(noteData);
}
});
} else {
createNoteEntry();
}

modalEventType.value = data.eventType || "single";
modalEventTitle.value = data.eventTitle || "";
modalEventColor.value = data.eventColor || "#3b82f6";

const type = modalEventType.value;
modalDurationFields.classList.toggle('hidden', type === 'single');
modalEventColorWrapper.classList.toggle('hidden', type !== 'start');
colorPreview.style.display = (type === 'start') ? 'inline-block' : 'none';

modal.showModal();
} else {
console.error("No such document to edit!");
}
} catch (error) {
console.error("Error fetching document for edit:", error);
}
}

/**
         * Opens the modal to add a new key figure.
         */
function handleAddFigure() {
// This function is now deprecated, as the form is in the Analysis modal.
// Kept here in case any old references exist, but it should not be called.
console.warn("handleAddFigure() called, but this UI is deprecated.");
}

// --- DATABASE SAVE/DELETE FUNCTIONS ---

/**
         * Handles saving a new context era.
         */
async function handleSaveContext() {
if (!contextEventsRef) return;

const dataToSave = {
role: contextRole.value.trim(),
name: contextName.value.trim(),
startYear: parseInt(contextStartYear.value),
startMonth: contextStartMonth.value,
startDay: parseInt(contextStartDay.value),
endYear: parseInt(contextEndYear.value),
endMonth: contextEndMonth.value,
endDay: parseInt(contextEndDay.value),
color: contextColor.value
};

if (!dataToSave.role || !dataToSave.name) return;

const startMonthIndex = MONTHS.indexOf(dataToSave.startMonth);
const endMonthIndex = MONTHS.indexOf(dataToSave.endMonth);

if (dataToSave.startYear > dataToSave.endYear || 
(dataToSave.startYear === dataToSave.endYear && startMonthIndex > endMonthIndex) ||
(dataToSave.startYear === dataToSave.endYear && startMonthIndex === endMonthIndex && dataToSave.startDay > dataToSave.endDay)) {
console.error("Start date must be before end date.");
return;
}

try {
await addDoc(contextEventsRef, dataToSave);
contextForm.reset();
populateContextDateDropdowns(); // Reset dropdowns to default
} catch (error) {
console.error("Error saving context:", error);
}
}

/**
         * Handles deleting a context era.
         */
async function handleDeleteContext(docId) {
if (!docId || !contextEventsRef) return;
try {
await deleteDoc(doc(contextEventsRef, docId));
} catch (error) {
console.error("Error deleting context:", error);
}
}

/**
         * NEW: Handles deleting a timeline.
         * Note: This only deletes the main timeline doc, not all subcollections.
         * For a full cascade delete, a Firebase Function would be required.
         */
async function handleDeleteTimeline(timelineId) {
if (!timelineId || !timelinesRef) return;
try {
await deleteDoc(doc(timelinesRef, timelineId));
// The onSnapshot listener for the timelines list will automatically
// trigger and handle re-activating a different timeline or
// showing the "no timelines" state.
} catch (error) {
console.error("Error deleting timeline:", error);
}
}


/**
         * Handles saving data (either new or updated).
         */
async function handleSave() {
if (!timelineEventsRef) return;

const year = modalYear.value;
const month = modalMonth.value;
const docId = modalDocId.value;
const eventType = modalEventType.value;
const eventTitle = modalEventTitle.value.trim();
const eventColor = modalEventColor.value;

const notesData = [];
const noteEntryElements = notesContainer.querySelectorAll('.note-entry-group');

noteEntryElements.forEach(entry => {
const noteText = entry.querySelector('.note-text-input').value.trim();
const day = entry.querySelector('.note-day-input').value;
const tag = entry.querySelector('.note-tag-input').value.trim();

if (noteText) { // Only save notes that have text
notesData.push({ note: noteText, day: day, tag: tag });
}
});

if (notesData.length === 0 && eventType === 'single') {
console.log("No notes to save.");
}

const dataToSave = {
year: parseInt(year),
month: month,
info: notesData, // Save the array of note objects
eventType: eventType
};

if (eventType === 'start' || eventType === 'end') {
if (!eventTitle) {
modalEventTitle.classList.add('border-red-500');
setTimeout(() => modalEventTitle.classList.remove('border-red-500'), 2000);
return;
}
dataToSave.eventTitle = eventTitle;
if (eventType === 'start') {
dataToSave.eventColor = eventColor;
}
}

try {
if (docId) {
await updateDoc(doc(timelineEventsRef, docId), dataToSave);
} else {
await addDoc(timelineEventsRef, dataToSave);
}
modal.close();
} catch (error) {
console.error("Error saving document:", error);
}
}

/**
         * Handles deleting a note.
         */
async function handleDelete(docId) {
if (!docId || !timelineEventsRef) return;
try {
await deleteDoc(doc(timelineEventsRef, docId));
} catch (error) {
console.error("Error deleting document:", error);
}
}

/**
         * Saves the summary text for the current active year.
         */
async function handleSaveSummary() {
// MODIFIED: Reads from the new analysis modal
const yearToSave = analysisYearSelect.value;
if (!summariesRef || !yearToSave) return;

const summaryText = analysisSummaryTextarea.value;
const docRef = doc(summariesRef, yearToSave); // Use selected year as doc ID
try {
await setDoc(docRef, { summaryText: summaryText });
// Visual feedback
analysisSaveSummaryBtn.textContent = 'Saved!';
analysisSaveSummaryBtn.classList.add('bg-green-500');
setTimeout(() => {
analysisSaveSummaryBtn.textContent = 'Save Summary';
analysisSaveSummaryBtn.classList.remove('bg-green-500');
}, 2000);
} catch (e) { 
console.error("Error saving summary: ", e); 
analysisSaveSummaryBtn.textContent = 'Error!';
analysisSaveSummaryBtn.classList.add('bg-red-500');
setTimeout(() => {
analysisSaveSummaryBtn.textContent = 'Save Summary';
analysisSaveSummaryBtn.classList.remove('bg-red-500');
}, 2000);
}
}

/**
         * Saves a new key figure from the modal.
         */
async function handleSaveFigure() {
// MODIFIED: Reads from the new analysis modal form
if (!keyFiguresRef) return;

const dataToSave = {
year: parseInt(analysisYearSelect.value), // Get year from the modal's select
name: analysisFigureName.value.trim(),
imageUrl: analysisFigureImageUrl.value.trim(),
description: analysisFigureDescription.value.trim()
};

if (!dataToSave.name || !dataToSave.imageUrl || !dataToSave.description) {
console.error("All figure fields are required.");
return;
}

try {
await addDoc(keyFiguresRef, dataToSave);
analysisFigureForm.reset(); // Reset the form in the modal
analysisFigurePreview.src = 'https://placehold.co/100x100?text=Preview'; // NEW: Reset preview
} catch (error) {
console.error("Error saving figure:", error);
}
}

/**
         * Deletes a key figure.
         */
async function handleDeleteFigure(docId) {
if (!docId || !keyFiguresRef) return;
try {
await deleteDoc(doc(keyFiguresRef, docId));
} catch (error) {
console.error("Error deleting figure:", error);
}
}

// --- FILTERING & VISIBILITY ---

/**
         * Applies the tag filter to all notes on the timeline.
         */
function applyTagFilter() {
const filterText = tagFilterInput.value.toLowerCase().trim();

if (!filterText) {
document.querySelectorAll('.month-item').forEach(item => {
item.classList.remove('filtered-out');
});
document.querySelectorAll('.month-note-item').forEach(note => {
note.classList.remove('filtered-out');
});

updateYearBlockVisibility(document.getElementById('compactToggle').checked);
return; 
}

document.querySelectorAll('.month-item').forEach(monthItem => {
let monthHasVisibleNote = false;
const noteItems = monthItem.querySelectorAll('.month-note-item');

noteItems.forEach(noteItem => {
const tag = noteItem.dataset.tag || '';
if (tag.includes(filterText)) { 
noteItem.classList.remove('filtered-out');
monthHasVisibleNote = true;
} else {
noteItem.classList.add('filtered-out');
}
});

const hasDurationInfo = monthItem.querySelector('.bg-blue-100, .bg-red-100');

if (monthHasVisibleNote || (hasDurationInfo && !filterText)) {
monthItem.classList.remove('filtered-out');
} else {
monthItem.classList.add('filtered-out');
}
});

updateYearBlockVisibility(document.getElementById('compactToggle').checked);
}

/**
         * Hides or shows year blocks based on whether they have populated months.
         */
function updateYearBlockVisibility(isCompactView) {
const yearBlocks = document.querySelectorAll('.year-block');

yearBlocks.forEach(yearBlock => {
let hasVisibleData = false;
let nextElement = yearBlock.nextElementSibling;

while (nextElement && !nextElement.classList.contains('year-block')) {
if (nextElement.classList.contains('month-item')) {
const hasData = nextElement.classList.contains('has-data');
const isFiltered = nextElement.classList.contains('filtered-out');

if (hasData && !isFiltered) {
hasVisibleData = true;
break; 
}
}
nextElement = nextElement.nextElementSibling;
}

if (isCompactView && !hasVisibleData) {
yearBlock.classList.add('is-empty');
} else {
yearBlock.classList.remove('is-empty');
}
});
}

/**
         * Utility to escape HTML for safe rendering.
         */
function escapeHTML(str) {
if (typeof str !== 'string') return '';
return str.replace(/[&<>"']/g, function(m) {
return {
'&': '&amp;',
'<': '&lt;',
'>': '&gt;',
'"': '&quot;',
"'": '&#039;'
}[m];
});
}

</script>

<div id="navigation-fab-container" class="fixed bottom-6 right-6 z-[100] space-y-3 flex flex-col items-end">

    <div id="year-jump-container" class="p-3 bg-white rounded-lg shadow-lg border border-gray-300" style="display: none;">
        <label for="year-jump-select" class="block text-sm font-medium text-gray-700">Go to Year:</label>
        <div class="flex items-center space-x-2 mt-1">
            <select id="year-jump-select" class="p-2 text-base border border-gray-300 rounded-md" style="min-width: 100px;">
                </select>
            <button id="year-jump-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md hover:bg-blue-700">
                Go
            </button>
        </div>
    </div>

    <button id="scroll-to-bottom-btn" class="w-14 h-14 bg-gray-700 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-gray-800 transition-colors" style="display: none;" title="Go to Bottom">
        <svg xmlns="http://www.w.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
        </svg>
    </button>

    <button id="scroll-to-top-btn" class="w-14 h-14 bg-emerald-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-emerald-700 transition-colors" style="display: none;" title="Go to Top">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
    </button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Get button elements
    const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
    const scrollToBottomBtn = document.getElementById('scroll-to-bottom-btn');
    const yearJumpContainer = document.getElementById('year-jump-container');
    const yearJumpSelect = document.getElementById('year-jump-select');
    const yearJumpBtn = document.getElementById('year-jump-btn');
    let timelineObserver = null; // To observe timeline changes

    // 1. Show/Hide "To Top" and "To Bottom" buttons on scroll
    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            scrollToTopBtn.style.display = 'flex';
            scrollToBottomBtn.style.display = 'flex';
        } else {
            scrollToTopBtn.style.display = 'none';
            scrollToBottomBtn.style.display = 'none';
        }
    });

    // 2. Add click listeners for "To Top" and "To Bottom"
    scrollToTopBtn.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    scrollToBottomBtn.addEventListener('click', () => {
        window.scrollTo({
            top: document.body.scrollHeight,
            behavior: 'smooth'
        });
    });

    // 3. Add click listener for "Go to Year"
    yearJumpBtn.addEventListener('click', () => {
        const selectedYear = yearJumpSelect.value;
        if (!selectedYear) return;

        const yearElement = document.querySelector(`.year-block[data-year="${selectedYear}"]`);
        const headerElement = document.querySelector('header');

        if (yearElement) {
            const headerHeight = headerElement ? headerElement.offsetHeight : 0;
            
            // Set scroll-padding-top on the root element to offset for the sticky header
            document.documentElement.style.scrollPaddingTop = `${headerHeight + 20}px`; // 20px padding
            
            // Use scrollIntoView which respects scroll-padding-top
            yearElement.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });

    // 4. Function to populate the year dropdown
    function populateYearJumpDropdown() {
        // Clear existing options
        yearJumpSelect.innerHTML = '<option value="">Select Year</option>';

        // Find all year blocks rendered by your main script
        const yearBlocks = document.querySelectorAll('.year-block');
        
        if (yearBlocks.length > 0) {
            yearBlocks.forEach(block => {
                const year = block.dataset.year;
                if (year) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearJumpSelect.appendChild(option);
                }
            });
            // Show the year jump container
            yearJumpContainer.style.display = 'block';
        } else {
            // Hide if no years found (e.g., no active timeline)
            yearJumpContainer.style.display = 'none';
        }
    }

    // 5. Use MutationObserver to populate dropdown when app is loaded
    // We watch the login overlay. When it gets "display: none", the app is visible.
    const loginOverlay = document.getElementById('login-overlay');

    if (loginOverlay) {
        const appLoadObserver = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    // Check if login overlay is hidden
                    if (loginOverlay.style.display === 'none') {
                        // App is visible, populate dropdown
                        populateYearJumpDropdown();
                        
                        // Now that the app is loaded, start observing the timeline
                        // for changes (e.g., user loads a *new* timeline)
                        observeTimelineChanges();

                        // We're done observing the login screen
                        appLoadObserver.disconnect();
                    }
                }
            }
        });

        // Start observing the login overlay for style changes
        appLoadObserver.observe(loginOverlay, {
            attributes: true
        });
    }

    // 6. Observe the timeline container for changes
    // This will re-populate the dropdown if the user activates a new timeline
    function observeTimelineChanges() {
        if (timelineObserver) {
             timelineObserver.disconnect(); // Disconnect any old observer
        }

        const timelineContainer = document.getElementById('timeline-container');
        if (timelineContainer) {
            timelineObserver = new MutationObserver(() => {
                // Timeline content changed, re-populate the dropdown
                populateYearJumpDropdown();
            });
            
            // Watch for changes to the children of the timeline (e.g., new year-blocks)
            timelineObserver.observe(timelineContainer, {
                childList: true 
            });
        }
    }
});
</script>

</body>
</html>
